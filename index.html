<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WebCloud IDE & CLI ‚Äî Node + C (CDN auto)</title>
<style>
/* --- Theme Variables --- */
:root {
  --bg: #0b0f14; --panel: #121927; --panel2: #0f1520;
  --txt: #e6edf3; --sub: #a8b3bf; --acc: #00d4ff;
  --ok: #6ee7b7; --warn: #fbbf24; --err: #f87171;
  --border: #1c2735; --muted: #202b3a;
  --btn-hover-bg: #223349;
  --danger-bg: #36161a; --danger-border: #5b1c23;
  --prompt: #86efac;
  --badge-txt: #031018;
}
body.light-theme {
  --bg: #ffffff; --panel: #f0f2f5; --panel2: #e8ecf0;
  --txt: #1f2328; --sub: #57606a; --acc: #0969da;
  --ok: #1a7f37; --warn: #9a6700; --err: #d1242f;
  --border: #d0d7de; --muted: #f6f8fa;
  --btn-hover-bg: #eef0f2;
  --danger-bg: #fbeceb; --danger-border: #d1242f;
  --prompt: #1a7f37;
  --badge-txt: #ffffff;
}

/* --- Base Styles --- */
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--txt);font-family:ui-monospace,Menlo,Consolas,monospace}
.layout{display:grid;grid-template-rows:48px 1fr;height:100%}
header{display:flex;align-items:center;justify-content:space-between;padding:0 12px;background:linear-gradient(180deg,var(--panel),var(--panel2));border-bottom:1px solid var(--border)}
.brand{display:flex;align-items:center;gap:10px}
.badge{padding:2px 8px;border-radius:999px;font-size:12px;background:linear-gradient(90deg,#00d4ff,#8b5cf6);color:var(--badge-txt);font-weight:700}
.controls{display:flex;gap:8px;align-items:center}
button{background:var(--muted);color:var(--txt);border:1px solid var(--border);padding:8px 10px;border-radius:12px;cursor:pointer;font-weight:600}
button:hover{background:var(--btn-hover-bg)}.pill{border-radius:999px}
.main{display:grid;grid-template-columns:240px 1fr 1fr;height:calc(100vh - 48px)}
.col{border-right:1px solid var(--border);overflow:hidden; display: flex; flex-direction: column;}.col:last-child{border-right:none}
.panel{height:100%;display:flex;flex-direction:column}
.titlebar{height:36px;display:flex;align-items:center;gap:8px;padding:0 10px;border-bottom:1px solid var(--border);background:var(--panel)}
.title{font-weight:700;color:var(--sub)}
.terminal{flex:1;background:var(--bg);padding:10px;overflow:auto}.term-line{white-space:pre-wrap;margin:0}.prompt{color:var(--prompt)}
.inputbar{border-top:1px solid var(--border);display:flex;gap:8px;padding:8px;background:var(--panel)}
.inputbar input{flex:1;background:var(--muted);border:1px solid var(--border);color:var(--txt);padding:10px;border-radius:10px}
.split{display:grid;grid-template-rows:1fr 42%;height:100%}
#editor{height:100%;width:100%;background:var(--bg)}
.tabs{display:flex;gap:8px;padding:8px;border-bottom:1px solid var(--border);background:var(--panel2)}
.tab{display:flex;align-items:center;justify-content:space-between;padding:6px 10px;border-radius:10px;cursor:pointer;background:var(--panel);border:1px solid var(--border);color:var(--sub)}
.tab.active{background:var(--bg);color:var(--txt)}
.tab .close-btn { margin-left: 8px; padding: 0 4px; border-radius: 4px; cursor: pointer; font-weight: bold; }
.tab .close-btn:hover { background: var(--danger-bg); color: var(--err); }
.subpanel{border-top:1px solid var(--border);background:var(--muted);display:grid;grid-template-columns:55% 45%}
.subcol{display:flex;flex-direction:column;border-right:1px solid var(--border);overflow:hidden}.subcol:last-child{border-right:none}
.toolbar{padding:6px 8px;display:flex;gap:8px;border-bottom:1px solid var(--border);background:var(--panel2)}
.small{font-size:12px}.hint{color:var(--sub);font-size:12px}
#preview, .log {flex:1;border:0;background:var(--bg);padding:10px;overflow:auto}
#git-status-container { background: var(--bg); border: 1px solid var(--border) !important; border-radius: 4px; padding: 5px; flex: 1; overflow-y: auto; }
.right{margin-left:auto}
.modal-backdrop{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.5)}
.modal{width:min(820px,96vw);background:var(--panel);border:1px solid var(--border);border-radius:16px;overflow:hidden}
.modal header{padding:10px 12px; background: var(--panel2)}
.modal .body{padding:12px;display:grid;gap:10px}
.field{display:grid;gap:6px}.field label{font-size:12px;color:var(--sub)}
.field input,.field textarea{background:var(--muted);border:1px solid var(--border);color:var(--txt);padding:10px;border-radius:10px;width:100%}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.danger{background:var(--danger-bg);border-color:var(--danger-border);color:var(--txt)}

/* --- AI Panel Styles --- */
.ai-panel {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 450px;
  height: 600px;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 16px;
  display: none; /* Initially hidden */
  flex-direction: column;
  z-index: 1000;
  box-shadow: 0 10px 25px rgba(0,0,0,0.3);
  resize: both;
  overflow: hidden;
  min-width: 300px;
  min-height: 400px;
}
.ai-panel-header {
  padding: 10px 12px;
  background: var(--panel2);
  cursor: move;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: bold;
}
.ai-panel-body {
  flex: 1;
  padding: 12px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.ai-panel-footer {
  padding: 10px;
  border-top: 1px solid var(--border);
}
.ai-panel-footer textarea {
  width: 100%;
  background: var(--muted);
  border: 1px solid var(--border);
  color: var(--txt);
  padding: 10px;
  border-radius: 10px;
  resize: vertical;
}
.ai-chat-bubble {
  padding: 8px 12px;
  border-radius: 12px;
  max-width: 85%;
}
.ai-chat-bubble.user {
  background: var(--acc);
  color: var(--badge-txt);
  align-self: flex-end;
  border-bottom-right-radius: 2px;
}
.ai-chat-bubble.bot {
  background: var(--muted);
  align-self: flex-start;
  border-bottom-left-radius: 2px;
  white-space: pre-wrap;
}
#ai-model-selector-panel {
  background: var(--muted);
  border: 1px solid var(--border);
  color: var(--txt);
  border-radius: 6px;
  padding: 2px;
}
</style>

<!-- Monaco Editor „É≠„Éº„ÉÄ„Éº -->
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/v86/build/libv86.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/treejs/dist/treejs.css" />
<script src="https://cdn.jsdelivr.net/npm/treejs/dist/tree.min.js"></script>
<script src="https://unpkg.com/@isomorphic-git/lightning-fs"></script>
<script src="https://unpkg.com/isomorphic-git"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css" />
<script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>
<script type="module" src="https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.2.46/lib/index.js"></script>
<script type="module">
  // The library doesn't have a UMD build, so we import it as a module
  // and attach it to the window object to make it globally accessible like the other libraries.
  import { OAuth2AuthCodePkceClient } from 'https://esm.sh/oauth2-pkce';
  window.OAuth2AuthCodePkceClient = OAuth2AuthCodePkceClient;
</script>
<script type="module">
  // Import Y.js and its bindings and attach them to the window object
  import * as Y from 'https://cdn.jsdelivr.net/npm/yjs/+esm';
  import { WebsocketProvider } from 'https://cdn.jsdelivr.net/npm/y-websocket/+esm';
  import { MonacoBinding } from 'https://cdn.jsdelivr.net/npm/y-monaco/+esm';
  window.Y = Y;
  window.WebsocketProvider = WebsocketProvider;
  window.MonacoBinding = MonacoBinding;
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
<div class="layout">
  <header>
    <div class="brand">
      <span class="badge">WebCloud</span>
      <div>IDE & CLI</div>
      <div class="status" id="status-node">Node: <span class="warn">Ëµ∑Âãï‰∏≠‚Ä¶</span></div>
      <div class="status" id="status-db">„Çπ„Éà„É¨„Éº„Ç∏: <span class="ok">IndexedDB</span></div>
    </div>
    <div class="controls">
      <div id="github-auth-container">
        <button id="btn-github-login" class="pill">Login with GitHub</button>
        <span id="github-user" style="display: none;"></span>
        <button id="btn-github-logout" class="pill" style="display: none;">Logout</button>
      </div>
      <button id="btn-settings" class="pill">‚öô Ë®≠ÂÆö</button>
      <button id="btn-vm" class="pill">üêß VMËµ∑Âãï</button>
      <button id="btn-github-clone" class="pill">Clone</button>
      <button id="btn-github-new" class="pill">New Repo</button>
      <button id="btn-workspaces" class="pill">üóÇÔ∏è Workspaces</button>
      <button id="btn-new-project" class="pill">‚ú® New Project</button>
      <button id="btn-collaboration" class="pill">ü§ù ÂÖ±Êúâ</button>
      <button id="btn-upload" class="pill">üì§ „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</button>
      <button id="btn-download" class="pill">üì• „Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
      <button id="btn-export-zip" class="pill">üì¶ „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíZIP</button>
      <button id="btn-save" class="pill">üíæ ‰øùÂ≠ò</button>
      <button id="btn-run" class="pill">‚ñ∂ ÂÆüË°å</button>
      <button id="btn-preview" class="pill">üåê „Éó„É¨„Éì„É•„Éº</button>
      <button id="btn-ai-panel" class="pill">ü§ñ AI</button>
      <button id="btn-deploy" class="pill">üöÄ Deploy</button>
    </div>
    <input type="file" id="file-upload-input" style="display: none;" />
  </header>

  <div class="main">
    <!-- Â∑¶: „Éï„Ç°„Ç§„É´„Ç®„ÇØ„Çπ„Éó„É≠„Éº„É©„Éº & Git -->
    <div class="col">
      <div style="flex: 1; overflow-y: auto;">
        <div class="titlebar"><span class="title">„Ç®„ÇØ„Çπ„Éó„É≠„Éº„É©„Éº</span></div>
        <div id="file-explorer-container" style="padding: 8px;"></div>
      </div>
      <div style="height: 220px; border-top: 1px solid var(--border); display: flex; flex-direction: column;">
        <div class="titlebar"><span class="title">„ÇΩ„Éº„ÇπÁÆ°ÁêÜ</span></div>
        <div id="git-panel" style="padding: 8px; font-size: 12px; display: flex; flex-direction: column; gap: 8px; flex: 1;">
          <textarea id="git-commit-message" placeholder="„Ç≥„Éü„ÉÉ„Éà„É°„ÉÉ„Çª„Éº„Ç∏" rows="3" style="width: 100%; background: var(--bg); color: var(--txt); border: 1px solid var(--border); border-radius: 4px; padding: 4px;"></textarea>
          <div style="display: flex; gap: 8px;">
            <button id="git-commit-button" class="pill small">„Ç≥„Éü„ÉÉ„Éà</button>
            <button id="git-push-button" class="pill small">„Éó„ÉÉ„Ç∑„É•</button>
            <button id="git-graph-refresh-btn" class="pill small">„Ç∞„É©„ÉïÊõ¥Êñ∞</button>
          </div>
          <div id="git-status-container" style="flex: 1; overflow-y: auto; background: #0a0f17; padding: 5px; border: 1px solid var(--border); border-radius: 4px;"></div>
        </div>
      </div>
    </div>

    <!-- ‰∏≠Â§Æ: CLI -->
    <div class="col panel">
      <div class="titlebar"><span class="title">„Çø„Éº„Éü„Éä„É´</span></div>
      <div class="terminal" id="terminal" style="padding: 0;"></div>
    </div>

    <!-- Âè≥: „Ç®„Éá„Ç£„Çø„Éº + „Éó„É¨„Éì„É•„Éº/„É≠„Ç∞ -->
    <div class="col split">
      <div class="panel">
        <div class="tabs" id="tabs"></div>
        <div id="editor"></div>
      </div>
      <div class="subpanel" style="grid-template-columns: 1fr 1fr 1fr;">
        <div class="subcol">
          <div class="toolbar"><strong>„Éó„É¨„Éì„É•„Éº</strong><span class="small hint">HTML/CSS/JS „É©„Ç§„Éñ„Éó„É¨„Éì„É•„Éº</span><span class="right"><button id="btn-refresh" class="pill small">‚ü≥ Êõ¥Êñ∞</button></span></div>
          <iframe id="preview"></iframe>
        </div>
        <div class="subcol">
            <div class="toolbar"><strong>Git„Ç∞„É©„Éï</strong></div>
            <div id="git-graph-container" style="flex: 1; overflow: auto; padding: 10px;"></div>
        </div>
        <div class="subcol">
          <div class="toolbar"><strong>„Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞</strong><span class="right"><button id="btn-log-clear" class="pill small">„ÇØ„É™„Ç¢</button></span></div>
          <div class="log" id="log"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Ë®≠ÂÆö -->
<div class="modal-backdrop" id="modal">
  <div class="modal">
    <header><div class="brand"><span class="badge">Ë®≠ÂÆö</span><div class="status small">„Ç´„Çπ„Çø„Éû„Ç§„Ç∫</div></div></header>
    <div class="body">
      <div class="grid2">
        <div class="field"><label>„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç</label><input id="set-project" placeholder="my-webcloud-app" /></div>
        <div class="field"><label>ÂÆüË°åÊôÇ„Å´Ëá™Âãï‰øùÂ≠ò</label><input id="set-autosave" type="checkbox" /></div>
      </div>
      <div class="field"><label>„ÉÜ„Éº„Éû</label><button id="btn-toggle-theme" class="pill">„É©„Ç§„Éà/„ÉÄ„Éº„ÇØÂàá„ÇäÊõø„Åà</button></div>
      <div class="field"><label>AI„É¢„Éá„É´</label><select id="ai-model-selector-settings"></select></div>
      <div class="field"><label>GitHub OAuth Client ID</label><input id="set-github-client-id" placeholder="Your GitHub OAuth App Client ID" /></div>
      <div class="grid2">
        <div class="field"><label>Node.js (WebContainer) API URL</label><input id="set-wc" value="https://unpkg.com/@webcontainer/api/dist/index.js" /></div>
        <div class="field"><label>Monaco CDN</label><input id="set-monaco" value="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js" /></div>
      </div>
      <div class="field">
        <label>„Éó„É©„Ç∞„Ç§„É≥„ÇíË™≠„ÅøËæº„ÇÄ (.js)</label>
        <input type="file" id="load-plugin-input" accept=".js" />
      </div>
      <div class="grid2">
        <button id="btn-save-settings" class="pill">Ë®≠ÂÆö„Çí‰øùÂ≠ò</button>
        <button id="btn-reset-all" class="pill danger">Â∑•Â†¥Âá∫Ëç∑ÊôÇ„Å´„É™„Çª„ÉÉ„Éà</button>
      </div>
    </div>
  </div>
</div>

<!-- AI Panel -->
<div class="ai-panel" id="ai-panel">
  <div class="ai-panel-header" id="ai-panel-header">
    <span>ü§ñ AI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà</span>
    <select id="ai-model-selector-panel"></select>
  </div>
  <div class="ai-panel-body" id="ai-panel-body">
    <div class="ai-chat-bubble bot">„Åì„Çì„Å´„Å°„ÅØÔºÅ‰Ωï„Åã„ÅäÊâã‰ºù„ÅÑ„Åß„Åç„Çã„Åì„Å®„ÅØ„ÅÇ„Çä„Åæ„Åô„ÅãÔºü</div>
  </div>
  <div class="ai-panel-footer">
    <textarea id="ai-prompt-input" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°..." rows="2" style="margin-bottom: 5px;"></textarea>
    <button id="ai-send-prompt-btn" class="pill small">ÈÄÅ‰ø°</button>
    <button id="ai-gen-command-btn" class="pill small">„Ç≥„Éû„É≥„ÉâÁîüÊàê</button>
  </div>
</div>

<!-- VM „É¢„Éº„ÉÄ„É´ -->
<div class="modal-backdrop" id="modal-vm">
  <style>
    #modal-vm .modal { width: min(1200px, 96vw); height: min(800px, 90vh); display: flex; flex-direction: column; }
    #modal-vm .body { flex: 1; padding: 0; background: black; }
    #screen_container { width: 100%; height: 100%; }
    #screen_container canvas { width: 100%; height: 100%; }
  </style>
  <div class="modal">
    <header>
      <div class="brand"><span class="badge">Linux VM</span><div class="status small">v86 „Ç®„Éü„É•„É¨„Éº„Çø</div></div>
      <button id="btn-vm-close" class="pill small">Èñâ„Åò„Çã</button>
    </header>
    <div class="body">
      <div id="screen_container">
        <div style="white-space: pre; font: 14px monospace; line-height: 14px"></div>
        <canvas></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Workspaces Modal -->
<div class="modal-backdrop" id="modal-workspaces">
    <div class="modal">
        <header><div class="brand"><span class="badge">„ÉØ„Éº„ÇØ„Çπ„Éö„Éº„Çπ</span><div class="status small">‰øùÂ≠ò„ÉªË™≠Ëæº</div></div></header>
        <div class="body">
            <div id="workspaces-list" style="max-height: 200px; overflow-y: auto; margin-bottom: 10px;"></div>
            <div class="field">
                <label>Êñ∞„Åó„ÅÑ„ÉØ„Éº„ÇØ„Çπ„Éö„Éº„ÇπÂêç:</label>
                <input id="new-workspace-name" placeholder="‰æã: my-react-project" />
            </div>
            <button id="btn-save-workspace" class="pill">ÁèæÂú®„ÅÆ„ÉØ„Éº„ÇØ„Çπ„Éö„Éº„Çπ„Çí‰øùÂ≠ò</button>
        </div>
    </div>
</div>

<!-- New Project Modal -->
<div class="modal-backdrop" id="modal-new-project">
    <div class="modal">
        <header><div class="brand"><span class="badge">Êñ∞Ë¶è„Éó„É≠„Ç∏„Çß„ÇØ„Éà</span><div class="status small">„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÈÅ∏Êäû</div></div></header>
        <div class="body" id="new-project-templates">
            <!-- Templates will be injected here by JS -->
        </div>
    </div>
</div>

<!-- ÂÆüË£Ö„Çπ„ÇØ„É™„Éó„Éà -->
<script>
/* ---------------------------
   IndexedDB „Éò„É´„Éë„Éº
---------------------------- */
const DB_NAME='webcloud-db', DB_VER=2;
let idb;
const openDB = ()=>new Promise((res,rej)=>{
  const r=indexedDB.open(DB_NAME, DB_VER);
  r.onupgradeneeded = e => {
    const db = e.target.result;
    if(!db.objectStoreNames.contains('kv')) db.createObjectStore('kv');
    if(!db.objectStoreNames.contains('files')) db.createObjectStore('files');
    if(!db.objectStoreNames.contains('cmds')) db.createObjectStore('cmds');
    if(!db.objectStoreNames.contains('settings')) db.createObjectStore('settings');
    if(!db.objectStoreNames.contains('workspaces')) db.createObjectStore('workspaces');
  };
  r.onsuccess = e => { idb = e.target.result; res(idb); };
  r.onerror = e => rej(e);
});
const idbGet = (store,key)=>new Promise((res,rej)=>{ const tx=idb.transaction(store,'readonly').objectStore(store).get(key); tx.onsuccess=e=>res(e.target.result); tx.onerror=rej; });
const idbSet = (store,key,val)=>new Promise((res,rej)=>{ const tx=idb.transaction(store,'readwrite').objectStore(store).put(val, key); tx.onsuccess=()=>res(); tx.onerror=rej; });
const idbDel = (store,key)=>new Promise((res,rej)=>{ const tx=idb.transaction(store,'readwrite').objectStore(store).delete(key); tx.onsuccess=()=>res(); tx.onerror=rej; });
const idbAll = (store)=>new Promise((res,rej)=>{ const st = idb.transaction(store,'readonly').objectStore(store); const rk=st.getAllKeys(), rv=st.getAll(); let keys; rk.onsuccess=e=>keys=e.target.result; rv.onsuccess=e=>res({keys, vals: e.target.result}); rk.onerror=rv.onerror=rej; });

/* ---------------------------
   „Éï„Ç°„Ç§„É´„Ç®„ÇØ„Çπ„Éó„É≠„Éº„É©„Éº
---------------------------- */
let fileTree;

function buildFileHierarchy(files) {
  const root = { name: '/', type: 'dir', children: {} };
  for (const path of files) {
    const parts = path.split('/').filter(p => p);
    let current = root;
    for (let i = 0; i < parts.length; i++) {
      const part = parts[i];
      const isLast = i === parts.length - 1;
      if (!current.children[part]) {
        current.children[part] = {
          name: part,
          type: isLast ? 'file' : 'dir',
          path: '/' + parts.slice(0, i + 1).join('/'),
          children: {},
        };
      }
      current = current.children[part];
    }
  }
  return root;
}

function createTreeNodes(node) {
  const treeNode = new TreeNode(node.name);
  treeNode.path = node.path; // „ÇØ„É™„ÉÉ„ÇØ„Éè„É≥„Éâ„É©„ÅÆ„Åü„ÇÅ„Å´„Éë„Çπ„ÇíÊ∑ª‰ªò
  if (node.type === 'dir') {
    const children = Object.values(node.children).sort((a, b) => {
      if (a.type !== b.type) return a.type === 'dir' ? -1 : 1;
      return a.name.localeCompare(b.name);
    });
    for (const child of children) {
      treeNode.addChild(createTreeNodes(child));
    }
  } else { // „Éï„Ç°„Ç§„É´„ÅÆÂ†¥Âêà
    treeNode.on('open', () => {
      openFile(treeNode.path);
    });
  }
  return treeNode;
}

async function renderFileTree() {
  const { keys } = await idbAll('files');
  if (!keys) return;

  const hierarchy = buildFileHierarchy(keys);
  const rootNode = createTreeNodes(hierarchy);

  fileTree = new TreeView(rootNode, '#file-explorer-container', { show_root: false });
}

/* ---------------------------
   Git Áµ±Âêà
---------------------------- */
async function renderGitGraph() {
    const container = document.getElementById('git-graph-container');
    container.innerHTML = 'Git„Ç∞„É©„Éï„ÇíÁîüÊàê‰∏≠...';
    try {
        const commits = await git.log({ fs, dir: '/' });
        let html = '';
        for (const commit of commits) {
            html += `<div style="font-family: monospace; white-space: pre; padding-bottom: 5px; border-bottom: 1px solid var(--border);">`;
            html += `<span style="color: var(--warn);">${commit.oid.substring(0, 7)}</span>`;
            html += ` - <span style="color: var(--ok);">${commit.commit.author.name}</span>`;
            html += ` (${new Date(commit.commit.author.timestamp * 1000).toLocaleDateString()})`;
            html += `<br>  ${commit.commit.message}`;
            html += `</div>`;
        }
        container.innerHTML = html;
    } catch (e) {
        container.innerHTML = `Git„Ç∞„É©„Éï„ÅÆÁîüÊàê„Ç®„É©„Éº: ${e.message}`;
    }
}

const git = window.isomorphicGit;
const fs = new LightningFS('fs');
const pfs = fs.promises;
const dir = '/';

async function refreshGitStatus() {
  const statusContainer = document.getElementById('git-status-container');
  statusContainer.innerHTML = 'Â§âÊõ¥„ÇíÁ¢∫Ë™ç‰∏≠...';

  try {
    const rows = await git.statusMatrix({ fs, dir });
    const changedFiles = rows.filter(row => row[1] !== row[2] || row[2] !== row[3]);

    if (changedFiles.length === 0) {
      statusContainer.innerHTML = 'Â§âÊõ¥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ';
      return;
    }

    let html = '<table>';
    for (const row of changedFiles) {
      const [filepath, , workdir] = row;
      let statusText = '';
      // workdir: 0=Â§âÊõ¥„Å™„Åó, 1=ËøΩÂä†, 2=Â§âÊõ¥, 3=ÂâäÈô§
      if (workdir === 1) statusText = 'Êñ∞Ë¶è';
      if (workdir === 2) statusText = 'Â§âÊõ¥';
      if (workdir === 3) statusText = 'ÂâäÈô§';

      html += `<tr><td style="padding-right: 10px;">${filepath}</td><td>${statusText}</td></tr>`;
    }
    html += '</table>';
    statusContainer.innerHTML = html;

  } catch (e) {
    statusContainer.innerHTML = `Git„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆÂèñÂæó„Ç®„É©„Éº: ${e.message}`;
  }
}

async function performCommit() {
  const message = document.getElementById('git-commit-message').value;
  if (!message.trim()) {
    out('„Ç≥„Éü„ÉÉ„Éà„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'err');
    return;
  }

  try {
    out('Â§âÊõ¥„Çí„Çπ„ÉÜ„Éº„Ç∏„É≥„Ç∞‰∏≠...', 'ok');
    const rows = await git.statusMatrix({ fs, dir });
    // „Åô„Åπ„Å¶„ÅÆÂ§âÊõ¥ÔºàÊñ∞Ë¶è„ÄÅÂ§âÊõ¥„ÄÅÂâäÈô§Ôºâ„Çí„Çπ„ÉÜ„Éº„Ç∏„É≥„Ç∞
    for (const row of rows) {
      const [filepath, head, workdir] = row;
      if (head !== workdir) { // Â§âÊõ¥„Åå„ÅÇ„ÇãÂ†¥Âêà
         if (workdir === 3) { // ÂâäÈô§Ê∏à„Åø
            await git.remove({ fs, dir, filepath });
         } else { // ËøΩÂä†„Åæ„Åü„ÅØÂ§âÊõ¥
            await git.add({ fs, dir, filepath });
         }
      }
    }

    out('„Ç≥„Éü„ÉÉ„Éà‰∏≠...', 'ok');
    const userId = await getOrSetUserId();
    const sha = await git.commit({
      fs,
      dir,
      message,
      author: {
        name: `user-${userId}`,
        email: `user-${userId}@web.cloud`,
      },
    });

    out(`„Ç≥„Éü„ÉÉ„ÉàÊàêÂäü: ${sha.substring(0, 7)}`, 'ok');
    document.getElementById('git-commit-message').value = '';
    await refreshGitStatus();

  } catch (e) {
    out(`„Ç≥„Éü„ÉÉ„Éà‰∏≠„ÅÆ„Ç®„É©„Éº: ${e.message}`, 'err');
    console.error(e);
  }
}

async function initGit() {
  await pfs.mkdir(dir).catch(e => {}); // Ignore if dir already exists

  // Êó¢„Å´Git„É™„Éù„Ç∏„Éà„É™„ÅãÁ¢∫Ë™ç
  const gitignoreExists = await pfs.stat(`${dir}.git/config`).catch(e => false);

  if (!gitignoreExists) {
    out("Git„É™„Éù„Ç∏„Éà„É™„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇÊñ∞Ë¶è‰ΩúÊàê„Åó„Åæ„Åô„ÄÇ", "ok");
    await git.init({ fs, dir });
    out("Êñ∞„Åó„ÅÑGit„É™„Éù„Ç∏„Éà„É™„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü„ÄÇ", "ok");
  } else {
    out("Êó¢Â≠ò„ÅÆGit„É™„Éù„Ç∏„Éà„É™„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„Åü„ÄÇ", "ok");
  }
  await refreshGitStatus();
}

/* ---------------------------
   Workspace Management
---------------------------- */
const workspaceManager = {
    async save(name) {
        if (!name.trim()) {
            alert("„ÉØ„Éº„ÇØ„Çπ„Éö„Éº„ÇπÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
            return;
        }
        out(`„ÉØ„Éº„ÇØ„Çπ„Éö„Éº„Çπ„Äå${name}„Äç„Çí‰øùÂ≠ò‰∏≠...`, 'ok');
        try {
            const files = {};
            const allPaths = await pfs.readdir('/');
            for (const path of allPaths) {
                if (path === '.' || path === '..') continue;
                // This is a simplified version, doesn't handle directories yet
                const content = await pfs.readFile(`/${path}`);
                files[`/${path}`] = content;
            }

            const workspaceState = {
                files: files,
                activeFile: currentFile,
                createdAt: new Date().toISOString()
            };
            await idbSet('workspaces', name, workspaceState);
            out(`„ÉØ„Éº„ÇØ„Çπ„Éö„Éº„Çπ„Äå${name}„Äç„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ`, 'ok');
            this.populateModal();
        } catch (e) {
            out(`„ÉØ„Éº„ÇØ„Çπ„Éö„Éº„Çπ„ÅÆ‰øùÂ≠ò„Ç®„É©„Éº: ${e.message}`, 'err');
        }
    },

    async load(name) {
        if (!confirm(`„ÉØ„Éº„ÇØ„Çπ„Éö„Éº„Çπ„Äå${name}„Äç„ÇíË™≠„ÅøËæº„Åø„Åæ„Åô„ÅãÔºüÁèæÂú®„ÅÆÂ§âÊõ¥„ÅØÂ§±„Çè„Çå„Åæ„Åô„ÄÇ`)) {
            return;
        }
        out(`„ÉØ„Éº„ÇØ„Çπ„Éö„Éº„Çπ„Äå${name}„Äç„ÇíË™≠„ÅøËæº„Åø‰∏≠...`, 'ok');
        try {
            const workspaceState = await idbGet('workspaces', name);
            if (!workspaceState) {
                throw new Error("‰øùÂ≠ò„Åï„Çå„Åü„ÉØ„Éº„ÇØ„Çπ„Éö„Éº„Çπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ");
            }

            // Wipe existing filesystem
            const allFiles = await pfs.readdir('/');
            for (const file of allFiles) {
                if (file !== '.' && file !== '..') {
                    await pfs.rm(`/${file}`, { recursive: true });
                }
            }

            // Load new files
            for (const path in workspaceState.files) {
                await pfs.writeFile(path, workspaceState.files[path]);
            }

            currentFile = workspaceState.activeFile || null;
            await refreshFileUI();
            await initGit();
            out(`„ÉØ„Éº„ÇØ„Çπ„Éö„Éº„Çπ„Äå${name}„Äç„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü„ÄÇ`, 'ok');
        } catch (e) {
            out(`„ÉØ„Éº„ÇØ„Çπ„Éö„Éº„Çπ„ÅÆË™≠„ÅøËæº„Åø„Ç®„É©„Éº: ${e.message}`, 'err');
        } finally {
            document.getElementById('modal-workspaces').style.display = 'none';
        }
    },

    async delete(name) {
        if (!confirm(`Êú¨ÂΩì„Å´„ÉØ„Éº„ÇØ„Çπ„Éö„Éº„Çπ„Äå${name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
            return;
        }
        await idbDel('workspaces', name);
        out(`„ÉØ„Éº„ÇØ„Çπ„Éö„Éº„Çπ„Äå${name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü„ÄÇ`, 'ok');
        this.populateModal();
    },

    async populateModal() {
        const { keys, vals } = await idbAll('workspaces');
        const container = document.getElementById('workspaces-list');
        container.innerHTML = '';
        if (!keys || keys.length === 0) {
            container.innerHTML = '‰øùÂ≠ò„Åï„Çå„Åü„ÉØ„Éº„ÇØ„Çπ„Éö„Éº„Çπ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ';
            return;
        }
        keys.forEach((name, i) => {
            const div = document.createElement('div');
            div.style.display = 'flex';
            div.style.justifyContent = 'space-between';
            div.style.padding = '5px';
            div.style.borderBottom = '1px solid var(--border)';

            const loadBtn = document.createElement('button');
            loadBtn.textContent = `Ë™≠Ëæº: ${name}`;
            loadBtn.className = 'pill small';
            loadBtn.onclick = () => this.load(name);

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'ÂâäÈô§';
            deleteBtn.className = 'pill small danger';
            deleteBtn.onclick = () => this.delete(name);

            div.appendChild(loadBtn);
            div.appendChild(deleteBtn);
            container.appendChild(div);
        });
    }
};


/* ---------------------------
   Project Templates & Export
---------------------------- */
async function exportProjectAsZip() {
    out('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíZIP„Å´„Ç®„ÇØ„Çπ„Éù„Éº„Éà‰∏≠...', 'ok');
    const zip = new JSZip();

    async function addFolderToZip(zipFolder, path) {
        const entries = await pfs.readdir(path);
        for (const entry of entries) {
            if (entry === '.' || entry === '..') continue;
            const fullPath = `${path === '/' ? '' : path}/${entry}`;
            const stat = await pfs.stat(fullPath);
            if (stat.isDirectory()) {
                const newFolder = zipFolder.folder(entry);
                await addFolderToZip(newFolder, fullPath);
            } else {
                const content = await pfs.readFile(fullPath);
                zipFolder.file(entry, content);
            }
        }
    }

    try {
        await addFolderToZip(zip, '/');
        const zipContent = await zip.generateAsync({ type: 'blob' });
        const projName = (await idbGet('settings', SKEYS.project)) || 'webcloud-project';

        const a = document.createElement('a');
        a.href = URL.createObjectURL(zipContent);
        a.download = `${projName}.zip`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
        out('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Ç®„ÇØ„Çπ„Éù„Éº„Éà„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ', 'ok');
    } catch (e) {
        out(`„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Ç®„É©„Éº: ${e.message}`, 'err');
        console.error(e);
    }
}


function populateTemplateModal() {
    const container = document.getElementById('new-project-templates');
    container.innerHTML = '';
    for (const templateId in PROJECT_TEMPLATES) {
        const template = PROJECT_TEMPLATES[templateId];
        const button = document.createElement('button');
        button.className = 'pill';
        button.textContent = template.name;
        button.onclick = () => loadTemplate(templateId);
        container.appendChild(button);
    }
}

async function loadTemplate(templateId) {
    if (!confirm("ÁèæÂú®„ÅÆ„ÉØ„Éº„ÇØ„Çπ„Éö„Éº„Çπ„ÇíÊ∂àÂéª„Åó„ÄÅÊñ∞„Åó„ÅÑ„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíË™≠„ÅøËæº„Åø„Åæ„Åô„ÅãÔºü‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ§âÊõ¥„ÅØÂ§±„Çè„Çå„Åæ„Åô„ÄÇ")) {
        return;
    }

    out(`„ÉÜ„É≥„Éó„É¨„Éº„Éà„Äå${PROJECT_TEMPLATES[templateId].name}„Äç„ÇíË™≠„ÅøËæº„Åø‰∏≠...`, 'ok');
    try {
        // Wipe existing filesystem
        const allFiles = await pfs.readdir('/');
        for (const file of allFiles) {
            if (file !== '.' && file !== '..') {
                await pfs.rm(`/${file}`, { recursive: true });
            }
        }

        // Load new files
        const templateFiles = PROJECT_TEMPLATES[templateId].files;
        for (const path in templateFiles) {
            await pfs.writeFile(path, templateFiles[path]);
        }

        out('„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅÆË™≠„ÅøËæº„Åø„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ', 'ok');
        currentFile = null; // Reset current file
        await refreshFileUI();
        await initGit(); // Re-initialize git for the new project
    } catch (e) {
        out(`„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅÆË™≠„ÅøËæº„Åø„Ç®„É©„Éº: ${e.message}`, 'err');
    } finally {
        modalNewProject.style.display = 'none';
    }
}


/* ---------------------------
   UI „Éò„É´„Éë„Éº
---------------------------- */
const termEl = document.getElementById('terminal');
const btnRun = document.getElementById('btn-run'), btnPreview = document.getElementById('btn-preview'), btnSave = document.getElementById('btn-save');
const btnUpload = document.getElementById('btn-upload'), btnDownload = document.getElementById('btn-download'), fileUploadInput = document.getElementById('file-upload-input');
const btnRefresh = document.getElementById('btn-refresh'), btnLogClear = document.getElementById('btn-log-clear'), logEl = document.getElementById('log');
const tabsEl = document.getElementById('tabs'), statusNode = document.getElementById('status-node');
const modal = document.getElementById('modal'), btnSettings = document.getElementById('btn-settings');
const btnVm = document.getElementById('btn-vm'), modalVm = document.getElementById('modal-vm'), btnVmClose = document.getElementById('btn-vm-close');
const aiPanel = document.getElementById('ai-panel'), aiPanelHeader = document.getElementById('ai-panel-header'), btnAiPanel = document.getElementById('btn-ai-panel');
const modalNewProject = document.getElementById('modal-new-project'), btnNewProject = document.getElementById('btn-new-project');
const modalWorkspaces = document.getElementById('modal-workspaces'), btnWorkspaces = document.getElementById('btn-workspaces');

function out(text, cls=''){ const d=document.createElement('div'); d.className='term-line'; d.innerHTML = cls? `<span class="${cls}">${text}</span>`:text; termEl.appendChild(d); termEl.scrollTop = termEl.scrollHeight; }
function promptLine(t){ out(`<span class="prompt">$</span> ${t}`); }
function logLine(text, cls=''){ const d=document.createElement('div'); if(cls) d.className=cls; d.textContent = text; logEl.appendChild(d); logEl.scrollTop = logEl.scrollHeight; }
function setStatusNode(t,cls='ok'){ statusNode.innerHTML = `Node: <span class="${cls}">${t}</span>`; }
function showModal(show){ modal.style.display = show ? 'grid' : 'none'; }

/* ---------------------------
   Monaco Editor
---------------------------- */
let editor, currentFile;
const PROJECT_TEMPLATES = {
  'vanilla': {
    name: 'Vanilla JS',
    files: {
      '/index.html': `<!doctype html>
<html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>WebCloud App</title><link rel="stylesheet" href="./style.css"></head><body><h1>Hello WebCloud üëã</h1><p id="msg">Á∑®ÈõÜ„Åó„Å¶ ‚ñ∂ ÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p><script src="./script.js"><\/script></body></html>`,
      '/style.css': `body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; padding:20px } h1{ color:#0ea5e9 }`,
      '/script.js': `document.getElementById('msg').textContent = 'ÁèæÂú®ÊôÇÂàª: ' + new Date().toLocaleString();`,
      '/app.js': `import fs from 'fs'; console.log('WebContainer„ÅßNode„ÅåÂÆüË°å‰∏≠'); fs.writeFileSync('hello.txt','webcontainer„Çà„Çä„Åì„Çì„Å´„Å°„ÅØ');`
    }
  },
  'collaboration-server': {
      name: 'Collaboration Server',
      files: {
          '/package.json': `{
  "name": "webcloud-collaboration-server",
  "version": "1.0.0",
  "description": "WebSocket server for Y.js collaboration",
  "main": "server.js",
  "scripts": {
    "start": "node server.js"
  },
  "dependencies": {
    "ws": "^8.17.0",
    "y-websocket": "^2.0.3"
  }
}`,
          '/server.js': `const http = require('http');
const WebSocket = require('ws');
const { setupWSConnection } = require('y-websocket/bin/utils');

const server = http.createServer((request, response) => {
  response.writeHead(200, { 'Content-Type': 'text/plain' });
  response.end('Collaboration server is running');
});

const wss = new WebSocket.Server({ server });

wss.on('connection', (conn, req) => {
  setupWSConnection(conn, req, {});
});

const port = process.env.PORT || 1234;
server.listen(port, () => {
  console.log(\`Collaboration server listening on port \${port}\`);
});`
      }
  },
  'react-vite': {
    name: 'React + Vite',
    files: {
      '/index.html': `<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>React App</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"><\/script>
  </body>
</html>`,
      '/package.json': `{
  "name": "react-vite-app",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0"
  },
  "devDependencies": {
    "@types/react": "^18.2.15",
    "@types/react-dom": "^18.2.7",
    "@vitejs/plugin-react": "^4.0.3",
    "vite": "^4.4.5"
  }
}`,
      '/src/main.jsx': `import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App.jsx'
import './index.css'

ReactDOM.createRoot(document.getElementById('root')).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
)`,
      '/src/App.jsx': `import React from 'react';
function App() {
  return (
    <>
      <h1>Hello from React!</h1>
    </>
  )
}
export default App`,
      '/src/index.css': `body { margin: 2rem; }`
    }
  }
};
const DEFAULT_FILES = PROJECT_TEMPLATES.vanilla.files;

function setupMonaco(){
  require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' } });
  require(['vs/editor/editor.main'], async function(){
    editor = monaco.editor.create(document.getElementById('editor'), { value:'', language:'html', theme:'vs-dark', fontSize:14, minimap:{enabled:false}, automaticLayout:true });

    // „Ç≥„Éû„É≥„Éâ„Éë„É¨„ÉÉ„Éà„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíËøΩÂä†
    editor.addAction({ id: 'run-preview', label: 'ÂÆüË°å: „Éó„É¨„Éì„É•„Éº„ÇíÂÆüË°å', keybindings: [monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter], run: () => run('run') });
    editor.addAction({ id: 'save-file', label: '„Éï„Ç°„Ç§„É´: ÁèæÂú®„ÅÆ„Éï„Ç°„Ç§„É´„Çí‰øùÂ≠ò', keybindings: [monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS], run: () => saveCurrent().then(()=>out('‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ','ok')) });
    editor.addAction({ id: 'refresh-preview', label: '„Éó„É¨„Éì„É•„Éº: Êõ¥Êñ∞', keybindings: [monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyR], run: () => refreshPreview() });
    editor.addAction({ id: 'launch-vm', label: 'VM: Linux VM„ÇíËµ∑Âãï', run: () => btnVm.onclick() });
    editor.addAction({ id: 'upload-file', label: '„Éï„Ç°„Ç§„É´: „Éï„Ç°„Ç§„É´„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ', run: () => btnUpload.onclick() });
    editor.addAction({ id: 'download-file', label: '„Éï„Ç°„Ç§„É´: ÁèæÂú®„ÅÆ„Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ', run: () => btnDownload.onclick() });
    editor.addAction({ id: 'open-settings', label: 'Áí∞Â¢ÉË®≠ÂÆö: Ë®≠ÂÆö„ÇíÈñã„Åè', run: () => btnSettings.onclick() });
    editor.addAction({ id: 'factory-reset', label: 'Áí∞Â¢ÉË®≠ÂÆö: Â∑•Â†¥Âá∫Ëç∑ÊôÇ„Å´„É™„Çª„ÉÉ„Éà', run: () => { if(confirm('Â∑•Â†¥Âá∫Ëç∑ÊôÇ„ÅÆË®≠ÂÆö„Å´„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü')) factoryReset() } });
    editor.addAction({ id: 'clear-terminal', label: '„Çø„Éº„Éü„Éä„É´: „ÇØ„É™„Ç¢', run: () => term.clear() });
    editor.addAction({
        id: 'ai-explain-code',
        label: 'AI: ÈÅ∏ÊäûÁØÑÂõ≤„ÅÆ„Ç≥„Éº„Éâ„ÇíËß£Ë™¨',
        contextMenuGroupId: '9_ai',
        contextMenuOrder: 1,
        run: function(ed) {
            const selection = ed.getModel().getValueInRange(ed.getSelection());
            if (selection) {
                aiPanel.style.display = 'flex';
                aiManager.generateReply(`‰ª•‰∏ã„ÅÆ„Ç≥„Éº„Éâ„ÇíÊó•Êú¨Ë™û„ÅßË©≥„Åó„ÅèËß£Ë™¨„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö\n\`\`\`\n${selection}\n\`\`\``);
            }
        }
    });
    editor.addAction({
        id: 'ai-refactor-code',
        label: 'AI: ÈÅ∏ÊäûÁØÑÂõ≤„ÅÆ„Ç≥„Éº„Éâ„Çí„É™„Éï„Ç°„ÇØ„Çø„É™„É≥„Ç∞',
        contextMenuGroupId: '9_ai',
        contextMenuOrder: 2,
        run: function(ed) {
            const selection = ed.getModel().getValueInRange(ed.getSelection());
            if (selection) {
                aiPanel.style.display = 'flex';
                aiManager.generateReply(`‰ª•‰∏ã„ÅÆ„Ç≥„Éº„Éâ„Çí„ÄÅ„Çà„ÇäÂäπÁéáÁöÑ„ÅßË™≠„Åø„ÇÑ„Åô„ÅÑ„Çà„ÅÜ„Å´„É™„Éï„Ç°„ÇØ„Çø„É™„É≥„Ç∞„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„Ç≥„Éº„Éâ„Å†„Åë„ÇíËøî„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö\n\`\`\`\n${selection}\n\`\`\``);
            }
        }
    });


    if (currentTheme === 'dark') { // This means it was set to 'light' in settings
        toggleTheme();
    }

    await refreshFileUI();
  });
}

async function refreshFileUI() {
  const { keys } = await idbAll('files');
  if (!keys || keys.length === 0) {
    for (const [k, v] of Object.entries(DEFAULT_FILES)) {
      await idbSet('files', k, v);
    }
  }

  const all = await idbAll('files');

  // „Çø„Éñ„ÇíÊèèÁîª
  tabsEl.innerHTML = '';
  all.keys.forEach(path => {
    const tab = document.createElement('div');
    tab.className = 'tab';

    const fileName = document.createElement('span');
    fileName.textContent = path.replace(/^\//, '');
    tab.appendChild(fileName);

    const closeBtn = document.createElement('span');
    closeBtn.className = 'close-btn';
    closeBtn.innerHTML = '&times;';
    closeBtn.onclick = (e) => {
      e.stopPropagation(); // Prevent tab click from firing
      closeFile(path);
    };
    tab.appendChild(closeBtn);

    tab.onclick = () => openFile(path);
    tabsEl.appendChild(tab);
  });

  // Set active tab
  if (currentFile) {
    const activeTabIndex = all.keys.indexOf(currentFile);
    if (activeTabIndex !== -1) {
      tabsEl.children[activeTabIndex].classList.add('active');
    }
  } else if (all.keys.length > 0) {
      openFile(all.keys[0]);
  }


  // „Éï„Ç°„Ç§„É´„Ç®„ÇØ„Çπ„Éó„É≠„Éº„É©„Éº„ÅÆ„ÉÑ„É™„Éº„ÇíÊèèÁîª
  await renderFileTree();

  // „Éï„Ç°„Ç§„É´„ÅåÂ≠òÂú®„Åô„Çå„Å∞„ÄÅ„Éá„Éï„Ç©„É´„Éà„ÅßÊúÄÂàù„ÅÆ„Éï„Ç°„Ç§„É´„ÇíÈñã„Åè
  if (all.keys.length > 0 && !currentFile) {
    openFile(all.keys[0]);
  }
}

async function closeFile(path) {
  const confirmationMessage = `Êú¨ÂΩì„Å´„Äå${path}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ`;
  if (!confirm(confirmationMessage)) {
    return;
  }

  try {
    // If the file to be deleted is currently open, handle switching away from it
    if (path === currentFile) {
      const allTabs = [...tabsEl.children].map(t => '/' + t.firstChild.textContent);
      const currentIndex = allTabs.indexOf(path);

      let nextFileToOpen = null;
      if (allTabs.length > 1) {
        // Try to open the tab to the right, otherwise the one to the left
        nextFileToOpen = allTabs[currentIndex + 1] || allTabs[currentIndex - 1];
      }

      currentFile = nextFileToOpen; // Set currentFile to the next one, or null if it's the last file
      if (!currentFile) {
        editor.setValue('');
        monaco.editor.setModelLanguage(editor.getModel(), 'plaintext');
      }
    }

    await idbDel('files', path);
    out(`„Éï„Ç°„Ç§„É´„Äå${path}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü„ÄÇ`, 'ok');
    await refreshFileUI();
    await refreshGitStatus();
  } catch (e) {
    out(`„Éï„Ç°„Ç§„É´ÂâäÈô§„Ç®„É©„Éº: ${e.message}`, 'err');
  }
}

async function openFile(path){
  currentFile = path;
  [...tabsEl.children].forEach(t=>t.classList.remove('active'));
  const idx = [...tabsEl.children].findIndex(t=>t.textContent===path.replace(/^\//,''));
  if(idx>=0) tabsEl.children[idx].classList.add('active');
  const content = await idbGet('files', path);
  const lang = path.endsWith('.js') ? 'javascript' : path.endsWith('.css') ? 'css' : path.endsWith('.c') ? 'c' : 'html';
  editor.setValue(content || ''); monaco.editor.setModelLanguage(editor.getModel(), lang);
}

async function saveCurrent(){ if(!currentFile) return; await idbSet('files', currentFile, editor.getValue()); await refreshGitStatus(); }

/* ---------------------------
   „Éó„É¨„Éì„É•„Éº
---------------------------- */
async function refreshPreview(){
  const iframe = document.getElementById('preview');
  try {
    const htmlContent = await idbGet('files', '/index.html') || '';
    const parser = new DOMParser();
    const doc = parser.parseFromString(htmlContent, 'text/html');

    // „Çπ„Çø„Ç§„É´„Ç∑„Éº„Éà„Çí„Ç§„É≥„É©„Ç§„É≥Âåñ
    const links = [...doc.querySelectorAll('link[rel="stylesheet"][href]')];
    for (const link of links) {
      const href = link.getAttribute('href');
      const path = href.startsWith('/') ? href : '/' + href;
      const cssContent = await idbGet('files', path);
      if (cssContent) {
        const style = document.createElement('style');
        style.textContent = cssContent;
        link.parentNode.replaceChild(style, link);
      }
    }

    // „Çπ„ÇØ„É™„Éó„Éà„Çí„Ç§„É≥„É©„Ç§„É≥Âåñ
    const scripts = [...doc.querySelectorAll('script[src]')];
    for (const script of scripts) {
      const src = script.getAttribute('src');
      const path = src.startsWith('/') ? src : '/' + src;
      const jsContent = await idbGet('files', path);
      if (jsContent) {
        const newScript = document.createElement('script');
        newScript.textContent = `try { ${jsContent} } catch(e) { console.error(e); }`;
        script.parentNode.replaceChild(newScript, script);
      }
    }

    const finalHtml = `<!DOCTYPE html>${doc.documentElement.outerHTML}`;
    iframe.srcdoc = finalHtml;
  } catch (err) {
    iframe.srcdoc = `<html><body>„Éó„É¨„Éì„É•„Éº„ÅÆÁîüÊàê‰∏≠„Å´„Ç®„É©„ÉºÁô∫Áîü: ${err.message}</body></html>`;
    console.error(err);
  }
}

/* ---------------------------
   WebContainer (Node) Ëµ∑Âãï
---------------------------- */
let webcontainer, wcApiUrl = 'https://unpkg.com/@webcontainer/api/dist/index.js';
async function bootWebContainer(){
  try{
    const mod = await import(/* @vite-ignore */ wcApiUrl);
    const { WebContainer } = mod;
    webcontainer = await WebContainer.boot();
    setStatusNode('Ê∫ñÂÇôÂÆå‰∫Ü','ok');
    await setupTerminal();
  }catch(e){
    setStatusNode('Â§±Êïó','err'); out('Node/WebContainer„ÅÆËµ∑Âãï„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ','err'); console.error(e);
  }
}
async function mountToWebContainer(){
  if(!webcontainer) return;
  const { keys, vals } = await idbAll('files');
  const tree = {};
  for(let i=0;i<keys.length;i++) setNested(tree, keys[i], vals[i]);
  await webcontainer.mount(tree);
}
function setNested(root, path, content){
  const parts = path.split('/').filter(Boolean); let node = root;
  for(let i=0;i<parts.length-1;i++){ const p=parts[i]; node[p]=node[p]||{}; node=node[p]; }
  node[parts.at(-1)] = { file: { contents: content } };
}
async function wcSpawn(cmd,args,onData){
  const proc = await webcontainer.spawn(cmd,args);
  proc.output.pipeTo(new WritableStream({ write(d){ onData && onData(d); } }));
  const exitCode = await proc.exit; return exitCode;
}

/* ---------------------------
   C„Éó„É©„Ç∞„Ç§„É≥Ëá™Âãï„É≠„Éº„ÉÄ„Éº (CDN)
   - Ë©¶Ë°åÈ†Ü„Å´ÂÄôË£úURL„Çí„É≠„Éº„Éâ
   - ÊàêÂäüÊôÇ„Å´ window.compileC „ÅåÊèê‰æõ„Åï„Çå„Çã„Åì„Å®„ÇíÊúüÂæÖ
---------------------------- */
// This feature has been removed.

/* ---------------------------
   Collaboration
---------------------------- */
const collaborationManager = {
    provider: null,
    doc: null,
    binding: null,
    isHost: false,

    async startSession() {
        this.isHost = true;
        out('ÂÖ±ÂêåÁ∑®ÈõÜ„Çµ„Éº„Éê„Éº„Çí„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó‰∏≠...', 'ok');

        // Write server files from template
        const template = PROJECT_TEMPLATES['collaboration-server'];
        for (const path in template.files) {
            await pfs.writeFile(path, template.files[path]);
        }
        out('„Çµ„Éº„Éê„Éº„Éï„Ç°„Ç§„É´„Çí„ÉØ„Éº„ÇØ„Çπ„Éö„Éº„Çπ„Å´Êõ∏„ÅçËæº„Åø„Åæ„Åó„Åü„ÄÇ', 'ok');

        const installProcess = await webcontainer.spawn('npm', ['install']);
        out('‰æùÂ≠òÈñ¢‰øÇ„Çí„Ç§„É≥„Çπ„Éà„Éº„É´‰∏≠...');
        await installProcess.exit;
        out('„Ç§„É≥„Çπ„Éà„Éº„É´ÂÆå‰∫Ü„ÄÇ');

        const serverProcess = await webcontainer.spawn('npm', ['start']);

        webcontainer.on('server-ready', (port, url) => {
            if (port === 1234) {
                out('ÂÖ±ÂêåÁ∑®ÈõÜ„Çµ„Éº„Éê„Éº„ÅÆÊ∫ñÂÇô„Åå„Åß„Åç„Åæ„Åó„Åü„ÄÇ', 'ok');

                const wsProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
                const serverHostname = new URL(url).hostname;
                const websocketUrl = `${wsProtocol}${serverHostname}`;
                const shareUrl = `${window.location.href.split('?')[0]}?room=${websocketUrl}`;

                prompt("„Åì„ÅÆURL„ÇíÂÖ±ÂêåÁ∑®ÈõÜËÄÖ„Å´ÂÖ±Êúâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:", shareUrl);
                this.connect(websocketUrl, 'Host');
            }
        });
    },

    connect(serverUrl, roomName) {
        if (this.provider) {
            this.provider.disconnect();
        }

        this.doc = new Y.Doc();
        // For now, we only sync the current file. A real implementation would manage multiple Y.Text objects.
        const ytext = this.doc.getText('monaco');

        this.provider = new window.WebsocketProvider(serverUrl, roomName, this.doc);
        this.provider.awareness.setLocalStateField('user', {
            name: 'User-' + Math.random().toString(36).substring(2, 6),
            color: '#' + Math.floor(Math.random()*16777215).toString(16)
        });

        this.binding = new window.MonacoBinding(ytext, editor.getModel(), this.provider.awareness);
        out('ÂÖ±ÂêåÁ∑®ÈõÜ„Çª„ÉÉ„Ç∑„Éß„É≥„Å´Êé•Á∂ö„Åó„Åæ„Åó„Åü„ÄÇ', 'ok');
    },

    init() {
        const urlParams = new URLSearchParams(window.location.search);
        const roomUrl = urlParams.get('room');
        if (roomUrl) {
            // This user is joining a session, not hosting.
            this.isHost = false;
            // Wait for webcontainer to be ready before connecting
            const check = setInterval(() => {
                if (webcontainer && editor) {
                    clearInterval(check);
                    this.connect(roomUrl, 'Guest');
                }
            }, 100);
        }
    }
};

/* ---------------------------
   GitHub Integration
---------------------------- */
const githubManager = {
    client: null,
    token: null,

    getHttpPlugin() {
        return {
            async request({ url, method, headers, body }) {
                const authHeaders = new Headers(headers);
                if (githubManager.token) {
                    authHeaders.set('Authorization', `Bearer ${githubManager.token.access_token}`);
                }
                const res = await fetch(url, { method, headers: authHeaders, body });
                return {
                    url: res.url,
                    method: res.method,
                    statusCode: res.status,
                    statusMessage: res.statusText,
                    body: res.body,
                    headers: Object.fromEntries(res.headers.entries()),
                };
            },
        };
    },

    async createRepo() {
        if (!this.token) {
            alert("GitHub„Å´„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
            return;
        }
        const repoName = prompt("Êñ∞„Åó„ÅÑ„É™„Éù„Ç∏„Éà„É™Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:");
        if (!repoName) return;

        out(`GitHub‰∏ä„Åß„É™„Éù„Ç∏„Éà„É™„Äå${repoName}„Äç„Çí‰ΩúÊàê‰∏≠...`, 'ok');
        try {
            // 1. Create repo on GitHub
            const createResponse = await fetch('https://api.github.com/user/repos', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${this.token.access_token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name: repoName, private: false }),
            });

            if (!createResponse.ok) {
                const errData = await createResponse.json();
                throw new Error(`„É™„Éù„Ç∏„Éà„É™„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${errData.message}`);
            }
            const repoData = await createResponse.json();
            out('„É™„Éù„Ç∏„Éà„É™„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü„ÄÇ', 'ok');

            // 2. If not a git repo, init
            const gitignoreExists = await pfs.stat('/.git/config').catch(() => false);
            if (!gitignoreExists) {
                await git.init({ fs, dir: '/' });
                out('„É≠„Éº„Ç´„É´„É™„Éù„Ç∏„Éà„É™„ÇíÂàùÊúüÂåñ„Åó„Åæ„Åó„Åü„ÄÇ', 'ok');
            }

            // 3. Add all files and commit
            out('ÊúÄÂàù„ÅÆ„Ç≥„Éü„ÉÉ„Éà„Çí‰ΩúÊàê‰∏≠...', 'ok');
            const statusRows = await git.statusMatrix({ fs, dir: '/' });
            for (const row of statusRows) {
                await git.add({ fs, dir: '/', filepath: row[0] });
            }
            await git.commit({ fs, dir: '/', message: 'Initial commit', author: { name: 'WebCloud IDE' } });

            // 4. Add remote and push
            out('GitHub„Å´„Éó„ÉÉ„Ç∑„É•‰∏≠...', 'ok');
            await git.addRemote({ fs, dir: '/', remote: 'origin', url: repoData.clone_url });
            const pushResult = await git.push({
                fs,
                http: this.getHttpPlugin(),
                dir: '/',
                remote: 'origin',
                ref: 'main',
                force: true, // Force push for initial commit
            });

            if (pushResult.ok) {
                out('ÊúÄÂàù„ÅÆ„Ç≥„Éü„ÉÉ„Éà„ÇíGitHub„Å´„Éó„ÉÉ„Ç∑„É•„Åó„Åæ„Åó„Åü„ÄÇ', 'ok');
            } else {
                out(`„Éó„ÉÉ„Ç∑„É•„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${pushResult.error}`, 'err');
            }

        } catch (e) {
            out(`„É™„Éù„Ç∏„Éà„É™‰ΩúÊàê„Éó„É≠„Çª„Çπ„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${e.message}`, 'err');
            console.error(e);
        }
    },

    async pushRepo() {
        if (!this.token) {
            alert("GitHub„Å´„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
            return;
        }
        out('GitHub„Å´„Éó„ÉÉ„Ç∑„É•‰∏≠...', 'ok');
        try {
            const result = await git.push({
                fs,
                http: this.getHttpPlugin(),
                dir: '/',
                onAuth: () => ({ username: this.token.access_token }),
            });
            if (result.ok) {
                out('„Éó„ÉÉ„Ç∑„É•„Å´ÊàêÂäü„Åó„Åæ„Åó„Åü„ÄÇ', 'ok');
            } else {
                out(`„Éó„ÉÉ„Ç∑„É•„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${result.error}`, 'err');
            }
        } catch (e) {
            out(`„Éó„ÉÉ„Ç∑„É•„Ç®„É©„Éº: ${e.message}`, 'err');
            console.error(e);
        }
    },

    async cloneRepo() {
        if (!this.token) {
            alert("GitHub„Å´„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
            return;
        }
        const url = prompt("„ÇØ„É≠„Éº„É≥„Åô„ÇãGitHub„É™„Éù„Ç∏„Éà„É™„ÅÆURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:", "https://github.com/user/repo.git");
        if (!url) return;

        // Confirm before wiping workspace
        const { keys } = await idbAll('files');
        if (keys.length > 0) {
            if (!confirm("ÁèæÂú®„ÅÆ„ÉØ„Éº„ÇØ„Çπ„Éö„Éº„Çπ„ÇíÊ∂àÂéª„Åó„Å¶„ÄÅ„É™„Éù„Ç∏„Éà„É™„Çí„ÇØ„É≠„Éº„É≥„Åó„Åæ„Åô„ÅãÔºüÊú™‰øùÂ≠ò„ÅÆÂ§âÊõ¥„ÅØÂ§±„Çè„Çå„Åæ„Åô„ÄÇ")) {
                return;
            }
        }

        out(`„É™„Éù„Ç∏„Éà„É™„Çí„ÇØ„É≠„Éº„É≥‰∏≠: ${url}...`, 'ok');
        try {
            // Wipe existing filesystem
            const allFiles = await pfs.readdir('/');
            for (const file of allFiles) {
                if (file !== '.' && file !== '..') {
                    await pfs.rm(`/${file}`, { recursive: true });
                }
            }

            await git.clone({
                fs,
                http: this.getHttpPlugin(),
                dir: '/',
                url: url,
                corsProxy: 'https://cors.isomorphic-git.org',
                singleBranch: true,
                depth: 10
            });
            out('„ÇØ„É≠„Éº„É≥„Å´ÊàêÂäü„Åó„Åæ„Åó„Åü„ÄÇ', 'ok');
            currentFile = null; // Reset current file
            await refreshFileUI();
            await refreshGitStatus();
        } catch (e) {
            out(`„ÇØ„É≠„Éº„É≥„Ç®„É©„Éº: ${e.message}`, 'err');
            console.error(e);
        }
    },

    async deploy() {
        out('üöÄ „Éá„Éó„É≠„Ç§„Éó„É≠„Çª„Çπ„ÇíÈñãÂßã„Åó„Åæ„Åô...', 'ok');

        if (!this.token) {
            out('„Éá„Éó„É≠„Ç§„Åô„Çã„Å´„ÅØGitHub„Å´„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'err');
            alert("„Éá„Éó„É≠„Ç§„Åô„Çã„Å´„ÅØGitHub„Å´„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
            return;
        }

        try {
            const remotes = await git.listRemotes({ fs, dir: '/' });
            if (!remotes.some(r => r.remote === 'origin')) {
                out('„Éá„Éó„É≠„Ç§ÂÖà„ÅÆ„É™„É¢„Éº„Éà„É™„Éù„Ç∏„Éà„É™„Äåorigin„Äç„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ', 'err');
                alert("„Éá„Éó„É≠„Ç§ÂÖà„ÅÆ„É™„É¢„Éº„Éà„É™„Éù„Ç∏„Éà„É™„Äåorigin„Äç„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ„ÄåNew Repo„Äç„Éú„Çø„É≥„Åß‰ΩúÊàê„Åô„Çã„Åã„ÄÅÊâãÂãï„ÅßË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
                return;
            }
        } catch (e) {
            out(`„É™„É¢„Éº„Éà„É™„Éù„Ç∏„Éà„É™„ÅÆÁ¢∫Ë™ç‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${e.message}`, 'err');
            return;
        }

        try {
            out('Â§âÊõ¥„Çí„Çπ„ÉÜ„Éº„Ç∏„É≥„Ç∞‰∏≠...', 'ok');
            const rows = await git.statusMatrix({ fs, dir });
            const changedFiles = rows.filter(row => row[1] !== row[2] || row[2] !== row[3]);

            if (changedFiles.length === 0) {
                out('„Éá„Éó„É≠„Ç§„Åô„Çã„Ç≥„Éü„ÉÉ„ÉàÊ∏à„Åø„ÅÆÂ§âÊõ¥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÁèæÂú®„ÅÆ„Éò„ÉÉ„Éâ„Çí„Éó„ÉÉ„Ç∑„É•„Åó„Åæ„Åô„ÄÇ', 'warn');
            } else {
                for (const row of rows) {
                    const [filepath, head, workdir] = row;
                    if (workdir === 3) {
                        await git.remove({ fs, dir, filepath });
                    } else {
                        await git.add({ fs, dir, filepath });
                    }
                }
                out(`${changedFiles.length}ÂÄã„ÅÆ„Éï„Ç°„Ç§„É´„ÅÆÂ§âÊõ¥„Çí„Çπ„ÉÜ„Éº„Ç∏„É≥„Ç∞„Åó„Åæ„Åó„Åü„ÄÇ`, 'ok');

                out('„Éá„Éó„É≠„Ç§„Ç≥„Éü„ÉÉ„Éà„Çí‰ΩúÊàê‰∏≠...', 'ok');
                const timestamp = new Date().toISOString();
                const commitMessage = `Deploy at ${timestamp}`;
                const sha = await git.commit({
                    fs,
                    dir,
                    message: commitMessage,
                    author: { name: 'WebCloud IDE Deploy' }
                });
                out(`„Ç≥„Éü„ÉÉ„Éà„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü: ${sha.substring(0, 7)}`, 'ok');
            }

            const branch = await git.currentBranch({ fs, dir, fullname: false });
            out(`„Äå${branch}„Äç„Éñ„É©„É≥„ÉÅ„Çíorigin„Å´„Éó„ÉÉ„Ç∑„É•„Åó„Å¶„ÅÑ„Åæ„Åô...`, 'ok');
            const pushResult = await git.push({
                fs,
                http: this.getHttpPlugin(),
                dir: '/',
                remote: 'origin',
                ref: branch,
                onAuth: () => ({ username: this.token.access_token }),
            });

            if (pushResult.ok) {
                out('‚úÖ „Éá„Éó„É≠„Ç§ÊàêÂäüÔºÅÂ§âÊõ¥„ÅåGitHub„Å´„Éó„ÉÉ„Ç∑„É•„Åï„Çå„Åæ„Åó„Åü„ÄÇ', 'ok');
                out('„Éõ„Çπ„ÉÜ„Ç£„É≥„Ç∞„Çµ„Éº„Éì„ÇπÔºàNetlify„ÄÅVercel„Å™„Å©Ôºâ„Åß„Éì„É´„Éâ„ÅåÈñãÂßã„Åï„Çå„Åæ„Åô„ÄÇ', 'ok');
            } else {
                throw new Error(`„Éó„ÉÉ„Ç∑„É•„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${pushResult.error}`);
            }
        } catch (e) {
            out(`„Éá„Éó„É≠„Ç§„Éó„É≠„Çª„Çπ„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${e.message}`, 'err');
            console.error(e);
        }
    },

    async init(clientId) {
        if (!clientId) {
            console.warn("GitHub Client ID not set.");
            return;
        }
        this.client = new window.OAuth2AuthCodePkceClient({
            authorizationUrl: 'https://github.com/login/oauth/authorize',
            tokenUrl: 'https://github.com/login/oauth/access_token',
            clientId: clientId,
            redirectUrl: window.location.href.split('?')[0], // Use current URL as redirect URI
            scopes: ['repo', 'user:read'],
            onAccessTokenExpiry: async (token) => token, // No refresh token support needed for now
            onInvalidGrant: (err) => console.error("OAuth invalid grant:", err),
        });

        if (window.location.search.includes('code=')) {
            try {
                const token = await this.client.getTokens();
                await this.setToken(token);
                // Clean the URL
                window.history.replaceState({}, document.title, window.location.pathname);
                this.updateUiForLogin();
            } catch (err) {
                console.error("Error getting GitHub token:", err);
            }
        } else {
            const storedToken = await idbGet('settings', SKEYS.githubToken);
            if (storedToken) {
                this.token = storedToken;
                this.updateUiForLogin();
            }
        }
    },

    async login() {
        if (!this.client) {
            alert("GitHub Client ID„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇË®≠ÂÆöÁîªÈù¢„Åã„ÇâÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
            return;
        }
        await this.client.requestAuthorizationCode();
    },

    async logout() {
        await idbDel('settings', SKEYS.githubToken);
        this.token = null;
        this.client = null; // Re-init needed
        this.updateUiForLogout();
    },

    async setToken(token) {
        this.token = token;
        await idbSet('settings', SKEYS.githubToken, token);
    },

    async updateUiForLogin() {
        document.getElementById('btn-github-login').style.display = 'none';
        document.getElementById('btn-github-logout').style.display = 'inline-block';
        const userSpan = document.getElementById('github-user');

        try {
            const response = await fetch('https://api.github.com/user', {
                headers: { 'Authorization': `Bearer ${this.token.access_token}` }
            });
            const data = await response.json();
            userSpan.textContent = `Welcome, ${data.login}`;
            userSpan.style.display = 'inline-block';
        } catch (e) {
            console.error("Failed to fetch GitHub user", e);
            userSpan.textContent = 'Logged In';
            userSpan.style.display = 'inline-block';
        }
    },

    updateUiForLogout() {
        document.getElementById('btn-github-login').style.display = 'inline-block';
        document.getElementById('btn-github-logout').style.display = 'none';
        document.getElementById('github-user').style.display = 'none';
    }
};


/* ---------------------------
   Ë®≠ÂÆö
---------------------------- */
const SKEYS = { project:'project-name', wc:'wc-url', monaco:'monaco-cdn', autosave:'autosave', userId: 'user-id', theme: 'theme', aiModel: 'ai_model', githubClientId: 'github_client_id', githubToken: 'github_token' };

let currentTheme = 'dark';

async function toggleTheme() {
  currentTheme = document.body.classList.contains('light-theme') ? 'dark' : 'light';

  if (currentTheme === 'light') {
    document.body.classList.add('light-theme');
    monaco.editor.setTheme('vs');
  } else {
    document.body.classList.remove('light-theme');
    monaco.editor.setTheme('vs-dark');
  }

  await idbSet('settings', SKEYS.theme, currentTheme);
  logLine(`„ÉÜ„Éº„Éû„Çí„Äå${currentTheme}„Äç„Å´Âàá„ÇäÊõø„Åà„Åæ„Åó„Åü„ÄÇ`, 'ok');
}

async function getOrSetUserId() {
  let userId = await idbGet('settings', SKEYS.userId);
  if (!userId) {
    userId = Math.random().toString(36).substring(2, 10);
    await idbSet('settings', SKEYS.userId, userId);
    logLine(`„É¶„Éº„Ç∂„ÉºID„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇÊñ∞Ë¶èÂåøÂêçID„ÇíÁîüÊàê„Åó„Åæ„Åó„Åü: ${userId}`, 'ok');
  }
  return userId;
}

async function loadSettings(){
  const proj = (await idbGet('settings',SKEYS.project)) || 'my-webcloud-app';
  const wc = (await idbGet('settings',SKEYS.wc)) || wcApiUrl;
  const mon = (await idbGet('settings',SKEYS.monaco)) || 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js';
  const autosave = (await idbGet('settings',SKEYS.autosave)) || false;
  const theme = (await idbGet('settings', SKEYS.theme)) || 'dark';
  const githubClientId = (await idbGet('settings', SKEYS.githubClientId)) || '';


  document.getElementById('set-project').value = proj;
  document.getElementById('set-wc').value = wc;
  document.getElementById('set-monaco').value = mon;
  document.getElementById('set-autosave').checked = !!autosave;
  document.getElementById('set-github-client-id').value = githubClientId;
  wcApiUrl = wc;

  if (theme === 'light') {
    // We need to toggle it from the default 'dark' state
    // but need to wait for the editor to be ready.
    // The call is now in the boot sequence.
    currentTheme = 'dark'; // Will be toggled to light
  }
}
async function saveSettings(){
  await idbSet('settings',SKEYS.project, document.getElementById('set-project').value.trim());
  await idbSet('settings',SKEYS.wc, document.getElementById('set-wc').value.trim());
  await idbSet('settings',SKEYS.monaco, document.getElementById('set-monaco').value.trim());
  await idbSet('settings',SKEYS.autosave, document.getElementById('set-autosave').checked);
  const githubClientId = document.getElementById('set-github-client-id').value.trim();
  await idbSet('settings', SKEYS.githubClientId, githubClientId);

  showModal(false); out('Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ','ok');
  // Â§âÊõ¥„ÇíÂèçÊò†: URL„ÅåÊõ¥Êñ∞„Åï„Çå„Åü„ÇâC„Éó„É©„Ç∞„Ç§„É≥„ÇíÂÜçË™≠„ÅøËæº„Åø
  setStatusC('Ë™≠Ëæº‰∏≠‚Ä¶','warn'); window.compileC = undefined; cReady=false; loadCPluginAuto();
  // Re-init github manager with new client ID
  githubManager.init(githubClientId);
}
async function factoryReset(){ const req=indexedDB.deleteDatabase(DB_NAME); req.onsuccess=()=>location.reload(); req.onerror=()=>alert('„É™„Çª„ÉÉ„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ'); }

/* ---------------------------
   „Çø„Éº„Éü„Éä„É´
---------------------------- */
async function setupTerminal() {
  const term = new Terminal({
    cursorBlink: true,
    fontFamily: 'ui-monospace, Menlo, Consolas, monospace',
    fontSize: 14,
  });
  term.open(termEl);

  await mountToWebContainer();
  const shellProcess = await webcontainer.spawn('jsh', {
    terminal: {
      cols: term.cols,
      rows: term.rows,
    },
  });

  shellProcess.output.pipeTo(
    new WritableStream({
      write(data) {
        term.write(data);
      },
    })
  );

  const input = shellProcess.input.getWriter();
  term.onData((data) => {
    input.write(data);
  });

  term.onResize((size) => {
    shellProcess.resize({
      cols: size.cols,
      rows: size.rows,
    });
  });

  out('„Çø„Éº„Éü„Éä„É´„ÅåÊ∫ñÂÇô„Åß„Åç„Åæ„Åó„Åü„ÄÇ', 'ok');
}


/* ---------------------------
   AI Panel Logic
---------------------------- */
const availableModels = [
    { model_id: "expert-mode", name: "„Ç®„Ç≠„Çπ„Éë„Éº„Éà„É¢„Éº„Éâ (Llama 3)", size: "È´òÂìÅË≥™" },
    { model_id: "Llama-3-8B-Instruct-q4f32_1-MLC", name: "Llama 3 8B (Meta)", size: "4.7GB" },
    { model_id: "gemma-2b-it-q4f32_1-MLC", name: "Gemma 2B (Google)", size: "2.7GB" },
    { model_id: "Phi-3-mini-4k-instruct-q4f32_1-MLC", name: "Phi-3 Mini (Microsoft)", size: "2.3GB" },
    { model_id: "Mistral-7B-Instruct-v0.2-q4f32_1-MLC", name: "Mistral 7B (Mistral AI)", size: "4.4GB" },
    { model_id: "CodeLlama-7b-Instruct-hf-q4f32_1-MLC", name: "CodeLlama 7B (Meta)", size: "4.0GB" },
    { model_id: "WizardCoder-Python-7B-V1.0-q4f16_1-MLC", name: "WizardCoder Python 7B", size: "3.8GB" },
    { model_id: "RedPajama-INCITE-Chat-3B-v1-q4f32_1-MLC", name: "RedPajama 3B (Together)", size: "1.8GB" },
    { model_id: "TinyLlama-1.1B-Chat-v1.0-q4f32_1-MLC", name: "TinyLlama 1.1B (Independent)", size: "0.7GB" }
];

const aiManager = {
    chat: null,
    currentModelId: null,

    async loadModel(modelId) {
        this.addBotMessage("AI„É¢„Éá„É´„ÇíÂàùÊúüÂåñ‰∏≠...");
        try {
            if (this.chat) {
                await this.chat.unload();
            }
            this.currentModelId = modelId;
            const selectedModel = availableModels.find(m => m.model_id === modelId);

            this.chat = await webllm.CreateChatModule({
                progress_callback: (report) => {
                    const progressText = `„É¢„Éá„É´Ë™≠Ëæº‰∏≠: ${report.text}`;
                    this.updateBotMessage(progressText);
                }
            });

            await this.chat.reload(modelId);
            this.updateBotMessage(`„É¢„Éá„É´„Äå${selectedModel.name}„Äç„ÅÆÊ∫ñÂÇô„Åå„Åß„Åç„Åæ„Åó„Åü„ÄÇ`);
            await idbSet('settings', 'ai_model', modelId);
        } catch(e) {
            this.updateBotMessage(`„É¢„Éá„É´„Äå${modelId}„Äç„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${e.message}`);
            this.chat = null;
        }
    },

    async generateReply(prompt) {
        const selectedMode = document.getElementById('ai-model-selector-panel').value;
        const expertModelId = "Llama-3-8B-Instruct-q4f32_1-MLC";

        if (selectedMode === 'expert-mode') {
            if (this.currentModelId !== expertModelId) {
                this.addBotMessage("„Ç®„Ç≠„Çπ„Éë„Éº„Éà„É¢„Éº„Éâ„ÅÆ„Åü„ÇÅ„ÄÅLlama 3„É¢„Éá„É´„Å´Âàá„ÇäÊõø„Åà„Åæ„Åô...");
                await this.loadModel(expertModelId);
            }
            // Now that the correct model is loaded, construct the expert prompt
            const expertPrompt = `„ÅÇ„Å™„Åü„ÅØ‰∏ñÁïå„ÇØ„É©„Çπ„ÅÆÂ∞ÇÈñÄÂÆ∂„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆ„É¶„Éº„Ç∂„Éº„Åã„Çâ„ÅÆ„É™„ÇØ„Ç®„Çπ„Éà„Å´ÂØæ„Åó„Å¶„ÄÅÂ§öËßíÁöÑ„Å™Ë¶ñÁÇπ„Åã„ÇâÊÆµÈöéÁöÑ„Å´ËÄÉ„Åà„ÄÅÊúÄÁµÇÁöÑ„Å´ÊúÄ„ÇÇË≥™„ÅÆÈ´ò„ÅÑ„ÄÅÂåÖÊã¨ÁöÑ„Å™ÂõûÁ≠î„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

### „É¶„Éº„Ç∂„Éº„É™„ÇØ„Ç®„Çπ„Éà
${prompt}

### „ÅÇ„Å™„Åü„ÅÆÊÄùËÄÉ„Éó„É≠„Çª„ÇπÔºà„Çπ„ÉÜ„ÉÉ„Éó„Éª„Éê„Ç§„Éª„Çπ„ÉÜ„ÉÉ„ÉóÔºâ
1.  „Åæ„Åö„ÄÅ„Åì„ÅÆ„É™„ÇØ„Ç®„Çπ„Éà„ÅÆÊ†∏ÂøÉ„Å®„Å™„ÇãÁõÆÁöÑ„ÇíÁâπÂÆö„Åô„Çã„ÄÇ
2.  Ê¨°„Å´„ÄÅËÄÉ„Åà„Çâ„Çå„Çã„Ç¢„Éó„É≠„Éº„ÉÅ„ÇÑÂõûÁ≠î„ÅÆÈÅ∏ÊäûËÇ¢„ÇíË§áÊï∞Êåô„Åí„Çã„ÄÇ
3.  „Åù„Çå„Åû„Çå„ÅÆÈÅ∏ÊäûËÇ¢„ÅÆÈï∑ÊâÄ„Å®Áü≠ÊâÄ„ÇíÊØîËºÉÊ§úË®é„Åô„Çã„ÄÇ
4.  ÊúÄÁµÇÁöÑ„Å´„ÄÅ„Åô„Åπ„Å¶„ÅÆÊÉÖÂ†±„ÇíÁµ±Âêà„Åó„ÄÅÂàùÂøÉËÄÖ„Å´„ÇÇÁêÜËß£„Åß„Åç„Çã„Çà„ÅÜ„ÄÅ‰∏ÅÂØß„Åã„Å§Ë©≥Á¥∞„Å™ÊúÄÁµÇÂõûÁ≠î„Çí‰ΩúÊàê„Åô„Çã„ÄÇ

„Åß„ÅØ„ÄÅÊÄùËÄÉ„Éó„É≠„Çª„Çπ„Å´Âæì„Å£„Å¶„ÄÅÊúÄÈ´ò„ÅÆÂõûÁ≠î„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;

            this.addUserMessage(prompt);
            this.addBotMessage("„Ç®„Ç≠„Çπ„Éë„Éº„Éà„É¢„Éº„Éâ„ÅßÊÄùËÄÉ‰∏≠...");
            try {
                const reply = await this.chat.generate(expertPrompt);
                this.updateBotMessage(reply);
            } catch (e) {
                this.updateBotMessage(`AI„ÅÆÂøúÁ≠îÁîüÊàê‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${e.message}`);
            }

        } else {
            // Standard mode
            if (!this.chat) {
                this.addBotMessage("„Ç®„É©„Éº: AI„É¢„Éá„É´„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇË®≠ÂÆö„Åã„Çâ„É¢„Éá„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
                return;
            }
            this.addUserMessage(prompt);
            this.addBotMessage("ÊÄùËÄÉ‰∏≠...");

            try {
                const reply = await this.chat.generate(prompt);
                this.updateBotMessage(reply);
            } catch(e) {
                this.updateBotMessage(`AI„ÅÆÂøúÁ≠îÁîüÊàê‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${e.message}`);
            }
        }
    },

    addBotMessage(text) {
        const body = document.getElementById('ai-panel-body');
        const bubble = document.createElement('div');
        bubble.className = 'ai-chat-bubble bot';
        bubble.textContent = text;
        body.appendChild(bubble);
        body.scrollTop = body.scrollHeight;
    },

    updateBotMessage(text) {
        const body = document.getElementById('ai-panel-body');
        const lastBubble = body.querySelector('.ai-chat-bubble.bot:last-child');
        if (lastBubble) {
            lastBubble.textContent = text;
        }
    },

    addUserMessage(text) {
        const body = document.getElementById('ai-panel-body');
        const bubble = document.createElement('div');
        bubble.className = 'ai-chat-bubble user';
        bubble.textContent = text;
        body.appendChild(bubble);
        body.scrollTop = body.scrollHeight;
    }
};

function populateModelSelectors() {
    const selectorPanel = document.getElementById('ai-model-selector-panel');
    const selectorSettings = document.getElementById('ai-model-selector-settings');

    [selectorPanel, selectorSettings].forEach(selector => {
        selector.innerHTML = '';
        availableModels.forEach(model => {
            const option = document.createElement('option');
            option.value = model.model_id;
            option.textContent = `${model.name} (${model.size})`;
            selector.appendChild(option);
        });
    });
}

async function syncAndLoadModel(event) {
    const selectedModelId = event.target.value;
    const selectorPanel = document.getElementById('ai-model-selector-panel');
    const selectorSettings = document.getElementById('ai-model-selector-settings');

    selectorPanel.value = selectedModelId;
    selectorSettings.value = selectedModelId;

    await idbSet('settings', SKEYS.aiModel, selectedModelId);

    if (selectedModelId !== 'expert-mode') {
        aiManager.loadModel(selectedModelId);
    } else {
        aiManager.addBotMessage("„Ç®„Ç≠„Çπ„Éë„Éº„Éà„É¢„Éº„Éâ„ÅåÈÅ∏Êäû„Åï„Çå„Åæ„Åó„Åü„ÄÇÊúÄÈ´ò„ÅÆÂõûÁ≠î„ÇíÁîüÊàê„Åô„Çã„Åü„ÇÅ„ÄÅLlama 3 „É¢„Éá„É´„Çí‰ΩøÁî®„Åó„Åæ„Åô„ÄÇ");
    }
}

function makeDraggable(panel, header) {
  let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
  header.onmousedown = dragMouseDown;

  function dragMouseDown(e) {
    e = e || window.event;
    e.preventDefault();
    // get the mouse cursor position at startup:
    pos3 = e.clientX;
    pos4 = e.clientY;
    document.onmouseup = closeDragElement;
    // call a function whenever the cursor moves:
    document.onmousemove = elementDrag;
  }

  function elementDrag(e) {
    e = e || window.event;
    e.preventDefault();
    // calculate the new cursor position:
    pos1 = pos3 - e.clientX;
    pos2 = pos4 - e.clientY;
    pos3 = e.clientX;
    pos4 = e.clientY;
    // set the element's new position:
    panel.style.top = (panel.offsetTop - pos2) + "px";
    panel.style.left = (panel.offsetLeft - pos1) + "px";
  }

  function closeDragElement() {
    // stop moving when mouse button is released:
    document.onmouseup = null;
    document.onmousemove = null;
  }
}

/* ---------------------------
   „Éú„Çø„É≥„ÅÆÊé•Á∂ö
---------------------------- */
btnRun.onclick = ()=>refreshPreview(); // `run` is now preview
btnPreview.onclick = ()=>refreshPreview();
btnSave.onclick = ()=>saveCurrent().then(()=>out('‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ','ok'));

btnUpload.onclick = () => fileUploadInput.click();
fileUploadInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = async (event) => {
    try {
      const content = event.target.result;
      const path = '/' + file.name;
      await idbSet('files', path, content);
      await refreshFileUI();
      await openFile(path);
      out(`${file.name} „Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü`, 'ok');
      await refreshGitStatus();
    } catch (err) {
      out(`„Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É©„Éº: ${err.message}`, 'err');
      console.error(err);
    }
  };
  reader.onerror = (err) => {
    out(`„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº: ${err.message}`, 'err');
    console.error(err);
  };
  reader.readAsText(file);

  // Âêå„Åò„Éï„Ç°„Ç§„É´„ÇíÂÜçÂ∫¶ÈÅ∏Êäû„Åó„Å¶„ÇÇ 'change' „Ç§„Éô„É≥„Éà„ÅåÁô∫ÁÅ´„Åô„Çã„Çà„ÅÜ„Å´„ÄÅÂÖ•ÂäõÂÄ§„Çí„É™„Çª„ÉÉ„Éà„Åô„Çã
  e.target.value = '';
});

btnDownload.onclick = () => {
  if (!currentFile) {
    out('„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åô„Çã„Éï„Ç°„Ç§„É´„ÅåÈñã„Åã„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ', 'warn');
    return;
  }

  try {
    const content = editor.getValue();
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');

    a.href = url;
    a.download = currentFile.startsWith('/') ? currentFile.substring(1) : currentFile;

    document.body.appendChild(a);
    a.click();

    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      out(`${a.download} „Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü`, 'ok');
    }, 0);
  } catch (err) {
    out(`„Éï„Ç°„Ç§„É´„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Ç®„É©„Éº: ${err.message}`, 'err');
    console.error(err);
  }
};

btnRefresh.onclick = ()=>refreshPreview();
btnLogClear.onclick = ()=>{ logEl.innerHTML=''; };
btnSettings.onclick = ()=>{ loadSettings().then(()=>showModal(true)); };
document.getElementById('btn-save-settings').onclick = saveSettings;
document.getElementById('btn-reset-all').onclick = ()=>{ if(confirm('Â∑•Â†¥Âá∫Ëç∑ÊôÇ„ÅÆË®≠ÂÆö„Å´„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü')) factoryReset(); };
document.getElementById('btn-toggle-theme').onclick = toggleTheme;
document.getElementById('btn-github-login').onclick = () => githubManager.login();
document.getElementById('btn-github-logout').onclick = () => githubManager.logout();
document.getElementById('btn-github-clone').onclick = () => githubManager.cloneRepo();
document.getElementById('btn-github-new').onclick = () => githubManager.createRepo();
document.getElementById('btn-collaboration').onclick = () => collaborationManager.startSession();
document.getElementById('btn-export-zip').onclick = exportProjectAsZip;
btnNewProject.onclick = () => {
    populateTemplateModal();
    modalNewProject.style.display = 'grid';
};
btnWorkspaces.onclick = () => {
    workspaceManager.populateModal();
    modalWorkspaces.style.display = 'grid';
};
document.getElementById('btn-save-workspace').onclick = () => {
    const name = document.getElementById('new-workspace-name').value;
    workspaceManager.save(name);
    document.getElementById('new-workspace-name').value = '';
};
document.getElementById('load-plugin-input').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (event) => loadPlugin(event.target.result);
    reader.readAsText(file);
    e.target.value = ''; // Reset for next time
});
document.getElementById('ai-model-selector-panel').onchange = syncAndLoadModel;
document.getElementById('ai-model-selector-settings').onchange = syncAndLoadModel;

function sendAiPrompt() {
    const promptInput = document.getElementById('ai-prompt-input');
    const prompt = promptInput.value.trim();
    if (prompt) {
        aiManager.generateReply(prompt);
        promptInput.value = '';
    }
}

document.getElementById('ai-send-prompt-btn').onclick = sendAiPrompt;

document.getElementById('ai-gen-command-btn').onclick = () => {
    const promptInput = document.getElementById('ai-prompt-input');
    const prompt = promptInput.value.trim();
    if (prompt) {
        const commandPrompt = `„ÅÇ„Å™„Åü„ÅØLinux„Ç∑„Çß„É´„Ç≥„Éû„É≥„Éâ„ÅÆÂ∞ÇÈñÄÂÆ∂„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆ„É™„ÇØ„Ç®„Çπ„Éà„Çí„ÄÅÂÆüË°åÂèØËÉΩ„Å™Âçò‰∏Ä„ÅÆ„Ç∑„Çß„É´„Ç≥„Éû„É≥„Éâ„Å´Â§âÊèõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„Ç≥„Éû„É≥„Éâ„ÅÆ„Åø„ÇíËøî„Åó„ÄÅË™¨Êòé„ÅØ‰∏çË¶Å„Åß„Åô„ÄÇ\n\n„É™„ÇØ„Ç®„Çπ„ÉàÔºö ${prompt}`;
        aiManager.generateReply(commandPrompt);
        promptInput.value = '';
    }
};

document.getElementById('ai-prompt-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendAiPrompt();
    }
});


btnAiPanel.onclick = () => {
  aiPanel.style.display = aiPanel.style.display === 'flex' ? 'none' : 'flex';
};
makeDraggable(aiPanel, aiPanelHeader);


let vm_started = false;

async function createVmFilesystem() {
  const allFiles = await idbAll('files');
  const fsJson = {
    "fsroot": []
  };

  if (allFiles.keys && allFiles.vals) {
    for (let i = 0; i < allFiles.keys.length; i++) {
      const path = allFiles.keys[i];
      const content = allFiles.vals[i];

      if (path.startsWith('/')) {
        const blob = new Blob([content]);
        const url = URL.createObjectURL(blob);
        fsJson.fsroot.push({
          "name": path.substring(1),
          "type": "file",
          "url": url,
          "size": blob.size,
        });
      }
    }
  }

  const fsJsonBlob = new Blob([JSON.stringify(fsJson)], { type: 'application/json' });

  return {
    basefs: fsJsonBlob,
    baseurl: '', // Áµ∂ÂØæÁöÑ„Å™„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàURL„Çí‰ΩøÁî®„Åó„Å¶„ÅÑ„Çã„Åü„ÇÅ„ÄÅbaseurl„ÅØÁ©∫„Å´„Åß„Åç„Çã
  };
}

async function startVM() {
  if (vm_started) return;
  vm_started = true;
  out("Linux VM„ÇíËµ∑Âãï‰∏≠... „Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ", "ok");

  const fs_adapter = await createVmFilesystem();

  const emulator = new V86({
    wasm_path: "https://cdn.jsdelivr.net/npm/v86/build/v86.wasm",
    memory_size: 64 * 1024 * 1024, // ÂÆâÂÆöÊÄß„ÅÆ„Åü„ÇÅ„Å´„É°„É¢„É™„ÇíÂ¢óÂä†
    vga_memory_size: 8 * 1024 * 1024,
    screen_container: document.getElementById("screen_container"),
    bios: { url: "https://cdn.jsdelivr.net/npm/v86/bios/seabios.bin" },
    vga_bios: { url: "https://cdn.jsdelivr.net/npm/v86/bios/vgabios.bin" },
    cdrom: { url: "https://i.copy.sh/linux.iso" },
    filesystem: fs_adapter,
    autostart: true,
  });

  let serial_data = "";
  let mount_command_sent = false;
  const PROMPT = "~% ";

  emulator.add_listener("serial0-output-byte", function(byte) {
    const char = String.fromCharCode(byte);
    if (char === "\r") {
      return;
    }
    serial_data += char;

    if (!mount_command_sent && serial_data.endsWith(PROMPT)) {
      mount_command_sent = true;
      const mount_command = "mount -t 9p host9p /mnt/9p\n";
      emulator.serial0_send(mount_command);
      out("ÂÖ±Êúâ„Éï„Ç°„Ç§„É´„Ç∑„Çπ„ÉÜ„É†„Çí /mnt/9p „Å´Ëá™Âãï„Éû„Ç¶„É≥„Éà„Åó„Åæ„Åô...", "ok");
    }
  });
}
btnVm.onclick = () => {
  modalVm.style.display = 'grid';
  startVM();
};
btnVmClose.onclick = () => {
  modalVm.style.display = 'none';
};

document.getElementById('git-commit-button').onclick = performCommit;
document.getElementById('git-push-button').onclick = () => githubManager.pushRepo();
document.getElementById('git-graph-refresh-btn').onclick = renderGitGraph;
document.getElementById('btn-deploy').onclick = () => githubManager.deploy();

/* ---------------------------
   Plugin System
---------------------------- */
const webcloud = {
    plugins: {
        _plugins: {},
        register(plugin) {
            if (this._plugins[plugin.name]) {
                console.warn(`Plugin "${plugin.name}" is already registered.`);
                return;
            }
            console.log(`Registering plugin: ${plugin.name} v${plugin.version}`);
            this._plugins[plugin.name] = plugin;

            const ctx = {
                addButton: (label, onclick) => {
                    const btn = document.createElement('button');
                    btn.className = 'pill';
                    btn.textContent = label;
                    btn.onclick = onclick;
                    document.querySelector('.controls').appendChild(btn);
                },
                registerCommand: (name, handler) => {
                    // This requires re-introducing a command runner.
                    // For now, this is a placeholder.
                    console.log(`Plugin registered command: ${name}`);
                },
                out: out,
                pfs: pfs
            };

            try {
                plugin.init(ctx);
            } catch (e) {
                console.error(`Error initializing plugin "${plugin.name}":`, e);
            }
        }
    }
};

function loadPlugin(fileContent) {
    try {
        const script = document.createElement('script');
        script.textContent = fileContent;
        document.body.appendChild(script);
        document.body.removeChild(script); // Clean up the script tag
    } catch(e) {
        out(`„Éó„É©„Ç∞„Ç§„É≥„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${e.message}`, 'err');
    }
}


/* ---------------------------
   Ëµ∑ÂãïÂá¶ÁêÜ
---------------------------- */
const userCmds = {};
(async function boot(){
  try {
    await openDB();
    await getOrSetUserId();
    await loadSettings();
    const clientId = await idbGet('settings', SKEYS.githubClientId);
    await githubManager.init(clientId);
    collaborationManager.init();
    setupMonaco();
    populateModelSelectors();
    renderFileTree();
    initGit().then(renderGitGraph);
    out('WebCloud„ÅÆÊ∫ñÂÇô„Åå„Åß„Åç„Åæ„Åó„Åü„ÄÇ„Äåhelp„Äç„Å®ÂÖ•Âäõ„Åó„Å¶ÈñãÂßã„Åó„Åæ„Åô„ÄÇ','ok');

    // Load last used AI model
    const lastModel = await idbGet('settings', SKEYS.aiModel);
    if (lastModel) {
        document.getElementById('ai-model-selector-panel').value = lastModel;
        document.getElementById('ai-model-selector-settings').value = lastModel;
        aiManager.loadModel(lastModel);
    }


    // load user cmds
    const all = await idbAll('cmds'); if(all.keys) for(let i=0;i<all.keys.length;i++){ try{ userCmds[all.keys[i]] = eval(all.vals[i]); }catch(e){} }

    // Node
    bootWebContainer();

  } catch (e) {
    out('Ëµ∑Âãï‰∏≠„Å´Ëá¥ÂëΩÁöÑ„Å™„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇË®≠ÂÆö„Åã„Çâ„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Çí„É™„Çª„ÉÉ„Éà„Åô„Çã„Åã„ÄÅ„Éñ„É©„Ç¶„Ç∂„ÅÆ„Éá„Éº„Çø„ÇíÊ∂àÂéª„Åó„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'err');
    console.error(e);
  }
})();
</script>
</body>
</html>
