<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WebCloud IDE & CLI ‚Äî Node + C (CDN auto)</title>
<style>
/* --- „ÉÄ„Éº„ÇØ IT„Å£„ÅΩ„ÅÑ„Çπ„Çø„Ç§„É´ (ÁúÅÁï•„Åõ„ÅöÂÆüÁâ©) --- */
:root{--bg:#0b0f14;--panel:#121927;--panel2:#0f1520;--txt:#e6edf3;--sub:#a8b3bf;--acc:#00d4ff;--ok:#6ee7b7;--warn:#fbbf24;--err:#f87171;--border:#1c2735;--muted:#202b3a}
*{box-sizing:border-box}html,body{height:100%;margin:0;background:var(--bg);color:var(--txt);font-family:ui-monospace,Menlo,Consolas,monospace}
.layout{display:grid;grid-template-rows:48px 1fr;height:100%}
header{display:flex;align-items:center;justify-content:space-between;padding:0 12px;background:linear-gradient(180deg,var(--panel),var(--panel2));border-bottom:1px solid var(--border)}
.brand{display:flex;align-items:center;gap:10px}
.badge{padding:2px 8px;border-radius:999px;font-size:12px;background:linear-gradient(90deg,#00d4ff,#8b5cf6);color:#031018;font-weight:700}
.controls{display:flex;gap:8px;align-items:center}
button{background:var(--muted);color:var(--txt);border:1px solid var(--border);padding:8px 10px;border-radius:12px;cursor:pointer;font-weight:600}
button:hover{background:#223349}.pill{border-radius:999px}
.main{display:grid;grid-template-columns:46% 54%;height:calc(100vh - 48px)}
.col{border-right:1px solid var(--border);overflow:hidden}.col:last-child{border-right:none}
.panel{height:100%;display:flex;flex-direction:column}
.titlebar{height:36px;display:flex;align-items:center;gap:8px;padding:0 10px;border-bottom:1px solid var(--border);background:var(--panel)}
.title{font-weight:700;color:var(--sub)}
.terminal{flex:1;background:#0a0f17;padding:10px;overflow:auto}.term-line{white-space:pre-wrap;margin:0}.prompt{color:#86efac}
.inputbar{border-top:1px solid var(--border);display:flex;gap:8px;padding:8px;background:var(--panel)}
.inputbar input{flex:1;background:#0e1624;border:1px solid var(--border);color:var(--txt);padding:10px;border-radius:10px}
.split{display:grid;grid-template-rows:1fr 42%;height:100%}
#editor{height:100%;width:100%;background:#0b1220}
.tabs{display:flex;gap:8px;padding:8px;border-bottom:1px solid var(--border);background:var(--panel2)}
.tab{padding:6px 10px;border-radius:10px;cursor:pointer;background:#0f1a2b;border:1px solid var(--border);color:var(--sub)}
.tab.active{background:#13243b;color:var(--txt)}
.subpanel{border-top:1px solid var(--border);background:#0b1019;display:grid;grid-template-columns:55% 45%}
.subcol{display:flex;flex-direction:column;border-right:1px solid var(--border);overflow:hidden}.subcol:last-child{border-right:none}
.toolbar{padding:6px 8px;display:flex;gap:8px;border-bottom:1px solid var(--border);background:var(--panel2)}
.small{font-size:12px}.hint{color:var(--sub);font-size:12px}
#preview{flex:1;border:0;background:#0a0f17}
.log{flex:1;background:#0a0f17;padding:10px;overflow:auto}
.right{margin-left:auto}
.modal-backdrop{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.5)}
.modal{width:min(820px,96vw);background:#0f1520;border:1px solid var(--border);border-radius:16px;overflow:hidden}
.modal header{padding:10px 12px}.modal .body{padding:12px;display:grid;gap:10px}
.field{display:grid;gap:6px}.field label{font-size:12px;color:var(--sub)}.field input,.field textarea{background:#0e1624;border:1px solid var(--border);color:var(--txt);padding:10px;border-radius:10px;width:100%}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}.danger{background:#36161a;border-color:#5b1c23}
</style>

<!-- Monaco Editor loader -->
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
</head>
<body>
<div class="layout">
  <header>
    <div class="brand">
      <span class="badge">WebCloud</span>
      <div>IDE & CLI</div>
      <div class="status" id="status-node">Node: <span class="warn">booting‚Ä¶</span></div>
      <div class="status" id="status-c">C: <span class="warn">loading‚Ä¶</span></div>
      <div class="status" id="status-db">Storage: <span class="ok">IndexedDB</span></div>
    </div>
    <div class="controls">
      <button id="btn-settings" class="pill">‚öô Settings</button>
      <button id="btn-save" class="pill">üíæ Save</button>
      <button id="btn-run" class="pill">‚ñ∂ Run</button>
      <button id="btn-preview" class="pill">üåê Preview</button>
    </div>
  </header>

  <div class="main">
    <!-- Left: CLI -->
    <div class="col panel">
      <div class="titlebar"><span class="title">Console</span><span class="hint">type <span style="color:var(--acc)">help</span> ¬∑ Tab for completion</span></div>
      <div class="terminal" id="terminal"></div>
      <div class="inputbar">
        <input id="input" placeholder="> " />
        <button id="btn-enter">Enter</button>
      </div>
    </div>

    <!-- Right: Editor + Preview/Logs -->
    <div class="col split">
      <div class="panel">
        <div class="tabs" id="tabs"></div>
        <div id="editor"></div>
      </div>
      <div class="subpanel">
        <div class="subcol">
          <div class="toolbar"><strong>Preview</strong><span class="small hint">HTML/CSS/JS live preview</span><span class="right"><button id="btn-refresh" class="pill small">‚ü≥ Refresh</button></span></div>
          <iframe id="preview"></iframe>
        </div>
        <div class="subcol">
          <div class="toolbar"><strong>Debug Log</strong><span class="right"><button id="btn-log-clear" class="pill small">Clear</button></span></div>
          <div class="log" id="log"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Settings -->
<div class="modal-backdrop" id="modal">
  <div class="modal">
    <header><div class="brand"><span class="badge">Settings</span><div class="status small">Customize</div></div></header>
    <div class="body">
      <div class="grid2">
        <div class="field"><label>Project Name</label><input id="set-project" placeholder="my-webcloud-app" /></div>
        <div class="field"><label>Auto Save on Run</label><input id="set-autosave" type="checkbox" /></div>
      </div>
      <div class="grid2">
        <div class="field"><label>Node.js (WebContainer) API URL</label><input id="set-wc" value="https://unpkg.com/@webcontainer/api/dist/index.js" /></div>
        <div class="field"><label>Monaco CDN</label><input id="set-monaco" value="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js" /></div>
      </div>
      <div class="field">
        <label>C Compiler (WASM) Loader URL (‰ªªÊÑè). Ëá™Âãï„É≠„Éº„ÉâÂ§±ÊïóÊôÇ„ÅØ„Åì„Åì„Å´ÊúâÂäπ„Å™„Éó„É©„Ç∞„Ç§„É≥„ÅÆ CDN URL „ÇíË≤º„Å£„Å¶„Åè„Å†„Åï„ÅÑ.</label>
        <input id="set-c" placeholder="https://example.com/c-compiler-plugin.js" />
      </div>
      <div class="field">
        <label>Custom Command (name:js)</label>
        <textarea id="set-usercmd" rows="3" placeholder="greet: (ctx)=>ctx.out('hello')"></textarea>
      </div>
      <div class="grid2">
        <button id="btn-save-settings" class="pill">Save Settings</button>
        <button id="btn-reset-all" class="pill danger">Factory Reset</button>
      </div>
      <div class="hint">C„Éó„É©„Ç∞„Ç§„É≥„ÅØËá™Âãï„ÅßË§áÊï∞ÂÄôË£úURL„ÇíÈ†ÜÁï™„Å´Ë©¶„Åó„Åæ„Åô„ÄÇÂ§±Êïó„Åó„ÅüÂ†¥Âêà„ÅØ‰∏ä„ÅÆÊ¨Ñ„Å´„Éó„É©„Ç∞„Ç§„É≥URL„ÇíË≤º„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</div>
    </div>
  </div>
</div>

<!-- ÂÆüË£Ö„Çπ„ÇØ„É™„Éó„Éà -->
<script>
  window.addEventListener('DOMContentLoaded', () => {
/* ---------------------------
   IndexedDB helpers
---------------------------- */
const DB_NAME='webcloud-db', DB_VER=2;
let idb;
const openDB = ()=>new Promise((res,rej)=>{
  const r=indexedDB.open(DB_NAME, DB_VER);
  r.onupgradeneeded = e => {
    const db = e.target.result;
    if(!db.objectStoreNames.contains('kv')) db.createObjectStore('kv');
    if(!db.objectStoreNames.contains('files')) db.createObjectStore('files');
    if(!db.objectStoreNames.contains('cmds')) db.createObjectStore('cmds');
    if(!db.objectStoreNames.contains('settings')) db.createObjectStore('settings');
  };
  r.onsuccess = e => { idb = e.target.result; res(idb); };
  r.onerror = e => rej(e);
});
const idbGet = (store,key)=>new Promise((res,rej)=>{ const tx=idb.transaction(store,'readonly').objectStore(store).get(key); tx.onsuccess=e=>res(e.target.result); tx.onerror=rej; });
const idbSet = (store,key,val)=>new Promise((res,rej)=>{ const tx=idb.transaction(store,'readwrite').objectStore(store).put(val, key); tx.onsuccess=()=>res(); tx.onerror=rej; });
const idbDel = (store,key)=>new Promise((res,rej)=>{ const tx=idb.transaction(store,'readwrite').objectStore(store).delete(key); tx.onsuccess=()=>res(); tx.onerror=rej; });
const idbAll = (store)=>new Promise((res,rej)=>{ const st = idb.transaction(store,'readonly').objectStore(store); const rk=st.getAllKeys(), rv=st.getAll(); let keys; rk.onsuccess=e=>keys=e.target.result; rv.onsuccess=e=>res({keys, vals: e.target.result}); rk.onerror=rv.onerror=rej; });

/* ---------------------------
   UI helpers
---------------------------- */
const term = document.getElementById('terminal'), input = document.getElementById('input'), btnEnter = document.getElementById('btn-enter');
const btnRun = document.getElementById('btn-run'), btnPreview = document.getElementById('btn-preview'), btnSave = document.getElementById('btn-save');
const btnRefresh = document.getElementById('btn-refresh'), btnLogClear = document.getElementById('btn-log-clear'), logEl = document.getElementById('log');
const tabsEl = document.getElementById('tabs'), statusNode = document.getElementById('status-node'), statusC = document.getElementById('status-c');
const modal = document.getElementById('modal'), btnSettings = document.getElementById('btn-settings');

function out(text, cls=''){ const d=document.createElement('div'); d.className='term-line'; d.innerHTML = cls? `<span class="${cls}">${text}</span>`:text; term.appendChild(d); term.scrollTop = term.scrollHeight; }
function promptLine(t){ out(`<span class="prompt">$</span> ${t}`); }
function logLine(text, cls=''){ const d=document.createElement('div'); if(cls) d.className=cls; d.textContent = text; logEl.appendChild(d); logEl.scrollTop = logEl.scrollHeight; }
function setStatusNode(t,cls='ok'){ statusNode.innerHTML = `Node: <span class="${cls}">${t}</span>`; }
function setStatusC(t,cls='ok'){ statusC.innerHTML = `C: <span class="${cls}">${t}</span>`; }
function showModal(show){ modal.style.display = show ? 'grid' : 'none'; }

/* ---------------------------
   Monaco Editor
---------------------------- */
let editor, currentFile;
const DEFAULT_FILES = {
  '/index.html': `<!doctype html>
<html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>WebCloud App</title><link rel="stylesheet" href="./style.css"></head><body><h1>Hello WebCloud üëã</h1><p id="msg">Edit and ‚ñ∂ Run.</p><script src="./script.js"></script></body></html>`,
  '/style.css': `body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; padding:20px } h1{ color:#0ea5e9 }`,
  '/script.js': `document.getElementById('msg').textContent = 'Time: ' + new Date().toLocaleString();`,
  '/app.js': `import fs from 'fs'; console.log('Node running in WebContainer'); fs.writeFileSync('hello.txt','hello from webcontainer');`,
  '/main.c': `#include <stdio.h>\nint main(){ printf("Hello from C!\\n"); return 0; }`
};

function setupMonaco(){
  require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' } });
  require(['vs/editor/editor.main'], async function(){
    editor = monaco.editor.create(document.getElementById('editor'), { value:'', language:'html', theme:'vs-dark', fontSize:14, minimap:{enabled:false}, automaticLayout:true });
    await loadFilesToEditorTabs();
  });
}

async function loadFilesToEditorTabs(){
  const { keys } = await idbAll('files');
  if(!keys || keys.length===0){ for(const [k,v] of Object.entries(DEFAULT_FILES)) await idbSet('files',k,v); }
  const all = await idbAll('files');
  tabsEl.innerHTML = '';
  all.keys.forEach((path,i)=>{ const tab=document.createElement('div'); tab.className='tab'+(i===0?' active':''); tab.textContent=path.replace(/^\//,''); tab.onclick=()=>openFile(path); tabsEl.appendChild(tab); });
  openFile(all.keys[0]);
}

async function openFile(path){
  currentFile = path;
  [...tabsEl.children].forEach(t=>t.classList.remove('active'));
  const idx = [...tabsEl.children].findIndex(t=>t.textContent===path.replace(/^\//,''));
  if(idx>=0) tabsEl.children[idx].classList.add('active');
  const content = await idbGet('files', path);
  const lang = path.endsWith('.js') ? 'javascript' : path.endsWith('.css') ? 'css' : path.endsWith('.c') ? 'c' : 'html';
  editor.setValue(content || ''); monaco.editor.setModelLanguage(editor.getModel(), lang);
}

async function saveCurrent(){ if(!currentFile) return; await idbSet('files', currentFile, editor.getValue()); }

/* ---------------------------
   Preview
---------------------------- */
function refreshPreview(){
  const iframe = document.getElementById('preview');
  (async ()=>{
    const html = await idbGet('files','/index.html') || '';
    const css  = await idbGet('files','/style.css') || '';
    const js   = await idbGet('files','/script.js') || '';
    const doc = `<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><style>${css}</style></head><body>${html.replace(/<\\/?(html|head|body)>/g,'')}<script>try{${js}}catch(e){console.error(e)}</script></body></html>`;
    iframe.srcdoc = doc;
  })();
}

/* ---------------------------
   WebContainer (Node) boot
---------------------------- */
let webcontainer, wcApiUrl = 'https://unpkg.com/@webcontainer/api/dist/index.js';
async function bootWebContainer(){
  try{
    const mod = await import(/* @vite-ignore */ wcApiUrl);
    const { WebContainer } = mod;
    webcontainer = await WebContainer.boot();
    setStatusNode('ready','ok'); await mountToWebContainer();
  }catch(e){
    setStatusNode('failed','err'); out('Node/WebContainer boot failed. Check Settings.','err'); console.error(e);
  }
}
async function mountToWebContainer(){
  if(!webcontainer) return;
  const { keys, vals } = await idbAll('files');
  const tree = {};
  for(let i=0;i<keys.length;i++) setNested(tree, keys[i], vals[i]);
  await webcontainer.mount(tree);
}
function setNested(root, path, content){
  const parts = path.split('/').filter(Boolean); let node = root;
  for(let i=0;i<parts.length-1;i++){ const p=parts[i]; node[p]=node[p]||{}; node=node[p]; }
  node[parts.at(-1)] = { file: { contents: content } };
}
async function wcSpawn(cmd,args,onData){
  const proc = await webcontainer.spawn(cmd,args);
  proc.output.pipeTo(new WritableStream({ write(d){ onData && onData(d); } }));
  const exitCode = await proc.exit; return exitCode;
}

/* ---------------------------
   C plugin auto-loader (CDN)
   - Ë©¶Ë°åÈ†Ü„Å´ÂÄôË£úURL„Çí„É≠„Éº„Éâ
   - ÊàêÂäüÊôÇ„Å´ window.compileC „ÅåÊèê‰æõ„Åï„Çå„Çã„Åì„Å®„ÇíÊúüÂæÖ
---------------------------- */
let cReady = false;
const AUTO_CANDIDATES = [
  // Ë©¶Ë°åÂÄôË£ú ‚Äî ÂÆüÈ®ìÁöÑ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆÂÖ¨Èñã„Éö„Éº„Ç∏„Å™„Å©„Çí„Åì„Åì„Å´ÁΩÆ„ÅèÔºàÊàêÂäü„ÅØÈÖçÂ∏ÉÂÅ¥Ê¨°Á¨¨Ôºâ
  // ‰æãÔºàÂèÇËÄÉÔºâÔºö l u p y u e n „ÅåÂÖ¨Èñã„Åó„Å¶„ÅÑ„Çã tcc-wasm „ÅÆ GitHub PagesÔºàÂÆüË°å„Éï„Ç°„Ç§„É´„ÅÆÊßãÊàê„Å´‰æùÂ≠ò„Åó„Åæ„ÅôÔºâ
  'https://lupyuen.github.io/tcc-riscv32-wasm/tcc-wasm-wrapper.js',
  // „Çà„Åè‰Ωø„Çè„Çå„ÇãCDN„ÅÆ„Éë„Çø„Éº„É≥Ôºà„Éó„É©„Ç∞„Ç§„É≥Êèê‰æõËÄÖ„ÅåÂÖ¨Èñã„Åó„Å¶„ÅÑ„Çå„Å∞ÊàêÂäü„Åô„ÇãÔºâ
  'https://cdn.jsdelivr.net/gh/lupyuen/tcc-riscv32-wasm@gh-pages/tcc-wasm-wrapper.js',
  // „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄÔºà„É¶„Éº„Ç∂„Éº„Åå„Åì„Åì„Å´ÊúâÂäπ„Å™ plugin.js „ÇíË≤º„Çå„Å∞Âãï„ÅèÔºâ
  // 'https://example.com/your-c-plugin.js'
];

async function tryLoadScript(url, isModule=true){
  return new Promise((resolve,reject)=>{
    try{
      const s = document.createElement('script');
      s.src = url;
      if(isModule) s.type = 'module';
      s.async = true;
      s.onload = ()=>resolve(true);
      s.onerror = ()=>reject(new Error('load error: '+url));
      document.head.appendChild(s);
    }catch(e){ reject(e); }
  });
}

async function loadCPluginAuto(){
  // 1) Êó¢„Å´Â≠òÂú®„Åô„Çå„Å∞Âç≥ ready
  if(typeof window.compileC === 'function'){ cReady = true; setStatusC('ready','ok'); return true; }
  // 2) Settings‰∏ä„ÅÆÊâãÂãïURL„Åå„ÅÇ„Çå„Å∞ÊúÄÂÑ™ÂÖà
  const manual = await idbGet('settings','c-url');
  if(manual){
    try{
      await import(/* @vite-ignore */ manual);
      if(typeof window.compileC === 'function'){ cReady = true; setStatusC('ready','ok'); out('C plugin loaded from Settings.','ok'); return true; }
    }catch(e){ console.warn('manual C plugin load failed', e); }
  }
  // 3) ÂÄôË£ú„ÇíÈ†Ü„Å´Ë©¶Ë°å (module import „ÅãÈùû module script„Å®„Åó„Å¶)
  for(const u of AUTO_CANDIDATES){
    if(!u) continue;
    try{
      // Try import first (as module)
      try { await import(/* @vite-ignore */ u); }
      catch(e){ // fallback: inject as non-module
        await tryLoadScript(u,false);
      }
      if(typeof window.compileC === 'function'){ cReady = true; setStatusC('ready','ok'); out('C plugin auto-loaded: '+u,'ok'); return true; }
    }catch(e){ console.warn('auto C candidate failed', u, e); }
  }
  // 4) all failed
  cReady = false; setStatusC('not found','warn');
  out('C„Ç≥„É≥„Éë„Ç§„É©Ëá™Âãï„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇSettings„Åß„Éó„É©„Ç∞„Ç§„É≥URL„ÇíÊåáÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ','warn');
  out('ÊúüÂæÖAPI: window.compileC(source) => Promise<string | { stdout, stderr, exitCode }>', 'hint');
  return false;
}

/* ---------------------------
   Settings
---------------------------- */
const SKEYS = { project:'project-name', c:'c-url', wc:'wc-url', monaco:'monaco-cdn', autosave:'autosave' };
async function loadSettings(){
  const proj = (await idbGet('settings',SKEYS.project)) || 'my-webcloud-app';
  const c = (await idbGet('settings',SKEYS.c)) || '';
  const wc = (await idbGet('settings',SKEYS.wc)) || wcApiUrl;
  const mon = (await idbGet('settings',SKEYS.monaco)) || 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js';
  const autosave = (await idbGet('settings',SKEYS.autosave)) || false;
  document.getElementById('set-project').value = proj;
  document.getElementById('set-c').value = c;
  document.getElementById('set-wc').value = wc;
  document.getElementById('set-monaco').value = mon;
  document.getElementById('set-autosave').checked = !!autosave;
  wcApiUrl = wc;
}
async function saveSettings(){
  await idbSet('settings',SKEYS.project, document.getElementById('set-project').value.trim());
  await idbSet('settings',SKEYS.c, document.getElementById('set-c').value.trim());
  await idbSet('settings',SKEYS.wc, document.getElementById('set-wc').value.trim());
  await idbSet('settings',SKEYS.monaco, document.getElementById('set-monaco').value.trim());
  await idbSet('settings',SKEYS.autosave, document.getElementById('set-autosave').checked);
  showModal(false); out('Settings saved.','ok');
  // reflect change: reload C plugin if URL updated
  setStatusC('loading‚Ä¶','warn'); window.compileC = undefined; cReady=false; loadCPluginAuto();
}
async function factoryReset(){ const req=indexedDB.deleteDatabase(DB_NAME); req.onsuccess=()=>location.reload(); req.onerror=()=>alert('Reset failed'); }

/* ---------------------------
   CLI core + builtins
---------------------------- */
let history = [], hPtr = 0;
const builtins = {}, userCmds = {};
const ctxApi = { out:(t)=>out(t), log:(t)=>logLine(t), readFile:(p)=>idbGet('files',p), writeFile:(p,c)=>idbSet('files',p,c), delFile:(p)=>idbDel('files',p), listFiles:()=>idbAll('files'), settingsGet:(k)=>idbGet('settings',k), settingsSet:(k,v)=>idbSet('settings',k,v), runNode, npmInstall };

function registerBuiltin(name, fn){ builtins[name]=fn; }
function registerUserCmd(name, fn){ userCmds[name]=fn; }
function parse(cmdline){ const args=[]; let cur='', inQ=false, q='"'; for(let i=0;i<cmdline.length;i++){ const ch=cmdline[i]; if(!inQ && /\s/.test(ch)){ if(cur){args.push(cur); cur='';} continue; } if(ch==='"'||ch=="'"){ if(!inQ){ inQ=true; q=ch; continue; } else if(q===ch){ inQ=false; continue; } } cur+=ch; } if(cur) args.push(cur); return args; }
async function run(cmdline){ if(!cmdline.trim()) return; promptLine(cmdline); const args=parse(cmdline); const name=args.shift(); const ctx={ args, line:cmdline, out, log:logLine, api:ctxApi }; try{ if(builtins[name]) await builtins[name](ctx); else if(userCmds[name]) await userCmds[name](ctx); else out(`Unknown command: ${name}. Try 'help'.`,'warn'); }catch(e){ out(String(e),'err'); console.error(e); } }

/* builtins */
registerBuiltin('help', async ({out})=>{
  out(`Commands:
  help                Show help
  clear               Clear terminal
  ls                  List files
  cat <path>          Show file
  edit <path>         Open in editor (creates if missing)
  save                Save current editor buffer
  fetch <url> [method] [jsonBody]
  node <file.js>      Run with Node (WebContainer)
  npm <args...>       npm command in Node env
  run                 Refresh preview
  c:run               Compile & run C (requires plugin)
  command add <name> <js-fn>  Add user command
  command list        List user commands
  settings            Open Settings
`);
});
registerBuiltin('clear', async ()=>{ term.innerHTML=''; });
registerBuiltin('ls', async ({out})=>{ const {keys} = await idbAll('files'); keys.forEach(k=>out(k)); });
registerBuiltin('cat', async ({args,out})=>{ const p=args[0]; if(!p) return out('Usage: cat <path>','warn'); const v=await idbGet('files',p); out(v==null? '(not found)': v); });
registerBuiltin('edit', async ({args,out})=>{ const p=args[0]; if(!p) return out('Usage: edit <path>','warn'); const v=await idbGet('files',p); if(v==null) await idbSet('files',p,''); await loadFilesToEditorTabs(); await openFile(p); out(`Opened ${p}`); });
registerBuiltin('save', async ({out})=>{ await saveCurrent(); out('Saved.','ok'); });
registerBuiltin('fetch', async ({args,out})=>{ const url=args[0]; if(!url) return out('Usage: fetch <url>','warn'); const method=(args[1]||'GET').toUpperCase(); let body=null; if(args[2]){ try{ body=JSON.parse(args[2]); }catch{ body=args[2]; } } try{ const res = await fetch(url,{method,headers:body?{'Content-Type':'application/json'}:undefined,body:body?(typeof body==='string'?body:JSON.stringify(body)):undefined}); const text = await res.text(); out(`Status: ${res.status}`); out(text); }catch(e){ out('Fetch error: '+e,'err'); } });

async function runNode(file='/app.js'){ if(!webcontainer){ out('Node not ready.','warn'); return; } await mountToWebContainer(); out(`node ${file}`); await wcSpawn('node',[file],(d)=>out(d)); }
registerBuiltin('node', async ({args})=>{ const f=args[0]||'/app.js'; const p=f.startsWith('/')?f:('/'+f); runNode(p); });

async function npmInstall(args){ if(!webcontainer){ out('Node not ready.','warn'); return 1; } await mountToWebContainer(); out(`npm ${args.join(' ')}`); return await wcSpawn('npm', args, (d)=>out(d)); }
registerBuiltin('npm', async ({args,out})=>{ if(args.length===0) return out('Usage: npm <args...>','warn'); await npmInstall(args); });

registerBuiltin('run', async ({})=>{ const autosave = await idbGet('settings','autosave'); if(autosave) await saveCurrent(); refreshPreview(); out('Preview refreshed.','ok'); });

registerBuiltin('c:run', async ({out})=>{
  if(!cReady){ out('C plugin not loaded. Check Settings.','warn'); return; }
  try{
    const src = await idbGet('files','/main.c') || '';
    out('Compiling C‚Ä¶');
    const res = await window.compileC ? await window.compileC(src) : 'No compileC';
    if(typeof res === 'string') out(res);
    else { if(res.stdout) out(res.stdout); if(res.stderr) out(res.stderr,'err'); if('exitCode' in res) out('exit '+res.exitCode); }
  }catch(e){ out('C compile error: '+e,'err'); }
});

registerBuiltin('command', async ({args,out})=>{
  const sub=args[0];
  if(sub==='add'){
    const name=args[1]; const code=args.slice(2).join(' ');
    if(!name||!code) return out("Usage: command add <name> <js-fn>","warn");
    try{ const fn = eval(code); if(typeof fn!=='function') throw new Error('Not a function'); await idbSet('cmds',name,code); userCmds[name]=fn; out(`Added ${name}`,'ok'); }catch(e){ out('Invalid function: '+e,'err'); }
  } else if(sub==='list'){ const all = await idbAll('cmds'); if(!all.keys||all.keys.length===0) return out('(no user commands)'); all.keys.forEach(k=>out('- '+k)); }
  else out("Usage: command add/list",'warn');
});
registerBuiltin('settings', async ({})=> showModal(true) );

/* ---------------------------
   Input handling & completion
---------------------------- */
const completions = ['help','clear','ls','cat','edit','save','fetch','node','npm','run','c:run','command add','command list','settings'];
function complete(text){ const cand = completions.concat(Object.keys(userCmds)).filter(c=>c.startsWith(text)); if(cand.length===1) return cand[0]+' '; if(cand.length>1) out(cand.join('  '),'hint'); return text; }
input.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ const v=input.value; history.push(v); hPtr=history.length; run(v); input.value=''; } else if(e.key==='ArrowUp'){ if(hPtr>0){ hPtr--; input.value=history[hPtr]||''; input.setSelectionRange(input.value.length,input.value.length);} } else if(e.key==='ArrowDown'){ if(hPtr<history.length){ hPtr++; input.value=history[hPtr]||''; input.setSelectionRange(input.value.length,input.value.length);} } else if(e.key==='Tab'){ e.preventDefault(); input.value = complete(input.value); } });
btnEnter.onclick = ()=>{ const v=input.value; history.push(v); hPtr=history.length; run(v); input.value=''; };

/* ---------------------------
   Buttons wiring
---------------------------- */
btnRun.onclick = ()=>run('run');
btnPreview.onclick = ()=>refreshPreview();
btnSave.onclick = ()=>saveCurrent().then(()=>out('Saved.','ok'));
btnRefresh.onclick = ()=>refreshPreview();
btnLogClear.onclick = ()=>{ logEl.innerHTML=''; };
btnSettings.onclick = ()=>{ loadSettings().then(()=>showModal(true)); };
document.getElementById('btn-save-settings').onclick = saveSettings;
document.getElementById('btn-reset-all').onclick = ()=>{ if(confirm('Factory reset?')) factoryReset(); };

/* ---------------------------
   Bootstrap
---------------------------- */
(async function boot(){
  await openDB();
  await loadSettings();
  setupMonaco();
  out('WebCloud ready. Type "help" to begin.','ok');

  // load user cmds
  const all = await idbAll('cmds'); if(all.keys) for(let i=0;i<all.keys.length;i++){ try{ userCmds[all.keys[i]] = eval(all.vals[i]); }catch(e){} }

  // Node
  bootWebContainer();

  // Try to auto-load C plugin
  await loadCPluginAuto();
})();
});
</script>
</body>
</html>
