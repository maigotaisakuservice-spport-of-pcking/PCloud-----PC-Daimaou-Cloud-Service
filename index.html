<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WebCloud IDE & CLI â€” Node + C (CDN auto)</title>
<style>
/* --- Theme Variables --- */
:root {
  --bg: #0b0f14; --panel: #121927; --panel2: #0f1520;
  --txt: #e6edf3; --sub: #a8b3bf; --acc: #00d4ff;
  --ok: #6ee7b7; --warn: #fbbf24; --err: #f87171;
  --border: #1c2735; --muted: #202b3a;
  --btn-hover-bg: #223349;
  --danger-bg: #36161a; --danger-border: #5b1c23;
  --prompt: #86efac;
  --badge-txt: #031018;
}
body.light-theme {
  --bg: #ffffff; --panel: #f0f2f5; --panel2: #e8ecf0;
  --txt: #1f2328; --sub: #57606a; --acc: #0969da;
  --ok: #1a7f37; --warn: #9a6700; --err: #d1242f;
  --border: #d0d7de; --muted: #f6f8fa;
  --btn-hover-bg: #eef0f2;
  --danger-bg: #fbeceb; --danger-border: #d1242f;
  --prompt: #1a7f37;
  --badge-txt: #ffffff;
}

/* --- Base Styles --- */
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--txt);font-family:ui-monospace,Menlo,Consolas,monospace}
.layout{display:grid;grid-template-rows:48px 1fr;height:100%}
header{display:flex;align-items:center;justify-content:space-between;padding:0 12px;background:linear-gradient(180deg,var(--panel),var(--panel2));border-bottom:1px solid var(--border)}
.brand{display:flex;align-items:center;gap:10px}
.badge{padding:2px 8px;border-radius:999px;font-size:12px;background:linear-gradient(90deg,#00d4ff,#8b5cf6);color:var(--badge-txt);font-weight:700}
.controls{display:flex;gap:8px;align-items:center}
button{background:var(--muted);color:var(--txt);border:1px solid var(--border);padding:8px 10px;border-radius:12px;cursor:pointer;font-weight:600}
button:hover{background:var(--btn-hover-bg)}.pill{border-radius:999px}
.main{display:grid;grid-template-columns:240px 1fr 1fr;height:calc(100vh - 48px)}
.col{border-right:1px solid var(--border);overflow:hidden; display: flex; flex-direction: column;}.col:last-child{border-right:none}
.panel{height:100%;display:flex;flex-direction:column}
.titlebar{height:36px;display:flex;align-items:center;gap:8px;padding:0 10px;border-bottom:1px solid var(--border);background:var(--panel)}
.title{font-weight:700;color:var(--sub)}
.terminal{flex:1;background:var(--bg);padding:10px;overflow:auto}.term-line{white-space:pre-wrap;margin:0}.prompt{color:var(--prompt)}
.inputbar{border-top:1px solid var(--border);display:flex;gap:8px;padding:8px;background:var(--panel)}
.inputbar input{flex:1;background:var(--muted);border:1px solid var(--border);color:var(--txt);padding:10px;border-radius:10px}
.split{display:grid;grid-template-rows:1fr 42%;height:100%}
#editor{height:100%;width:100%;background:var(--bg)}
.tabs{display:flex;gap:8px;padding:8px;border-bottom:1px solid var(--border);background:var(--panel2)}
.tab{display:flex;align-items:center;justify-content:space-between;padding:6px 10px;border-radius:10px;cursor:pointer;background:var(--panel);border:1px solid var(--border);color:var(--sub)}
.tab.active{background:var(--bg);color:var(--txt)}
.tab .close-btn { margin-left: 8px; padding: 0 4px; border-radius: 4px; cursor: pointer; font-weight: bold; }
.tab .close-btn:hover { background: var(--danger-bg); color: var(--err); }
.subpanel{border-top:1px solid var(--border);background:var(--muted);display:grid;grid-template-columns:55% 45%}
.subcol{display:flex;flex-direction:column;border-right:1px solid var(--border);overflow:hidden}.subcol:last-child{border-right:none}
.toolbar{padding:6px 8px;display:flex;gap:8px;border-bottom:1px solid var(--border);background:var(--panel2)}
.small{font-size:12px}.hint{color:var(--sub);font-size:12px}
#preview, .log {flex:1;border:0;background:var(--bg);padding:10px;overflow:auto}
#git-status-container { background: var(--bg); border: 1px solid var(--border) !important; border-radius: 4px; padding: 5px; flex: 1; overflow-y: auto; }
.right{margin-left:auto}
.modal-backdrop{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.5)}
.modal{width:min(820px,96vw);background:var(--panel);border:1px solid var(--border);border-radius:16px;overflow:hidden}
.modal header{padding:10px 12px; background: var(--panel2)}
.modal .body{padding:12px;display:grid;gap:10px}
.field{display:grid;gap:6px}.field label{font-size:12px;color:var(--sub)}
.field input,.field textarea{background:var(--muted);border:1px solid var(--border);color:var(--txt);padding:10px;border-radius:10px;width:100%}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.danger{background:var(--danger-bg);border-color:var(--danger-border);color:var(--txt)}

/* --- AI Panel Styles --- */
.ai-panel {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 450px;
  height: 600px;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 16px;
  display: none; /* Initially hidden */
  flex-direction: column;
  z-index: 1000;
  box-shadow: 0 10px 25px rgba(0,0,0,0.3);
  resize: both;
  overflow: hidden;
  min-width: 300px;
  min-height: 400px;
}
.ai-panel-header {
  padding: 10px 12px;
  background: var(--panel2);
  cursor: move;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: bold;
}
.ai-panel-body {
  flex: 1;
  padding: 12px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.ai-panel-footer {
  padding: 10px;
  border-top: 1px solid var(--border);
}
.ai-panel-footer textarea {
  width: 100%;
  background: var(--muted);
  border: 1px solid var(--border);
  color: var(--txt);
  padding: 10px;
  border-radius: 10px;
  resize: vertical;
}
.ai-chat-bubble {
  padding: 8px 12px;
  border-radius: 12px;
  max-width: 85%;
}
.ai-chat-bubble.user {
  background: var(--acc);
  color: var(--badge-txt);
  align-self: flex-end;
  border-bottom-right-radius: 2px;
}
.ai-chat-bubble.bot {
  background: var(--muted);
  align-self: flex-start;
  border-bottom-left-radius: 2px;
  white-space: pre-wrap;
}
#ai-model-selector-panel {
  background: var(--muted);
  border: 1px solid var(--border);
  color: var(--txt);
  border-radius: 6px;
  padding: 2px;
}
</style>

<!-- Monaco Editor ãƒ­ãƒ¼ãƒ€ãƒ¼ -->
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/v86/build/libv86.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/treejs/dist/treejs.css" />
<script src="https://cdn.jsdelivr.net/npm/treejs/dist/tree.min.js"></script>
<script src="https://unpkg.com/@isomorphic-git/lightning-fs"></script>
<script src="https://unpkg.com/isomorphic-git"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css" />
<script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>
<script type="module" src="https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.2.46/lib/index.js"></script>
<script type="module">
  // The library doesn't have a UMD build, so we import it as a module
  // and attach it to the window object to make it globally accessible like the other libraries.
  import { OAuth2AuthCodePkceClient } from 'https://esm.sh/oauth2-pkce';
  window.OAuth2AuthCodePkceClient = OAuth2AuthCodePkceClient;
</script>
<script type="module">
  // Import Y.js and its bindings and attach them to the window object
  import * as Y from 'https://cdn.jsdelivr.net/npm/yjs/+esm';
  import { WebsocketProvider } from 'https://cdn.jsdelivr.net/npm/y-websocket/+esm';
  import { MonacoBinding } from 'https://cdn.jsdelivr.net/npm/y-monaco/+esm';
  window.Y = Y;
  window.WebsocketProvider = WebsocketProvider;
  window.MonacoBinding = MonacoBinding;
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
<div class="layout">
  <header>
    <div class="brand">
      <span class="badge">WebCloud</span>
      <div>IDE & CLI</div>
      <div class="status" id="status-node">Node: <span class="warn">èµ·å‹•ä¸­â€¦</span></div>
      <div class="status" id="status-db">ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸: <span class="ok">IndexedDB</span></div>
    </div>
    <div class="controls">
      <div id="github-auth-container">
        <button id="btn-github-login" class="pill">Login with GitHub</button>
        <span id="github-user" style="display: none;"></span>
        <button id="btn-github-logout" class="pill" style="display: none;">Logout</button>
      </div>
      <button id="btn-settings" class="pill">âš™ è¨­å®š</button>
      <button id="btn-vm" class="pill">ğŸ§ VMèµ·å‹•</button>
      <button id="btn-github-clone" class="pill">Clone</button>
      <button id="btn-github-new" class="pill">New Repo</button>
      <button id="btn-workspaces" class="pill">ğŸ—‚ï¸ Workspaces</button>
      <button id="btn-new-project" class="pill">âœ¨ New Project</button>
      <button id="btn-collaboration" class="pill">ğŸ¤ å…±æœ‰</button>
      <button id="btn-upload" class="pill">ğŸ“¤ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
      <button id="btn-download" class="pill">ğŸ“¥ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      <button id="btn-export-zip" class="pill">ğŸ“¦ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ZIP</button>
      <button id="btn-save" class="pill">ğŸ’¾ ä¿å­˜</button>
      <button id="btn-run" class="pill">â–¶ å®Ÿè¡Œ</button>
      <button id="btn-preview" class="pill">ğŸŒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
      <button id="btn-ai-panel" class="pill">ğŸ¤– AI</button>
      <button id="btn-deploy" class="pill">ğŸš€ Deploy</button>
    </div>
    <input type="file" id="file-upload-input" style="display: none;" />
  </header>

  <div class="main">
    <!-- å·¦: ãƒ•ã‚¡ã‚¤ãƒ«ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ãƒ¼ & Git -->
    <div class="col">
      <div style="flex: 1; overflow-y: auto;">
        <div class="titlebar"><span class="title">ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ãƒ¼</span></div>
        <div id="file-explorer-container" style="padding: 8px;"></div>
      </div>
      <div style="height: 220px; border-top: 1px solid var(--border); display: flex; flex-direction: column;">
        <div class="titlebar"><span class="title">ã‚½ãƒ¼ã‚¹ç®¡ç†</span></div>
        <div id="git-panel" style="padding: 8px; font-size: 12px; display: flex; flex-direction: column; gap: 8px; flex: 1;">
          <textarea id="git-commit-message" placeholder="ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸" rows="3" style="width: 100%; background: var(--bg); color: var(--txt); border: 1px solid var(--border); border-radius: 4px; padding: 4px;"></textarea>
          <div style="display: flex; gap: 8px;">
            <button id="git-commit-button" class="pill small">ã‚³ãƒŸãƒƒãƒˆ</button>
            <button id="git-push-button" class="pill small">ãƒ—ãƒƒã‚·ãƒ¥</button>
            <button id="git-graph-refresh-btn" class="pill small">ã‚°ãƒ©ãƒ•æ›´æ–°</button>
          </div>
          <div id="git-status-container" style="flex: 1; overflow-y: auto; background: #0a0f17; padding: 5px; border: 1px solid var(--border); border-radius: 4px;"></div>
        </div>
      </div>
    </div>

    <!-- ä¸­å¤®: CLI -->
    <div class="col panel">
      <div class="titlebar"><span class="title">ã‚¿ãƒ¼ãƒŸãƒŠãƒ«</span></div>
      <div class="terminal" id="terminal" style="padding: 0;"></div>
    </div>

    <!-- å³: ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ + ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼/ãƒ­ã‚° -->
    <div class="col split">
      <div class="panel">
        <div class="tabs" id="tabs"></div>
        <div id="editor"></div>
      </div>
      <div class="subpanel" style="grid-template-columns: 1fr 1fr 1fr;">
        <div class="subcol">
          <div class="toolbar"><strong>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</strong><span class="small hint">HTML/CSS/JS ãƒ©ã‚¤ãƒ–ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</span><span class="right"><button id="btn-refresh" class="pill small">âŸ³ æ›´æ–°</button></span></div>
          <iframe id="preview"></iframe>
        </div>
        <div class="subcol">
            <div class="toolbar"><strong>Gitã‚°ãƒ©ãƒ•</strong></div>
            <div id="git-graph-container" style="flex: 1; overflow: auto; padding: 10px;"></div>
        </div>
        <div class="subcol">
          <div class="toolbar"><strong>ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</strong><span class="right"><button id="btn-log-clear" class="pill small">ã‚¯ãƒªã‚¢</button></span></div>
          <div class="log" id="log"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- è¨­å®š -->
<div class="modal-backdrop" id="modal">
  <div class="modal">
    <header><div class="brand"><span class="badge">è¨­å®š</span><div class="status small">ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</div></div></header>
    <div class="body">
      <div class="grid2">
        <div class="field"><label>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå</label><input id="set-project" placeholder="my-webcloud-app" /></div>
        <div class="field"><label>å®Ÿè¡Œæ™‚ã«è‡ªå‹•ä¿å­˜</label><input id="set-autosave" type="checkbox" /></div>
      </div>
      <div class="field"><label>ãƒ†ãƒ¼ãƒ</label><button id="btn-toggle-theme" class="pill">ãƒ©ã‚¤ãƒˆ/ãƒ€ãƒ¼ã‚¯åˆ‡ã‚Šæ›¿ãˆ</button></div>
      <div class="field"><label>AIãƒ¢ãƒ‡ãƒ«</label><select id="ai-model-selector-settings"></select></div>
      <div class="field"><label>GitHub OAuth Client ID</label><input id="set-github-client-id" placeholder="Your GitHub OAuth App Client ID" /></div>
      <div class="grid2">
        <div class="field"><label>Node.js (WebContainer) API URL</label><input id="set-wc" value="https://unpkg.com/@webcontainer/api/dist/index.js" /></div>
        <div class="field"><label>Monaco CDN</label><input id="set-monaco" value="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js" /></div>
      </div>
      <div class="field">
        <label>ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’èª­ã¿è¾¼ã‚€ (.js)</label>
        <input type="file" id="load-plugin-input" accept=".js" />
      </div>
      <div class="grid2">
        <button id="btn-save-settings" class="pill">è¨­å®šã‚’ä¿å­˜</button>
        <button id="btn-reset-all" class="pill danger">å·¥å ´å‡ºè·æ™‚ã«ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>
  </div>
</div>

<!-- AI Panel -->
<div class="ai-panel" id="ai-panel">
  <div class="ai-panel-header" id="ai-panel-header">
    <span>ğŸ¤– AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</span>
    <select id="ai-model-selector-panel"></select>
  </div>
  <div class="ai-panel-body" id="ai-panel-body">
    <div class="ai-chat-bubble bot">ã“ã‚“ã«ã¡ã¯ï¼ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ</div>
  </div>
  <div class="ai-panel-footer">
    <textarea id="ai-prompt-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡..." rows="2" style="margin-bottom: 5px;"></textarea>
    <button id="ai-send-prompt-btn" class="pill small">é€ä¿¡</button>
    <button id="ai-gen-command-btn" class="pill small">ã‚³ãƒãƒ³ãƒ‰ç”Ÿæˆ</button>
  </div>
</div>

<!-- VM ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-backdrop" id="modal-vm">
  <style>
    #modal-vm .modal { width: min(1200px, 96vw); height: min(800px, 90vh); display: flex; flex-direction: column; }
    #modal-vm .body { flex: 1; padding: 0; background: black; }
    #screen_container { width: 100%; height: 100%; }
    #screen_container canvas { width: 100%; height: 100%; }
  </style>
  <div class="modal">
    <header>
      <div class="brand"><span class="badge">Linux VM</span><div class="status small">v86 ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿</div></div>
      <button id="btn-vm-close" class="pill small">é–‰ã˜ã‚‹</button>
    </header>
    <div class="body">
      <div id="screen_container">
        <div style="white-space: pre; font: 14px monospace; line-height: 14px"></div>
        <canvas></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Workspaces Modal -->
<div class="modal-backdrop" id="modal-workspaces">
    <div class="modal">
        <header><div class="brand"><span class="badge">ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹</span><div class="status small">ä¿å­˜ãƒ»èª­è¾¼</div></div></header>
        <div class="body">
            <div id="workspaces-list" style="max-height: 200px; overflow-y: auto; margin-bottom: 10px;"></div>
            <div class="field">
                <label>æ–°ã—ã„ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹å:</label>
                <input id="new-workspace-name" placeholder="ä¾‹: my-react-project" />
            </div>
            <button id="btn-save-workspace" class="pill">ç¾åœ¨ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- New Project Modal -->
<div class="modal-backdrop" id="modal-new-project">
    <div class="modal">
        <header><div class="brand"><span class="badge">æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</span><div class="status small">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠ</div></div></header>
        <div class="body" id="new-project-templates">
            <!-- Templates will be injected here by JS -->
        </div>
    </div>
</div>

<!-- å®Ÿè£…ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
<script>
/* ---------------------------
   IndexedDB ãƒ˜ãƒ«ãƒ‘ãƒ¼
---------------------------- */
const DB_NAME='webcloud-db', DB_VER=2;
let idb;
const openDB = ()=>new Promise((res,rej)=>{
  const r=indexedDB.open(DB_NAME, DB_VER);
  r.onupgradeneeded = e => {
    const db = e.target.result;
    if(!db.objectStoreNames.contains('kv')) db.createObjectStore('kv');
    if(!db.objectStoreNames.contains('files')) db.createObjectStore('files');
    if(!db.objectStoreNames.contains('cmds')) db.createObjectStore('cmds');
    if(!db.objectStoreNames.contains('settings')) db.createObjectStore('settings');
    if(!db.objectStoreNames.contains('workspaces')) db.createObjectStore('workspaces');
  };
  r.onsuccess = e => { idb = e.target.result; res(idb); };
  r.onerror = e => rej(e);
});
const idbGet = (store,key)=>new Promise((res,rej)=>{ const tx=idb.transaction(store,'readonly').objectStore(store).get(key); tx.onsuccess=e=>res(e.target.result); tx.onerror=rej; });
const idbSet = (store,key,val)=>new Promise((res,rej)=>{ const tx=idb.transaction(store,'readwrite').objectStore(store).put(val, key); tx.onsuccess=()=>res(); tx.onerror=rej; });
const idbDel = (store,key)=>new Promise((res,rej)=>{ const tx=idb.transaction(store,'readwrite').objectStore(store).delete(key); tx.onsuccess=()=>res(); tx.onerror=rej; });
const idbAll = (store)=>new Promise((res,rej)=>{ const st = idb.transaction(store,'readonly').objectStore(store); const rk=st.getAllKeys(), rv=st.getAll(); let keys; rk.onsuccess=e=>keys=e.target.result; rv.onsuccess=e=>res({keys, vals: e.target.result}); rk.onerror=rv.onerror=rej; });

/* ---------------------------
   ãƒ•ã‚¡ã‚¤ãƒ«ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ãƒ¼
---------------------------- */
let fileTree;

function buildFileHierarchy(files) {
  const root = { name: '/', type: 'dir', children: {} };
  for (const path of files) {
    const parts = path.split('/').filter(p => p);
    let current = root;
    for (let i = 0; i < parts.length; i++) {
      const part = parts[i];
      const isLast = i === parts.length - 1;
      if (!current.children[part]) {
        current.children[part] = {
          name: part,
          type: isLast ? 'file' : 'dir',
          path: '/' + parts.slice(0, i + 1).join('/'),
          children: {},
        };
      }
      current = current.children[part];
    }
  }
  return root;
}

function createTreeNodes(node) {
  const treeNode = new TreeNode(node.name);
  treeNode.path = node.path; // ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ã®ãŸã‚ã«ãƒ‘ã‚¹ã‚’æ·»ä»˜
  if (node.type === 'dir') {
    const children = Object.values(node.children).sort((a, b) => {
      if (a.type !== b.type) return a.type === 'dir' ? -1 : 1;
      return a.name.localeCompare(b.name);
    });
    for (const child of children) {
      treeNode.addChild(createTreeNodes(child));
    }
  } else { // ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ
    treeNode.on('open', () => {
      openFile(treeNode.path);
    });
  }
  return treeNode;
}

async function renderFileTree() {
  const { keys } = await idbAll('files');
  if (!keys) return;

  const hierarchy = buildFileHierarchy(keys);
  const rootNode = createTreeNodes(hierarchy);

  fileTree = new TreeView(rootNode, '#file-explorer-container', { show_root: false });
}

/* ---------------------------
   Git çµ±åˆ
---------------------------- */
async function renderGitGraph() {
    const container = document.getElementById('git-graph-container');
    container.innerHTML = 'Gitã‚°ãƒ©ãƒ•ã‚’ç”Ÿæˆä¸­...';
    try {
        const commits = await git.log({ fs, dir: '/' });
        let html = '';
        for (const commit of commits) {
            html += `<div style="font-family: monospace; white-space: pre; padding-bottom: 5px; border-bottom: 1px solid var(--border);">`;
            html += `<span style="color: var(--warn);">${commit.oid.substring(0, 7)}</span>`;
            html += ` - <span style="color: var(--ok);">${commit.commit.author.name}</span>`;
            html += ` (${new Date(commit.commit.author.timestamp * 1000).toLocaleDateString()})`;
            html += `<br>  ${commit.commit.message}`;
            html += `</div>`;
        }
        container.innerHTML = html;
    } catch (e) {
        container.innerHTML = `Gitã‚°ãƒ©ãƒ•ã®ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${e.message}`;
    }
}

const git = window.isomorphicGit;
const fs = new LightningFS('fs');
const pfs = fs.promises;
const dir = '/';

async function refreshGitStatus() {
  const statusContainer = document.getElementById('git-status-container');
  statusContainer.innerHTML = 'å¤‰æ›´ã‚’ç¢ºèªä¸­...';

  try {
    const rows = await git.statusMatrix({ fs, dir });
    const changedFiles = rows.filter(row => row[1] !== row[2] || row[2] !== row[3]);

    if (changedFiles.length === 0) {
      statusContainer.innerHTML = 'å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
      return;
    }

    let html = '<table>';
    for (const row of changedFiles) {
      const [filepath, , workdir] = row;
      let statusText = '';
      // workdir: 0=å¤‰æ›´ãªã—, 1=è¿½åŠ , 2=å¤‰æ›´, 3=å‰Šé™¤
      if (workdir === 1) statusText = 'æ–°è¦';
      if (workdir === 2) statusText = 'å¤‰æ›´';
      if (workdir === 3) statusText = 'å‰Šé™¤';

      html += `<tr><td style="padding-right: 10px;">${filepath}</td><td>${statusText}</td></tr>`;
    }
    html += '</table>';
    statusContainer.innerHTML = html;

  } catch (e) {
    statusContainer.innerHTML = `Gitã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å–å¾—ã‚¨ãƒ©ãƒ¼: ${e.message}`;
  }
}

async function performCommit() {
  const message = document.getElementById('git-commit-message').value;
  if (!message.trim()) {
    out('ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'err');
    return;
  }

  try {
    out('å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ä¸­...', 'ok');
    const rows = await git.statusMatrix({ fs, dir });
    // ã™ã¹ã¦ã®å¤‰æ›´ï¼ˆæ–°è¦ã€å¤‰æ›´ã€å‰Šé™¤ï¼‰ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
    for (const row of rows) {
      const [filepath, head, workdir] = row;
      if (head !== workdir) { // å¤‰æ›´ãŒã‚ã‚‹å ´åˆ
         if (workdir === 3) { // å‰Šé™¤æ¸ˆã¿
            await git.remove({ fs, dir, filepath });
         } else { // è¿½åŠ ã¾ãŸã¯å¤‰æ›´
            await git.add({ fs, dir, filepath });
         }
      }
    }

    out('ã‚³ãƒŸãƒƒãƒˆä¸­...', 'ok');
    const userId = await getOrSetUserId();
    const sha = await git.commit({
      fs,
      dir,
      message,
      author: {
        name: `user-${userId}`,
        email: `user-${userId}@web.cloud`,
      },
    });

    out(`ã‚³ãƒŸãƒƒãƒˆæˆåŠŸ: ${sha.substring(0, 7)}`, 'ok');
    document.getElementById('git-commit-message').value = '';
    await refreshGitStatus();

  } catch (e) {
    out(`ã‚³ãƒŸãƒƒãƒˆä¸­ã®ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'err');
    console.error(e);
  }
}

async function initGit() {
  await pfs.mkdir(dir).catch(e => {}); // Ignore if dir already exists

  // æ—¢ã«Gitãƒªãƒã‚¸ãƒˆãƒªã‹ç¢ºèª
  const gitignoreExists = await pfs.stat(`${dir}.git/config`).catch(e => false);

  if (!gitignoreExists) {
    out("Gitãƒªãƒã‚¸ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ–°è¦ä½œæˆã—ã¾ã™ã€‚", "ok");
    await git.init({ fs, dir });
    out("æ–°ã—ã„Gitãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆã—ã¾ã—ãŸã€‚", "ok");
  } else {
    out("æ—¢å­˜ã®Gitãƒªãƒã‚¸ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚", "ok");
  }
  await refreshGitStatus();
}

/* ---------------------------
   Workspace Management
---------------------------- */
const workspaceManager = {
    async save(name) {
        if (!name.trim()) {
            alert("ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            return;
        }
        out(`ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã€Œ${name}ã€ã‚’ä¿å­˜ä¸­...`, 'ok');
        try {
            const files = {};
            const allPaths = await pfs.readdir('/');
            for (const path of allPaths) {
                if (path === '.' || path === '..') continue;
                // This is a simplified version, doesn't handle directories yet
                const content = await pfs.readFile(`/${path}`);
                files[`/${path}`] = content;
            }

            const workspaceState = {
                files: files,
                activeFile: currentFile,
                createdAt: new Date().toISOString()
            };
            await idbSet('workspaces', name, workspaceState);
            out(`ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã€Œ${name}ã€ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚`, 'ok');
            this.populateModal();
        } catch (e) {
            out(`ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'err');
        }
    },

    async load(name) {
        if (!confirm(`ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã€Œ${name}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®å¤‰æ›´ã¯å¤±ã‚ã‚Œã¾ã™ã€‚`)) {
            return;
        }
        out(`ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã€Œ${name}ã€ã‚’èª­ã¿è¾¼ã¿ä¸­...`, 'ok');
        try {
            const workspaceState = await idbGet('workspaces', name);
            if (!workspaceState) {
                throw new Error("ä¿å­˜ã•ã‚ŒãŸãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
            }

            // Wipe existing filesystem
            const allFiles = await pfs.readdir('/');
            for (const file of allFiles) {
                if (file !== '.' && file !== '..') {
                    await pfs.rm(`/${file}`, { recursive: true });
                }
            }

            // Load new files
            for (const path in workspaceState.files) {
                await pfs.writeFile(path, workspaceState.files[path]);
            }

            currentFile = workspaceState.activeFile || null;
            await refreshFileUI();
            await initGit();
            out(`ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã€Œ${name}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`, 'ok');
        } catch (e) {
            out(`ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'err');
        } finally {
            document.getElementById('modal-workspaces').style.display = 'none';
        }
    },

    async delete(name) {
        if (!confirm(`æœ¬å½“ã«ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
            return;
        }
        await idbDel('workspaces', name);
        out(`ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`, 'ok');
        this.populateModal();
    },

    async populateModal() {
        const { keys, vals } = await idbAll('workspaces');
        const container = document.getElementById('workspaces-list');
        container.innerHTML = '';
        if (!keys || keys.length === 0) {
            container.innerHTML = 'ä¿å­˜ã•ã‚ŒãŸãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
            return;
        }
        keys.forEach((name, i) => {
            const div = document.createElement('div');
            div.style.display = 'flex';
            div.style.justifyContent = 'space-between';
            div.style.padding = '5px';
            div.style.borderBottom = '1px solid var(--border)';

            const loadBtn = document.createElement('button');
            loadBtn.textContent = `èª­è¾¼: ${name}`;
            loadBtn.className = 'pill small';
            loadBtn.onclick = () => this.load(name);

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'å‰Šé™¤';
            deleteBtn.className = 'pill small danger';
            deleteBtn.onclick = () => this.delete(name);

            div.appendChild(loadBtn);
            div.appendChild(deleteBtn);
            container.appendChild(div);
        });
    }
};


/* ---------------------------
   Project Templates & Export
---------------------------- */
async function exportProjectAsZip() {
    out('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ZIPã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆä¸­...', 'ok');
    const zip = new JSZip();

    async function addFolderToZip(zipFolder, path) {
        const entries = await pfs.readdir(path);
        for (const entry of entries) {
            if (entry === '.' || entry === '..') continue;
            const fullPath = `${path === '/' ? '' : path}/${entry}`;
            const stat = await pfs.stat(fullPath);
            if (stat.isDirectory()) {
                const newFolder = zipFolder.folder(entry);
                await addFolderToZip(newFolder, fullPath);
            } else {
                const content = await pfs.readFile(fullPath);
                zipFolder.file(entry, content);
            }
        }
    }

    try {
        await addFolderToZip(zip, '/');
        const zipContent = await zip.generateAsync({ type: 'blob' });
        const projName = (await idbGet('settings', SKEYS.project)) || 'webcloud-project';

        const a = document.createElement('a');
        a.href = URL.createObjectURL(zipContent);
        a.download = `${projName}.zip`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
        out('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚', 'ok');
    } catch (e) {
        out(`ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ${e.message}`, 'err');
        console.error(e);
    }
}


function populateTemplateModal() {
    const container = document.getElementById('new-project-templates');
    container.innerHTML = '';
    for (const templateId in PROJECT_TEMPLATES) {
        const template = PROJECT_TEMPLATES[templateId];
        const button = document.createElement('button');
        button.className = 'pill';
        button.textContent = template.name;
        button.onclick = () => loadTemplate(templateId);
        container.appendChild(button);
    }
}

async function loadTemplate(templateId) {
    if (!confirm("ç¾åœ¨ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’æ¶ˆå»ã—ã€æ–°ã—ã„ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿä¿å­˜ã•ã‚Œã¦ã„ãªã„å¤‰æ›´ã¯å¤±ã‚ã‚Œã¾ã™ã€‚")) {
        return;
    }

    out(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ${PROJECT_TEMPLATES[templateId].name}ã€ã‚’èª­ã¿è¾¼ã¿ä¸­...`, 'ok');
    try {
        // Wipe existing filesystem
        const allFiles = await pfs.readdir('/');
        for (const file of allFiles) {
            if (file !== '.' && file !== '..') {
                await pfs.rm(`/${file}`, { recursive: true });
            }
        }

        // Load new files
        const templateFiles = PROJECT_TEMPLATES[templateId].files;
        for (const path in templateFiles) {
            await pfs.writeFile(path, templateFiles[path]);
        }

        out('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸã€‚', 'ok');
        currentFile = null; // Reset current file
        await refreshFileUI();
        await initGit(); // Re-initialize git for the new project
    } catch (e) {
        out(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'err');
    } finally {
        modalNewProject.style.display = 'none';
    }
}


/* ---------------------------
   UI ãƒ˜ãƒ«ãƒ‘ãƒ¼
---------------------------- */
const termEl = document.getElementById('terminal');
const btnRun = document.getElementById('btn-run'), btnPreview = document.getElementById('btn-preview'), btnSave = document.getElementById('btn-save');
const btnUpload = document.getElementById('btn-upload'), btnDownload = document.getElementById('btn-download'), fileUploadInput = document.getElementById('file-upload-input');
const btnRefresh = document.getElementById('btn-refresh'), btnLogClear = document.getElementById('btn-log-clear'), logEl = document.getElementById('log');
const tabsEl = document.getElementById('tabs'), statusNode = document.getElementById('status-node');
const modal = document.getElementById('modal'), btnSettings = document.getElementById('btn-settings');
const btnVm = document.getElementById('btn-vm'), modalVm = document.getElementById('modal-vm'), btnVmClose = document.getElementById('btn-vm-close');
const aiPanel = document.getElementById('ai-panel'), aiPanelHeader = document.getElementById('ai-panel-header'), btnAiPanel = document.getElementById('btn-ai-panel');
const modalNewProject = document.getElementById('modal-new-project'), btnNewProject = document.getElementById('btn-new-project');
const modalWorkspaces = document.getElementById('modal-workspaces'), btnWorkspaces = document.getElementById('btn-workspaces');

function out(text, cls=''){ const d=document.createElement('div'); d.className='term-line'; d.innerHTML = cls? `<span class="${cls}">${text}</span>`:text; termEl.appendChild(d); termEl.scrollTop = termEl.scrollHeight; }
function promptLine(t){ out(`<span class="prompt">$</span> ${t}`); }
function logLine(text, cls=''){ const d=document.createElement('div'); if(cls) d.className=cls; d.textContent = text; logEl.appendChild(d); logEl.scrollTop = logEl.scrollHeight; }
function setStatusNode(t,cls='ok'){ statusNode.innerHTML = `Node: <span class="${cls}">${t}</span>`; }
function showModal(show){ modal.style.display = show ? 'grid' : 'none'; }

/* ---------------------------
   Monaco Editor
---------------------------- */
let editor, currentFile;
const PROJECT_TEMPLATES = {
  'vanilla': {
    name: 'Vanilla JS',
    files: {
      '/index.html': `<!doctype html>
<html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>WebCloud App</title><link rel="stylesheet" href="./style.css"></head><body><h1>Hello WebCloud ğŸ‘‹</h1><p id="msg">ç·¨é›†ã—ã¦ â–¶ å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p><script src="./script.js"><\/script></body></html>`,
      '/style.css': `body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; padding:20px } h1{ color:#0ea5e9 }`,
      '/script.js': `document.getElementById('msg').textContent = 'ç¾åœ¨æ™‚åˆ»: ' + new Date().toLocaleString();`,
      '/app.js': `import fs from 'fs'; console.log('WebContainerã§NodeãŒå®Ÿè¡Œä¸­'); fs.writeFileSync('hello.txt','webcontainerã‚ˆã‚Šã“ã‚“ã«ã¡ã¯');`
    }
  },
  'collaboration-server': {
      name: 'Collaboration Server',
      files: {
          '/package.json': `{
  "name": "webcloud-collaboration-server",
  "version": "1.0.0",
  "description": "WebSocket server for Y.js collaboration",
  "main": "server.js",
  "scripts": {
    "start": "node server.js"
  },
  "dependencies": {
    "ws": "^8.17.0",
    "y-websocket": "^2.0.3"
  }
}`,
          '/server.js': `const http = require('http');
const WebSocket = require('ws');
const { setupWSConnection } = require('y-websocket/bin/utils');

const server = http.createServer((request, response) => {
  response.writeHead(200, { 'Content-Type': 'text/plain' });
  response.end('Collaboration server is running');
});

const wss = new WebSocket.Server({ server });

wss.on('connection', (conn, req) => {
  setupWSConnection(conn, req, {});
});

const port = process.env.PORT || 1234;
server.listen(port, () => {
  console.log(\`Collaboration server listening on port \${port}\`);
});`
      }
  },
  'react-vite': {
    name: 'React + Vite',
    files: {
      '/index.html': `<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>React App</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"><\/script>
  </body>
</html>`,
      '/package.json': `{
  "name": "react-vite-app",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0"
  },
  "devDependencies": {
    "@types/react": "^18.2.15",
    "@types/react-dom": "^18.2.7",
    "@vitejs/plugin-react": "^4.0.3",
    "vite": "^4.4.5"
  }
}`,
      '/src/main.jsx': `import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App.jsx'
import './index.css'

ReactDOM.createRoot(document.getElementById('root')).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
)`,
      '/src/App.jsx': `import React from 'react';
function App() {
  return (
    <>
      <h1>Hello from React!</h1>
    </>
  )
}
export default App`,
      '/src/index.css': `body { margin: 2rem; }`
    }
  }
};
const DEFAULT_FILES = PROJECT_TEMPLATES.vanilla.files;

function setupMonaco(){
  require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' } });
  require(['vs/editor/editor.main'], async function(){
    editor = monaco.editor.create(document.getElementById('editor'), { value:'', language:'html', theme:'vs-dark', fontSize:14, minimap:{enabled:false}, automaticLayout:true });

    // ã‚³ãƒãƒ³ãƒ‰ãƒ‘ãƒ¬ãƒƒãƒˆã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
    editor.addAction({ id: 'run-preview', label: 'å®Ÿè¡Œ: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œ', keybindings: [monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter], run: () => run('run') });
    editor.addAction({ id: 'save-file', label: 'ãƒ•ã‚¡ã‚¤ãƒ«: ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜', keybindings: [monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS], run: () => saveCurrent().then(()=>out('ä¿å­˜ã—ã¾ã—ãŸã€‚','ok')) });
    editor.addAction({ id: 'refresh-preview', label: 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼: æ›´æ–°', keybindings: [monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyR], run: () => refreshPreview() });
    editor.addAction({ id: 'launch-vm', label: 'VM: Linux VMã‚’èµ·å‹•', run: () => btnVm.onclick() });
    editor.addAction({ id: 'upload-file', label: 'ãƒ•ã‚¡ã‚¤ãƒ«: ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰', run: () => btnUpload.onclick() });
    editor.addAction({ id: 'download-file', label: 'ãƒ•ã‚¡ã‚¤ãƒ«: ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰', run: () => btnDownload.onclick() });
    editor.addAction({ id: 'open-settings', label: 'ç’°å¢ƒè¨­å®š: è¨­å®šã‚’é–‹ã', run: () => btnSettings.onclick() });
    editor.addAction({ id: 'factory-reset', label: 'ç’°å¢ƒè¨­å®š: å·¥å ´å‡ºè·æ™‚ã«ãƒªã‚»ãƒƒãƒˆ', run: () => { if(confirm('å·¥å ´å‡ºè·æ™‚ã®è¨­å®šã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) factoryReset() } });
    editor.addAction({ id: 'clear-terminal', label: 'ã‚¿ãƒ¼ãƒŸãƒŠãƒ«: ã‚¯ãƒªã‚¢', run: () => term.clear() });
    editor.addAction({
        id: 'ai-explain-code',
        label: 'AI: é¸æŠç¯„å›²ã®ã‚³ãƒ¼ãƒ‰ã‚’è§£èª¬',
        contextMenuGroupId: '9_ai',
        contextMenuOrder: 1,
        run: function(ed) {
            const selection = ed.getModel().getValueInRange(ed.getSelection());
            if (selection) {
                aiPanel.style.display = 'flex';
                aiManager.generateReply(`ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’æ—¥æœ¬èªã§è©³ã—ãè§£èª¬ã—ã¦ãã ã•ã„ï¼š\n\`\`\`\n${selection}\n\`\`\``);
            }
        }
    });
    editor.addAction({
        id: 'ai-refactor-code',
        label: 'AI: é¸æŠç¯„å›²ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°',
        contextMenuGroupId: '9_ai',
        contextMenuOrder: 2,
        run: function(ed) {
            const selection = ed.getModel().getValueInRange(ed.getSelection());
            if (selection) {
                aiPanel.style.display = 'flex';
                aiManager.generateReply(`ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ã€ã‚ˆã‚ŠåŠ¹ç‡çš„ã§èª­ã¿ã‚„ã™ã„ã‚ˆã†ã«ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã—ã¦ãã ã•ã„ã€‚ã‚³ãƒ¼ãƒ‰ã ã‘ã‚’è¿”ã—ã¦ãã ã•ã„ï¼š\n\`\`\`\n${selection}\n\`\`\``);
            }
        }
    });


    if (currentTheme === 'dark') { // This means it was set to 'light' in settings
        toggleTheme();
    }

    await refreshFileUI();
  });
}

async function refreshFileUI() {
  const { keys } = await idbAll('files');
  if (!keys || keys.length === 0) {
    for (const [k, v] of Object.entries(DEFAULT_FILES)) {
      await idbSet('files', k, v);
    }
  }

  const all = await idbAll('files');

  // ã‚¿ãƒ–ã‚’æç”»
  tabsEl.innerHTML = '';
  all.keys.forEach(path => {
    const tab = document.createElement('div');
    tab.className = 'tab';

    const fileName = document.createElement('span');
    fileName.textContent = path.replace(/^\//, '');
    tab.appendChild(fileName);

    const closeBtn = document.createElement('span');
    closeBtn.className = 'close-btn';
    closeBtn.innerHTML = '&times;';
    closeBtn.onclick = (e) => {
      e.stopPropagation(); // Prevent tab click from firing
      closeFile(path);
    };
    tab.appendChild(closeBtn);

    tab.onclick = () => openFile(path);
    tabsEl.appendChild(tab);
  });

  // Set active tab
  if (currentFile) {
    const activeTabIndex = all.keys.indexOf(currentFile);
    if (activeTabIndex !== -1) {
      tabsEl.children[activeTabIndex].classList.add('active');
    }
  } else if (all.keys.length > 0) {
      openFile(all.keys[0]);
  }


  // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ãƒ¼ã®ãƒ„ãƒªãƒ¼ã‚’æç”»
  await renderFileTree();

  // ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚Œã°ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æœ€åˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã
  if (all.keys.length > 0 && !currentFile) {
    openFile(all.keys[0]);
  }
}

async function closeFile(path) {
  const confirmationMessage = `æœ¬å½“ã«ã€Œ${path}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`;
  if (!confirm(confirmationMessage)) {
    return;
  }

  try {
    // If the file to be deleted is currently open, handle switching away from it
    if (path === currentFile) {
      const allTabs = [...tabsEl.children].map(t => '/' + t.firstChild.textContent);
      const currentIndex = allTabs.indexOf(path);

      let nextFileToOpen = null;
      if (allTabs.length > 1) {
        // Try to open the tab to the right, otherwise the one to the left
        nextFileToOpen = allTabs[currentIndex + 1] || allTabs[currentIndex - 1];
      }

      currentFile = nextFileToOpen; // Set currentFile to the next one, or null if it's the last file
      if (!currentFile) {
        editor.setValue('');
        monaco.editor.setModelLanguage(editor.getModel(), 'plaintext');
      }
    }

    await idbDel('files', path);
    out(`ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${path}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`, 'ok');
    await refreshFileUI();
    await refreshGitStatus();
  } catch (e) {
    out(`ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'err');
  }
}

async function openFile(path){
  currentFile = path;
  [...tabsEl.children].forEach(t=>t.classList.remove('active'));
  const idx = [...tabsEl.children].findIndex(t=>t.textContent===path.replace(/^\//,''));
  if(idx>=0) tabsEl.children[idx].classList.add('active');
  const content = await idbGet('files', path);
  const lang = path.endsWith('.js') ? 'javascript' : path.endsWith('.css') ? 'css' : path.endsWith('.c') ? 'c' : 'html';
  editor.setValue(content || ''); monaco.editor.setModelLanguage(editor.getModel(), lang);
}

async function saveCurrent(){ if(!currentFile) return; await idbSet('files', currentFile, editor.getValue()); await refreshGitStatus(); }

/* ---------------------------
   ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
---------------------------- */
async function refreshPreview(){
  const iframe = document.getElementById('preview');
  try {
    const htmlContent = await idbGet('files', '/index.html') || '';
    const parser = new DOMParser();
    const doc = parser.parseFromString(htmlContent, 'text/html');

    // ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆã‚’ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–
    const links = [...doc.querySelectorAll('link[rel="stylesheet"][href]')];
    for (const link of links) {
      const href = link.getAttribute('href');
      const path = href.startsWith('/') ? href : '/' + href;
      const cssContent = await idbGet('files', path);
      if (cssContent) {
        const style = document.createElement('style');
        style.textContent = cssContent;
        link.parentNode.replaceChild(style, link);
      }
    }

    // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–
    const scripts = [...doc.querySelectorAll('script[src]')];
    for (const script of scripts) {
      const src = script.getAttribute('src');
      const path = src.startsWith('/') ? src : '/' + src;
      const jsContent = await idbGet('files', path);
      if (jsContent) {
        const newScript = document.createElement('script');
        newScript.textContent = `try { ${jsContent} } catch(e) { console.error(e); }`;
        script.parentNode.replaceChild(newScript, script);
      }
    }

    const finalHtml = `<!DOCTYPE html>${doc.documentElement.outerHTML}`;
    iframe.srcdoc = finalHtml;
  } catch (err) {
    iframe.srcdoc = `<html><body>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: ${err.message}</body></html>`;
    console.error(err);
  }
}

/* ---------------------------
   WebContainer (Node) èµ·å‹•
---------------------------- */
let webcontainer, wcApiUrl = 'https://unpkg.com/@webcontainer/api/dist/index.js';
async function bootWebContainer(){
  try{
    const mod = await import(/* @vite-ignore */ wcApiUrl);
    const { WebContainer } = mod;
    webcontainer = await WebContainer.boot();
    setStatusNode('æº–å‚™å®Œäº†','ok');
    await setupTerminal();
  }catch(e){
    setStatusNode('å¤±æ•—','err'); out('Node/WebContainerã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚','err'); console.error(e);
  }
}
async function mountToWebContainer(){
  if(!webcontainer) return;
  const { keys, vals } = await idbAll('files');
  const tree = {};
  for(let i=0;i<keys.length;i++) setNested(tree, keys[i], vals[i]);
  await webcontainer.mount(tree);
}
function setNested(root, path, content){
  const parts = path.split('/').filter(Boolean); let node = root;
  for(let i=0;i<parts.length-1;i++){ const p=parts[i]; node[p]=node[p]||{}; node=node[p]; }
  node[parts.at(-1)] = { file: { contents: content } };
}
async function wcSpawn(cmd,args,onData){
  const proc = await webcontainer.spawn(cmd,args);
  proc.output.pipeTo(new WritableStream({ write(d){ onData && onData(d); } }));
  const exitCode = await proc.exit; return exitCode;
}

/* ---------------------------
   Cãƒ—ãƒ©ã‚°ã‚¤ãƒ³è‡ªå‹•ãƒ­ãƒ¼ãƒ€ãƒ¼ (CDN)
   - è©¦è¡Œé †ã«å€™è£œURLã‚’ãƒ­ãƒ¼ãƒ‰
   - æˆåŠŸæ™‚ã« window.compileC ãŒæä¾›ã•ã‚Œã‚‹ã“ã¨ã‚’æœŸå¾…
---------------------------- */
// This feature has been removed.

/* ---------------------------
   Collaboration
---------------------------- */
const collaborationManager = {
    provider: null,
    doc: null,
    binding: null,
    isHost: false,

    async startSession() {
        this.isHost = true;
        out('å…±åŒç·¨é›†ã‚µãƒ¼ãƒãƒ¼ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­...', 'ok');

        // Write server files from template
        const template = PROJECT_TEMPLATES['collaboration-server'];
        for (const path in template.files) {
            await pfs.writeFile(path, template.files[path]);
        }
        out('ã‚µãƒ¼ãƒãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã«æ›¸ãè¾¼ã¿ã¾ã—ãŸã€‚', 'ok');

        const installProcess = await webcontainer.spawn('npm', ['install']);
        out('ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­...');
        await installProcess.exit;
        out('ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†ã€‚');

        const serverProcess = await webcontainer.spawn('npm', ['start']);

        webcontainer.on('server-ready', (port, url) => {
            if (port === 1234) {
                out('å…±åŒç·¨é›†ã‚µãƒ¼ãƒãƒ¼ã®æº–å‚™ãŒã§ãã¾ã—ãŸã€‚', 'ok');

                const wsProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
                const serverHostname = new URL(url).hostname;
                const websocketUrl = `${wsProtocol}${serverHostname}`;
                const shareUrl = `${window.location.href.split('?')[0]}?room=${websocketUrl}`;

                prompt("ã“ã®URLã‚’å…±åŒç·¨é›†è€…ã«å…±æœ‰ã—ã¦ãã ã•ã„:", shareUrl);
                this.connect(websocketUrl, 'Host');
            }
        });
    },

    connect(serverUrl, roomName) {
        if (this.provider) {
            this.provider.disconnect();
        }

        this.doc = new Y.Doc();
        // For now, we only sync the current file. A real implementation would manage multiple Y.Text objects.
        const ytext = this.doc.getText('monaco');

        this.provider = new window.WebsocketProvider(serverUrl, roomName, this.doc);
        this.provider.awareness.setLocalStateField('user', {
            name: 'User-' + Math.random().toString(36).substring(2, 6),
            color: '#' + Math.floor(Math.random()*16777215).toString(16)
        });

        this.binding = new window.MonacoBinding(ytext, editor.getModel(), this.provider.awareness);
        out('å…±åŒç·¨é›†ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«æ¥ç¶šã—ã¾ã—ãŸã€‚', 'ok');
    },

    init() {
        const urlParams = new URLSearchParams(window.location.search);
        const roomUrl = urlParams.get('room');
        if (roomUrl) {
            // This user is joining a session, not hosting.
            this.isHost = false;
            // Wait for webcontainer to be ready before connecting
            const check = setInterval(() => {
                if (webcontainer && editor) {
                    clearInterval(check);
                    this.connect(roomUrl, 'Guest');
                }
            }, 100);
        }
    }
};

/* ---------------------------
   GitHub Integration
---------------------------- */
const githubManager = {
    client: null,
    token: null,

    getHttpPlugin() {
        return {
            async request({ url, method, headers, body }) {
                const authHeaders = new Headers(headers);
                if (githubManager.token) {
                    authHeaders.set('Authorization', `Bearer ${githubManager.token.access_token}`);
                }
                const res = await fetch(url, { method, headers: authHeaders, body });
                return {
                    url: res.url,
                    method: res.method,
                    statusCode: res.status,
                    statusMessage: res.statusText,
                    body: res.body,
                    headers: Object.fromEntries(res.headers.entries()),
                };
            },
        };
    },

    async createRepo() {
        if (!this.token) {
            alert("GitHubã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
            return;
        }
        const repoName = prompt("æ–°ã—ã„ãƒªãƒã‚¸ãƒˆãƒªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:");
        if (!repoName) return;

        out(`GitHubä¸Šã§ãƒªãƒã‚¸ãƒˆãƒªã€Œ${repoName}ã€ã‚’ä½œæˆä¸­...`, 'ok');
        try {
            // 1. Create repo on GitHub
            const createResponse = await fetch('https://api.github.com/user/repos', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${this.token.access_token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name: repoName, private: false }),
            });

            if (!createResponse.ok) {
                const errData = await createResponse.json();
                throw new Error(`ãƒªãƒã‚¸ãƒˆãƒªã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${errData.message}`);
            }
            const repoData = await createResponse.json();
            out('ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆã—ã¾ã—ãŸã€‚', 'ok');

            // 2. If not a git repo, init
            const gitignoreExists = await pfs.stat('/.git/config').catch(() => false);
            if (!gitignoreExists) {
                await git.init({ fs, dir: '/' });
                out('ãƒ­ãƒ¼ã‚«ãƒ«ãƒªãƒã‚¸ãƒˆãƒªã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸã€‚', 'ok');
            }

            // 3. Add all files and commit
            out('æœ€åˆã®ã‚³ãƒŸãƒƒãƒˆã‚’ä½œæˆä¸­...', 'ok');
            const statusRows = await git.statusMatrix({ fs, dir: '/' });
            for (const row of statusRows) {
                await git.add({ fs, dir: '/', filepath: row[0] });
            }
            await git.commit({ fs, dir: '/', message: 'Initial commit', author: { name: 'WebCloud IDE' } });

            // 4. Add remote and push
            out('GitHubã«ãƒ—ãƒƒã‚·ãƒ¥ä¸­...', 'ok');
            await git.addRemote({ fs, dir: '/', remote: 'origin', url: repoData.clone_url });
            const pushResult = await git.push({
                fs,
                http: this.getHttpPlugin(),
                dir: '/',
                remote: 'origin',
                ref: 'main',
                force: true, // Force push for initial commit
            });

            if (pushResult.ok) {
                out('æœ€åˆã®ã‚³ãƒŸãƒƒãƒˆã‚’GitHubã«ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸã€‚', 'ok');
            } else {
                out(`ãƒ—ãƒƒã‚·ãƒ¥ã«å¤±æ•—ã—ã¾ã—ãŸ: ${pushResult.error}`, 'err');
            }

        } catch (e) {
            out(`ãƒªãƒã‚¸ãƒˆãƒªä½œæˆãƒ—ãƒ­ã‚»ã‚¹ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}`, 'err');
            console.error(e);
        }
    },

    async pushRepo() {
        if (!this.token) {
            alert("GitHubã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
            return;
        }
        out('GitHubã«ãƒ—ãƒƒã‚·ãƒ¥ä¸­...', 'ok');
        try {
            const result = await git.push({
                fs,
                http: this.getHttpPlugin(),
                dir: '/',
                onAuth: () => ({ username: this.token.access_token }),
            });
            if (result.ok) {
                out('ãƒ—ãƒƒã‚·ãƒ¥ã«æˆåŠŸã—ã¾ã—ãŸã€‚', 'ok');
            } else {
                out(`ãƒ—ãƒƒã‚·ãƒ¥ã«å¤±æ•—ã—ã¾ã—ãŸ: ${result.error}`, 'err');
            }
        } catch (e) {
            out(`ãƒ—ãƒƒã‚·ãƒ¥ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'err');
            console.error(e);
        }
    },

    async cloneRepo() {
        if (!this.token) {
            alert("GitHubã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
            return;
        }
        const url = prompt("ã‚¯ãƒ­ãƒ¼ãƒ³ã™ã‚‹GitHubãƒªãƒã‚¸ãƒˆãƒªã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:", "https://github.com/user/repo.git");
        if (!url) return;

        // Confirm before wiping workspace
        const { keys } = await idbAll('files');
        if (keys.length > 0) {
            if (!confirm("ç¾åœ¨ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’æ¶ˆå»ã—ã¦ã€ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¾ã™ã‹ï¼Ÿæœªä¿å­˜ã®å¤‰æ›´ã¯å¤±ã‚ã‚Œã¾ã™ã€‚")) {
                return;
            }
        }

        out(`ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ä¸­: ${url}...`, 'ok');
        try {
            // Wipe existing filesystem
            const allFiles = await pfs.readdir('/');
            for (const file of allFiles) {
                if (file !== '.' && file !== '..') {
                    await pfs.rm(`/${file}`, { recursive: true });
                }
            }

            await git.clone({
                fs,
                http: this.getHttpPlugin(),
                dir: '/',
                url: url,
                corsProxy: 'https://cors.isomorphic-git.org',
                singleBranch: true,
                depth: 10
            });
            out('ã‚¯ãƒ­ãƒ¼ãƒ³ã«æˆåŠŸã—ã¾ã—ãŸã€‚', 'ok');
            currentFile = null; // Reset current file
            await refreshFileUI();
            await refreshGitStatus();
        } catch (e) {
            out(`ã‚¯ãƒ­ãƒ¼ãƒ³ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'err');
            console.error(e);
        }
    },

    async deploy() {
        out('ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ—ãƒ­ã‚»ã‚¹ã‚’é–‹å§‹ã—ã¾ã™...', 'ok');

        if (!this.token) {
            out('ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã«ã¯GitHubã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚', 'err');
            alert("ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã«ã¯GitHubã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
            return;
        }

        try {
            const remotes = await git.listRemotes({ fs, dir: '/' });
            if (!remotes.some(r => r.remote === 'origin')) {
                out('ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã®ãƒªãƒ¢ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã€Œoriginã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'err');
                alert("ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã®ãƒªãƒ¢ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã€Œoriginã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã€ŒNew Repoã€ãƒœã‚¿ãƒ³ã§ä½œæˆã™ã‚‹ã‹ã€æ‰‹å‹•ã§è¨­å®šã—ã¦ãã ã•ã„ã€‚");
                return;
            }
        } catch (e) {
            out(`ãƒªãƒ¢ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã®ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}`, 'err');
            return;
        }

        try {
            out('å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ä¸­...', 'ok');
            const rows = await git.statusMatrix({ fs, dir });
            const changedFiles = rows.filter(row => row[1] !== row[2] || row[2] !== row[3]);

            if (changedFiles.length === 0) {
                out('ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã‚³ãƒŸãƒƒãƒˆæ¸ˆã¿ã®å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ç¾åœ¨ã®ãƒ˜ãƒƒãƒ‰ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã™ã€‚', 'warn');
            } else {
                for (const row of rows) {
                    const [filepath, head, workdir] = row;
                    if (workdir === 3) {
                        await git.remove({ fs, dir, filepath });
                    } else {
                        await git.add({ fs, dir, filepath });
                    }
                }
                out(`${changedFiles.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã—ã¾ã—ãŸã€‚`, 'ok');

                out('ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒŸãƒƒãƒˆã‚’ä½œæˆä¸­...', 'ok');
                const timestamp = new Date().toISOString();
                const commitMessage = `Deploy at ${timestamp}`;
                const sha = await git.commit({
                    fs,
                    dir,
                    message: commitMessage,
                    author: { name: 'WebCloud IDE Deploy' }
                });
                out(`ã‚³ãƒŸãƒƒãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ: ${sha.substring(0, 7)}`, 'ok');
            }

            const branch = await git.currentBranch({ fs, dir, fullname: false });
            out(`ã€Œ${branch}ã€ãƒ–ãƒ©ãƒ³ãƒã‚’originã«ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ã„ã¾ã™...`, 'ok');
            const pushResult = await git.push({
                fs,
                http: this.getHttpPlugin(),
                dir: '/',
                remote: 'origin',
                ref: branch,
                onAuth: () => ({ username: this.token.access_token }),
            });

            if (pushResult.ok) {
                out('âœ… ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸï¼å¤‰æ›´ãŒGitHubã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã¾ã—ãŸã€‚', 'ok');
                out('ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆNetlifyã€Vercelãªã©ï¼‰ã§ãƒ“ãƒ«ãƒ‰ãŒé–‹å§‹ã•ã‚Œã¾ã™ã€‚', 'ok');
            } else {
                throw new Error(`ãƒ—ãƒƒã‚·ãƒ¥ã«å¤±æ•—ã—ã¾ã—ãŸ: ${pushResult.error}`);
            }
        } catch (e) {
            out(`ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ—ãƒ­ã‚»ã‚¹ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}`, 'err');
            console.error(e);
        }
    },

    async init(clientId) {
        if (!clientId) {
            console.warn("GitHub Client ID not set.");
            return;
        }
        this.client = new window.OAuth2AuthCodePkceClient({
            authorizationUrl: 'https://github.com/login/oauth/authorize',
            tokenUrl: 'https://github.com/login/oauth/access_token',
            clientId: clientId,
            redirectUrl: window.location.href.split('?')[0], // Use current URL as redirect URI
            scopes: ['repo', 'user:read'],
            onAccessTokenExpiry: async (token) => token, // No refresh token support needed for now
            onInvalidGrant: (err) => console.error("OAuth invalid grant:", err),
        });

        if (window.location.search.includes('code=')) {
            try {
                const token = await this.client.getTokens();
                await this.setToken(token);
                // Clean the URL
                window.history.replaceState({}, document.title, window.location.pathname);
                this.updateUiForLogin();
            } catch (err) {
                console.error("Error getting GitHub token:", err);
            }
        } else {
            const storedToken = await idbGet('settings', SKEYS.githubToken);
            if (storedToken) {
                this.token = storedToken;
                this.updateUiForLogin();
            }
        }
    },

    async login() {
        if (!this.client) {
            alert("GitHub Client IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚è¨­å®šç”»é¢ã‹ã‚‰å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            return;
        }
        await this.client.requestAuthorizationCode();
    },

    async logout() {
        await idbDel('settings', SKEYS.githubToken);
        this.token = null;
        this.client = null; // Re-init needed
        this.updateUiForLogout();
    },

    async setToken(token) {
        this.token = token;
        await idbSet('settings', SKEYS.githubToken, token);
    },

    async updateUiForLogin() {
        document.getElementById('btn-github-login').style.display = 'none';
        document.getElementById('btn-github-logout').style.display = 'inline-block';
        const userSpan = document.getElementById('github-user');

        try {
            const response = await fetch('https://api.github.com/user', {
                headers: { 'Authorization': `Bearer ${this.token.access_token}` }
            });
            const data = await response.json();
            userSpan.textContent = `Welcome, ${data.login}`;
            userSpan.style.display = 'inline-block';
        } catch (e) {
            console.error("Failed to fetch GitHub user", e);
            userSpan.textContent = 'Logged In';
            userSpan.style.display = 'inline-block';
        }
    },

    updateUiForLogout() {
        document.getElementById('btn-github-login').style.display = 'inline-block';
        document.getElementById('btn-github-logout').style.display = 'none';
        document.getElementById('github-user').style.display = 'none';
    }
};


/* ---------------------------
   è¨­å®š
---------------------------- */
const SKEYS = { project:'project-name', wc:'wc-url', monaco:'monaco-cdn', autosave:'autosave', userId: 'user-id', theme: 'theme', aiModel: 'ai_model', githubClientId: 'github_client_id', githubToken: 'github_token' };

let currentTheme = 'dark';

async function toggleTheme() {
  currentTheme = document.body.classList.contains('light-theme') ? 'dark' : 'light';

  if (currentTheme === 'light') {
    document.body.classList.add('light-theme');
    monaco.editor.setTheme('vs');
  } else {
    document.body.classList.remove('light-theme');
    monaco.editor.setTheme('vs-dark');
  }

  await idbSet('settings', SKEYS.theme, currentTheme);
  logLine(`ãƒ†ãƒ¼ãƒã‚’ã€Œ${currentTheme}ã€ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸã€‚`, 'ok');
}

async function getOrSetUserId() {
  let userId = await idbGet('settings', SKEYS.userId);
  if (!userId) {
    userId = Math.random().toString(36).substring(2, 10);
    await idbSet('settings', SKEYS.userId, userId);
    logLine(`ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ–°è¦åŒ¿åIDã‚’ç”Ÿæˆã—ã¾ã—ãŸ: ${userId}`, 'ok');
  }
  return userId;
}

async function loadSettings(){
  const proj = (await idbGet('settings',SKEYS.project)) || 'my-webcloud-app';
  const wc = (await idbGet('settings',SKEYS.wc)) || wcApiUrl;
  const mon = (await idbGet('settings',SKEYS.monaco)) || 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js';
  const autosave = (await idbGet('settings',SKEYS.autosave)) || false;
  const theme = (await idbGet('settings', SKEYS.theme)) || 'dark';
  const githubClientId = (await idbGet('settings', SKEYS.githubClientId)) || '';


  document.getElementById('set-project').value = proj;
  document.getElementById('set-wc').value = wc;
  document.getElementById('set-monaco').value = mon;
  document.getElementById('set-autosave').checked = !!autosave;
  document.getElementById('set-github-client-id').value = githubClientId;
  wcApiUrl = wc;

  if (theme === 'light') {
    // We need to toggle it from the default 'dark' state
    // but need to wait for the editor to be ready.
    // The call is now in the boot sequence.
    currentTheme = 'dark'; // Will be toggled to light
  }
}
async function saveSettings(){
  await idbSet('settings',SKEYS.project, document.getElementById('set-project').value.trim());
  await idbSet('settings',SKEYS.wc, document.getElementById('set-wc').value.trim());
  await idbSet('settings',SKEYS.monaco, document.getElementById('set-monaco').value.trim());
  await idbSet('settings',SKEYS.autosave, document.getElementById('set-autosave').checked);
  const githubClientId = document.getElementById('set-github-client-id').value.trim();
  await idbSet('settings', SKEYS.githubClientId, githubClientId);

  showModal(false); out('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚','ok');
  // å¤‰æ›´ã‚’åæ˜ : URLãŒæ›´æ–°ã•ã‚ŒãŸã‚‰Cãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’å†èª­ã¿è¾¼ã¿
  setStatusC('èª­è¾¼ä¸­â€¦','warn'); window.compileC = undefined; cReady=false; loadCPluginAuto();
  // Re-init github manager with new client ID
  githubManager.init(githubClientId);
}
async function factoryReset(){ const req=indexedDB.deleteDatabase(DB_NAME); req.onsuccess=()=>location.reload(); req.onerror=()=>alert('ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); }

/* ---------------------------
   ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
---------------------------- */
async function setupTerminal() {
  const term = new Terminal({
    cursorBlink: true,
    fontFamily: 'ui-monospace, Menlo, Consolas, monospace',
    fontSize: 14,
  });
  term.open(termEl);

  await mountToWebContainer();
  const shellProcess = await webcontainer.spawn('jsh', {
    terminal: {
      cols: term.cols,
      rows: term.rows,
    },
  });

  shellProcess.output.pipeTo(
    new WritableStream({
      write(data) {
        term.write(data);
      },
    })
  );

  const input = shellProcess.input.getWriter();
  term.onData((data) => {
    input.write(data);
  });

  term.onResize((size) => {
    shellProcess.resize({
      cols: size.cols,
      rows: size.rows,
    });
  });

  out('ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ãŒæº–å‚™ã§ãã¾ã—ãŸã€‚', 'ok');
}


/* ---------------------------
   AI Panel Logic
---------------------------- */
const availableModels = [
    { model_id: "expert-mode", name: "ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ (Llama 3)", size: "é«˜å“è³ª" },
    { model_id: "Llama-3-8B-Instruct-q4f32_1-MLC", name: "Llama 3 8B (Meta)", size: "4.7GB" },
    { model_id: "gemma-2b-it-q4f32_1-MLC", name: "Gemma 2B (Google)", size: "2.7GB" },
    { model_id: "Phi-3-mini-4k-instruct-q4f32_1-MLC", name: "Phi-3 Mini (Microsoft)", size: "2.3GB" },
    { model_id: "Mistral-7B-Instruct-v0.2-q4f32_1-MLC", name: "Mistral 7B (Mistral AI)", size: "4.4GB" },
    { model_id: "CodeLlama-7b-Instruct-hf-q4f32_1-MLC", name: "CodeLlama 7B (Meta)", size: "4.0GB" },
    { model_id: "WizardCoder-Python-7B-V1.0-q4f16_1-MLC", name: "WizardCoder Python 7B", size: "3.8GB" },
    { model_id: "RedPajama-INCITE-Chat-3B-v1-q4f32_1-MLC", name: "RedPajama 3B (Together)", size: "1.8GB" },
    { model_id: "TinyLlama-1.1B-Chat-v1.0-q4f32_1-MLC", name: "TinyLlama 1.1B (Independent)", size: "0.7GB" }
];

const aiManager = {
    chat: null,
    currentModelId: null,

    async loadModel(modelId) {
        this.addBotMessage("AIãƒ¢ãƒ‡ãƒ«ã‚’åˆæœŸåŒ–ä¸­...");
        try {
            if (this.chat) {
                await this.chat.unload();
            }
            this.currentModelId = modelId;
            const selectedModel = availableModels.find(m => m.model_id === modelId);

            this.chat = await webllm.CreateChatModule({
                progress_callback: (report) => {
                    const progressText = `ãƒ¢ãƒ‡ãƒ«èª­è¾¼ä¸­: ${report.text}`;
                    this.updateBotMessage(progressText);
                }
            });

            await this.chat.reload(modelId);
            this.updateBotMessage(`ãƒ¢ãƒ‡ãƒ«ã€Œ${selectedModel.name}ã€ã®æº–å‚™ãŒã§ãã¾ã—ãŸã€‚`);
            await idbSet('settings', 'ai_model', modelId);
        } catch(e) {
            this.updateBotMessage(`ãƒ¢ãƒ‡ãƒ«ã€Œ${modelId}ã€ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}`);
            this.chat = null;
        }
    },

    async generateReply(prompt) {
        const selectedMode = document.getElementById('ai-model-selector-panel').value;
        const expertModelId = "Llama-3-8B-Instruct-q4f32_1-MLC";

        if (selectedMode === 'expert-mode') {
            if (this.currentModelId !== expertModelId) {
                this.addBotMessage("ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ã®ãŸã‚ã€Llama 3ãƒ¢ãƒ‡ãƒ«ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™...");
                await this.loadModel(expertModelId);
            }
            // Now that the correct model is loaded, construct the expert prompt
            const expertPrompt = `ã‚ãªãŸã¯ä¸–ç•Œã‚¯ãƒ©ã‚¹ã®å°‚é–€å®¶ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¯¾ã—ã¦ã€å¤šè§’çš„ãªè¦–ç‚¹ã‹ã‚‰æ®µéšçš„ã«è€ƒãˆã€æœ€çµ‚çš„ã«æœ€ã‚‚è³ªã®é«˜ã„ã€åŒ…æ‹¬çš„ãªå›ç­”ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
${prompt}

### ã‚ãªãŸã®æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ï¼ˆã‚¹ãƒ†ãƒƒãƒ—ãƒ»ãƒã‚¤ãƒ»ã‚¹ãƒ†ãƒƒãƒ—ï¼‰
1.  ã¾ãšã€ã“ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æ ¸å¿ƒã¨ãªã‚‹ç›®çš„ã‚’ç‰¹å®šã™ã‚‹ã€‚
2.  æ¬¡ã«ã€è€ƒãˆã‚‰ã‚Œã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚„å›ç­”ã®é¸æŠè‚¢ã‚’è¤‡æ•°æŒ™ã’ã‚‹ã€‚
3.  ãã‚Œãã‚Œã®é¸æŠè‚¢ã®é•·æ‰€ã¨çŸ­æ‰€ã‚’æ¯”è¼ƒæ¤œè¨ã™ã‚‹ã€‚
4.  æœ€çµ‚çš„ã«ã€ã™ã¹ã¦ã®æƒ…å ±ã‚’çµ±åˆã—ã€åˆå¿ƒè€…ã«ã‚‚ç†è§£ã§ãã‚‹ã‚ˆã†ã€ä¸å¯§ã‹ã¤è©³ç´°ãªæœ€çµ‚å›ç­”ã‚’ä½œæˆã™ã‚‹ã€‚

ã§ã¯ã€æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã«å¾“ã£ã¦ã€æœ€é«˜ã®å›ç­”ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚`;

            this.addUserMessage(prompt);
            this.addBotMessage("ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ã§æ€è€ƒä¸­...");
            try {
                const reply = await this.chat.generate(expertPrompt);
                this.updateBotMessage(reply);
            } catch (e) {
                this.updateBotMessage(`AIã®å¿œç­”ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}`);
            }

        } else {
            // Standard mode
            if (!this.chat) {
                this.addBotMessage("ã‚¨ãƒ©ãƒ¼: AIãƒ¢ãƒ‡ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚è¨­å®šã‹ã‚‰ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            this.addUserMessage(prompt);
            this.addBotMessage("æ€è€ƒä¸­...");

            try {
                const reply = await this.chat.generate(prompt);
                this.updateBotMessage(reply);
            } catch(e) {
                this.updateBotMessage(`AIã®å¿œç­”ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}`);
            }
        }
    },

    addBotMessage(text) {
        const body = document.getElementById('ai-panel-body');
        const bubble = document.createElement('div');
        bubble.className = 'ai-chat-bubble bot';
        bubble.textContent = text;
        body.appendChild(bubble);
        body.scrollTop = body.scrollHeight;
    },

    updateBotMessage(text) {
        const body = document.getElementById('ai-panel-body');
        const lastBubble = body.querySelector('.ai-chat-bubble.bot:last-child');
        if (lastBubble) {
            lastBubble.textContent = text;
        }
    },

    addUserMessage(text) {
        const body = document.getElementById('ai-panel-body');
        const bubble = document.createElement('div');
        bubble.className = 'ai-chat-bubble user';
        bubble.textContent = text;
        body.appendChild(bubble);
        body.scrollTop = body.scrollHeight;
    }
};

function populateModelSelectors() {
    const selectorPanel = document.getElementById('ai-model-selector-panel');
    const selectorSettings = document.getElementById('ai-model-selector-settings');

    [selectorPanel, selectorSettings].forEach(selector => {
        selector.innerHTML = '';
        availableModels.forEach(model => {
            const option = document.createElement('option');
            option.value = model.model_id;
            option.textContent = `${model.name} (${model.size})`;
            selector.appendChild(option);
        });
    });
}

async function syncAndLoadModel(event) {
    const selectedModelId = event.target.value;
    const selectorPanel = document.getElementById('ai-model-selector-panel');
    const selectorSettings = document.getElementById('ai-model-selector-settings');

    selectorPanel.value = selectedModelId;
    selectorSettings.value = selectedModelId;

    await idbSet('settings', SKEYS.aiModel, selectedModelId);

    if (selectedModelId !== 'expert-mode') {
        aiManager.loadModel(selectedModelId);
    } else {
        aiManager.addBotMessage("ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ãŒé¸æŠã•ã‚Œã¾ã—ãŸã€‚æœ€é«˜ã®å›ç­”ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã€Llama 3 ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚");
    }
}

function makeDraggable(panel, header) {
  let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
  header.onmousedown = dragMouseDown;

  function dragMouseDown(e) {
    e = e || window.event;
    e.preventDefault();
    // get the mouse cursor position at startup:
    pos3 = e.clientX;
    pos4 = e.clientY;
    document.onmouseup = closeDragElement;
    // call a function whenever the cursor moves:
    document.onmousemove = elementDrag;
  }

  function elementDrag(e) {
    e = e || window.event;
    e.preventDefault();
    // calculate the new cursor position:
    pos1 = pos3 - e.clientX;
    pos2 = pos4 - e.clientY;
    pos3 = e.clientX;
    pos4 = e.clientY;
    // set the element's new position:
    panel.style.top = (panel.offsetTop - pos2) + "px";
    panel.style.left = (panel.offsetLeft - pos1) + "px";
  }

  function closeDragElement() {
    // stop moving when mouse button is released:
    document.onmouseup = null;
    document.onmousemove = null;
  }
}

/* ---------------------------
   ãƒœã‚¿ãƒ³ã®æ¥ç¶š
---------------------------- */
btnRun.onclick = ()=>refreshPreview(); // `run` is now preview
btnPreview.onclick = ()=>refreshPreview();
btnSave.onclick = ()=>saveCurrent().then(()=>out('ä¿å­˜ã—ã¾ã—ãŸã€‚','ok'));

btnUpload.onclick = () => fileUploadInput.click();
fileUploadInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = async (event) => {
    try {
      const content = event.target.result;
      const path = '/' + file.name;
      await idbSet('files', path, content);
      await refreshFileUI();
      await openFile(path);
      out(`${file.name} ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ`, 'ok');
      await refreshGitStatus();
    } catch (err) {
      out(`ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ${err.message}`, 'err');
      console.error(err);
    }
  };
  reader.onerror = (err) => {
    out(`ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${err.message}`, 'err');
    console.error(err);
  };
  reader.readAsText(file);

  // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†åº¦é¸æŠã—ã¦ã‚‚ 'change' ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã™ã‚‹ã‚ˆã†ã«ã€å…¥åŠ›å€¤ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹
  e.target.value = '';
});

btnDownload.onclick = () => {
  if (!currentFile) {
    out('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒé–‹ã‹ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'warn');
    return;
  }

  try {
    const content = editor.getValue();
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');

    a.href = url;
    a.download = currentFile.startsWith('/') ? currentFile.substring(1) : currentFile;

    document.body.appendChild(a);
    a.click();

    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      out(`${a.download} ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ`, 'ok');
    }, 0);
  } catch (err) {
    out(`ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ${err.message}`, 'err');
    console.error(err);
  }
};

btnRefresh.onclick = ()=>refreshPreview();
btnLogClear.onclick = ()=>{ logEl.innerHTML=''; };
btnSettings.onclick = ()=>{ loadSettings().then(()=>showModal(true)); };
document.getElementById('btn-save-settings').onclick = saveSettings;
document.getElementById('btn-reset-all').onclick = ()=>{ if(confirm('å·¥å ´å‡ºè·æ™‚ã®è¨­å®šã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) factoryReset(); };
document.getElementById('btn-toggle-theme').onclick = toggleTheme;
document.getElementById('btn-github-login').onclick = () => githubManager.login();
document.getElementById('btn-github-logout').onclick = () => githubManager.logout();
document.getElementById('btn-github-clone').onclick = () => githubManager.cloneRepo();
document.getElementById('btn-github-new').onclick = () => githubManager.createRepo();
document.getElementById('btn-collaboration').onclick = () => collaborationManager.startSession();
document.getElementById('btn-export-zip').onclick = exportProjectAsZip;
btnNewProject.onclick = () => {
    populateTemplateModal();
    modalNewProject.style.display = 'grid';
};
btnWorkspaces.onclick = () => {
    workspaceManager.populateModal();
    modalWorkspaces.style.display = 'grid';
};
document.getElementById('btn-save-workspace').onclick = () => {
    const name = document.getElementById('new-workspace-name').value;
    workspaceManager.save(name);
    document.getElementById('new-workspace-name').value = '';
};
document.getElementById('load-plugin-input').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (event) => loadPlugin(event.target.result);
    reader.readAsText(file);
    e.target.value = ''; // Reset for next time
});
document.getElementById('ai-model-selector-panel').onchange = syncAndLoadModel;
document.getElementById('ai-model-selector-settings').onchange = syncAndLoadModel;

function sendAiPrompt() {
    const promptInput = document.getElementById('ai-prompt-input');
    const prompt = promptInput.value.trim();
    if (prompt) {
        aiManager.generateReply(prompt);
        promptInput.value = '';
    }
}

document.getElementById('ai-send-prompt-btn').onclick = sendAiPrompt;

document.getElementById('ai-gen-command-btn').onclick = () => {
    const promptInput = document.getElementById('ai-prompt-input');
    const prompt = promptInput.value.trim();
    if (prompt) {
        const commandPrompt = `ã‚ãªãŸã¯Linuxã‚·ã‚§ãƒ«ã‚³ãƒãƒ³ãƒ‰ã®å°‚é–€å®¶ã§ã™ã€‚ä»¥ä¸‹ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã€å®Ÿè¡Œå¯èƒ½ãªå˜ä¸€ã®ã‚·ã‚§ãƒ«ã‚³ãƒãƒ³ãƒ‰ã«å¤‰æ›ã—ã¦ãã ã•ã„ã€‚ã‚³ãƒãƒ³ãƒ‰ã®ã¿ã‚’è¿”ã—ã€èª¬æ˜ã¯ä¸è¦ã§ã™ã€‚\n\nãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼š ${prompt}`;
        aiManager.generateReply(commandPrompt);
        promptInput.value = '';
    }
};

document.getElementById('ai-prompt-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendAiPrompt();
    }
});


btnAiPanel.onclick = () => {
  aiPanel.style.display = aiPanel.style.display === 'flex' ? 'none' : 'flex';
};
makeDraggable(aiPanel, aiPanelHeader);


let vm_started = false;

async function createVmFilesystem() {
  const allFiles = await idbAll('files');
  const fsJson = {
    "fsroot": []
  };

  if (allFiles.keys && allFiles.vals) {
    for (let i = 0; i < allFiles.keys.length; i++) {
      const path = allFiles.keys[i];
      const content = allFiles.vals[i];

      if (path.startsWith('/')) {
        const blob = new Blob([content]);
        const url = URL.createObjectURL(blob);
        fsJson.fsroot.push({
          "name": path.substring(1),
          "type": "file",
          "url": url,
          "size": blob.size,
        });
      }
    }
  }

  const fsJsonBlob = new Blob([JSON.stringify(fsJson)], { type: 'application/json' });

  return {
    basefs: fsJsonBlob,
    baseurl: '', // çµ¶å¯¾çš„ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆURLã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€baseurlã¯ç©ºã«ã§ãã‚‹
  };
}

async function startVM() {
  if (vm_started) return;
  vm_started = true;
  out("Linux VMã‚’èµ·å‹•ä¸­... ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚", "ok");

  const fs_adapter = await createVmFilesystem();

  const emulator = new V86({
    wasm_path: "https://cdn.jsdelivr.net/npm/v86/build/v86.wasm",
    memory_size: 64 * 1024 * 1024, // å®‰å®šæ€§ã®ãŸã‚ã«ãƒ¡ãƒ¢ãƒªã‚’å¢—åŠ 
    vga_memory_size: 8 * 1024 * 1024,
    screen_container: document.getElementById("screen_container"),
    bios: { url: "https://cdn.jsdelivr.net/npm/v86/bios/seabios.bin" },
    vga_bios: { url: "https://cdn.jsdelivr.net/npm/v86/bios/vgabios.bin" },
    cdrom: { url: "https://i.copy.sh/linux.iso" },
    filesystem: fs_adapter,
    autostart: true,
  });

  let serial_data = "";
  let mount_command_sent = false;
  const PROMPT = "~% ";

  emulator.add_listener("serial0-output-byte", function(byte) {
    const char = String.fromCharCode(byte);
    if (char === "\r") {
      return;
    }
    serial_data += char;

    if (!mount_command_sent && serial_data.endsWith(PROMPT)) {
      mount_command_sent = true;
      const mount_command = "mount -t 9p host9p /mnt/9p\n";
      emulator.serial0_send(mount_command);
      out("å…±æœ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚’ /mnt/9p ã«è‡ªå‹•ãƒã‚¦ãƒ³ãƒˆã—ã¾ã™...", "ok");
    }
  });
}
btnVm.onclick = () => {
  modalVm.style.display = 'grid';
  startVM();
};
btnVmClose.onclick = () => {
  modalVm.style.display = 'none';
};

document.getElementById('git-commit-button').onclick = performCommit;
document.getElementById('git-push-button').onclick = () => githubManager.pushRepo();
document.getElementById('git-graph-refresh-btn').onclick = renderGitGraph;
document.getElementById('btn-deploy').onclick = () => githubManager.deploy();

/* ---------------------------
   Plugin System
---------------------------- */
const webcloud = {
    plugins: {
        _plugins: {},
        register(plugin) {
            if (this._plugins[plugin.name]) {
                console.warn(`Plugin "${plugin.name}" is already registered.`);
                return;
            }
            console.log(`Registering plugin: ${plugin.name} v${plugin.version}`);
            this._plugins[plugin.name] = plugin;

            const ctx = {
                addButton: (label, onclick) => {
                    const btn = document.createElement('button');
                    btn.className = 'pill';
                    btn.textContent = label;
                    btn.onclick = onclick;
                    document.querySelector('.controls').appendChild(btn);
                },
                registerCommand: (name, handler) => {
                    // This requires re-introducing a command runner.
                    // For now, this is a placeholder.
                    console.log(`Plugin registered command: ${name}`);
                },
                out: out,
                pfs: pfs
            };

            try {
                plugin.init(ctx);
            } catch (e) {
                console.error(`Error initializing plugin "${plugin.name}":`, e);
            }
        }
    }
};

function loadPlugin(fileContent) {
    try {
        const script = document.createElement('script');
        script.textContent = fileContent;
        document.body.appendChild(script);
        document.body.removeChild(script); // Clean up the script tag
    } catch(e) {
        out(`ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}`, 'err');
    }
}


/* ---------------------------
   èµ·å‹•å‡¦ç†
---------------------------- */
const userCmds = {};
(async function boot(){
  try {
    await openDB();
    await getOrSetUserId();
    await loadSettings();
    const clientId = await idbGet('settings', SKEYS.githubClientId);
    await githubManager.init(clientId);
    collaborationManager.init();
    setupMonaco();
    populateModelSelectors();
    renderFileTree();
    initGit().then(renderGitGraph);
    out('WebCloudã®æº–å‚™ãŒã§ãã¾ã—ãŸã€‚ã€Œhelpã€ã¨å…¥åŠ›ã—ã¦é–‹å§‹ã—ã¾ã™ã€‚','ok');

    // Load last used AI model
    const lastModel = await idbGet('settings', SKEYS.aiModel);
    if (lastModel) {
        document.getElementById('ai-model-selector-panel').value = lastModel;
        document.getElementById('ai-model-selector-settings').value = lastModel;
        aiManager.loadModel(lastModel);
    }


    // load user cmds
    const all = await idbAll('cmds'); if(all.keys) for(let i=0;i<all.keys.length;i++){ try{ userCmds[all.keys[i]] = eval(all.vals[i]); }catch(e){} }

    // Node
    bootWebContainer();

  } catch (e) {
    out('èµ·å‹•ä¸­ã«è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚è¨­å®šã‹ã‚‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹ã‹ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¦ã¿ã¦ãã ã•ã„ã€‚', 'err');
    console.error(e);
  }
})();
</script>
</body>
</html>
